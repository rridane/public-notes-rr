:author-url: https://github.com/rridane
:author: rridane
:source-highlighter: rouge
:hardbreaks:
:table-caption!:
:toc: left
:toclevels: 3
:numbered:

= OpenID Connect ‚Äì Cheatsheet

== Basics

OIDC apporte :

* üéØ Une **valeur de scope** standardis√©e : `openid`
‚Üí indispensable pour activer les fonctionnalit√©s d‚Äôauthentification OIDC
* üéüÔ∏è Un **nouveau type de token** : `id_token` (JWT sign√© contenant l‚Äôidentit√© de l‚Äôutilisateur)
* üåê Des **endpoints suppl√©mentaires** :
- `/.well-known/openid-configuration` (discovery dynamique)
- `/userinfo` (profil utilisateur √† jour)

OIDC **√©tend scope** avec des valeurs standardis√©es qui activent des fonctionnalit√©s OIDC.

[cols="1,3",options="header"]
|===
| Scope             | Description
| `openid`          | üîê Active le mode OpenID Connect ‚Üí d√©clenche la d√©livrance d‚Äôun `id_token`
| `profile`         | üìÑ Demande les claims de profil utilisateur (nom, pr√©nom, etc.)
| `email`           | Ô∏èDemande l‚Äôadresse email (`email`, `email_verified`)
| `address`         | Demande l'adresse postale
| `phone`           | Demande le num√©ro de t√©l√©phone + statut de v√©rification
| `offline_access`  | Demande un `refresh_token` pour renouveler les tokens sans interaction
|===

[IMPORTANT]
====
Si `openid` est **absent**, la requ√™te est trait√©e comme du **pur OAuth 2.0**
‚Üí Aucune fonction OIDC ne sera d√©clench√©e (pas de `id_token`, pas de `/userinfo`).
====

[cols="1,2,2",options="header"]
|===
| Champ            | D√©clench√© par         | Description

| `access_token`   | Tous les flux OAuth   | Jeton d‚Äôacc√®s √† l‚ÄôAPI (Bearer token)
| `expires_in`     | Tous les flux OAuth   | Dur√©e de vie de l‚Äô`access_token` (en secondes)
| `scope`          | Tous les flux OAuth   | Scopes r√©ellement accord√©s par l‚ÄôAS

| `id_token`       | `scope=openid`        | JWT sign√© contenant l‚Äôidentit√© de l‚Äôutilisateur
| `refresh_token`  | `scope=offline_access` + flux autoris√© | Jeton longue dur√©e permettant d‚Äôobtenir un nouvel `access_token`
|===

Scopes `profile`, `email`, `address`, `phone` : demander des informations sp√©cifiques sur l‚Äôutilisateur. Les claims apparaissent dans l'`id_token` ou via `/userinfo`.

[cols="1,2,3",options="header"]
|===
| Scope         | Claims possibles                 | Description

| `openid`      | `sub`                            | Identifiant unique de l‚Äôutilisateur (obligatoire)
|               | *(+ autres claims selon config)* | Certains serveurs ajoutent `email`, `name`, etc. par d√©faut dans `id_token`

| `profile`     | `name`                           | Nom complet
|               | `given_name`                     | Pr√©nom
|               | `family_name`                    | Nom de famille
|               | `middle_name`                    | Deuxi√®me pr√©nom
|               | `nickname`                       | Surnom
|               | `preferred_username`             | Identifiant court ou pseudo
|               | `profile`                        | URL du profil (ex : r√©seaux sociaux)
|               | `picture`                        | URL de la photo de profil
|               | `website`                        | URL personnelle
|               | `gender`                         | Sexe
|               | `birthdate`                      | Date de naissance (ISO 8601)
|               | `zoneinfo`                       | Fuseau horaire (ex : "Europe/Paris")
|               | `locale`                         | Langue pr√©f√©r√©e (ex : "fr-FR")
|               | `updated_at`                     | Date de derni√®re mise √† jour du profil (timestamp)

| `email`       | `email`                          | Adresse email
|               | `email_verified`                 | Bool√©en indiquant si l‚Äôemail a √©t√© v√©rifi√©

| `address`     | `address`                        | Objet JSON avec :
- `formatted`
- `street_address`
- `locality`
- `region`
- `postal_code`
- `country`

| `phone`       | `phone_number`                   | Num√©ro de t√©l√©phone
|               | `phone_number_verified`          | Bool√©en indiquant si le num√©ro a √©t√© v√©rifi√©
|===

Certains claims renseignent **le contexte de l‚Äôauthentification** de l‚Äôutilisateur. Utiles pour tracer la s√©curit√© du login, v√©rifier qu‚Äôune authentification forte a √©t√© utilis√©e, ou satisfaire √† des contraintes r√©glementaires (ex : authentification MFA, dur√©e de session‚Ä¶).

[source,json]
----
{
  "acr": "urn:mace:incommon:iap:silver",
  "amr": ["pwd", "mfa"],
  "auth_time": 1709999400
}
----

[cols="1,3",options="header"]
|===
| Claim        | Description

| `acr`        | *Authentication Context Class Reference* ‚Äì Niveau d‚Äôauthentification atteint (ex : `urn:mace:...:silver`)
| `amr`        | *Authentication Methods References* ‚Äì Liste des m√©thodes utilis√©es (`pwd`, `otp`, `mfa`, etc.)
| `auth_time`  | *Authentication Time* ‚Äì Timestamp (epoch) de l‚Äôheure d‚Äôauthentification initiale
|===

[NOTE]
====
Exemples possibles pour `amr` :
- `pwd` : mot de passe
- `otp` : mot de passe √† usage unique
- `mfa` : authentification multi-facteur
- `sms`, `email` : envoi de code
- `fido`, `webauthn` : cl√© physique (FIDO2/WebAuthn)
====

Ces claims **ne d√©pendent pas d‚Äôun scope** comme `profile` ou `email`.

- Ils sont disponibles uniquement si `scope=openid` est pr√©sent
- D√©pendent du fournisseur

[cols="1,3",options="header"]
|===
| Fournisseur OIDC | Support des claims `acr`, `amr`, `auth_time`

| Keycloak         | ‚úÖ Oui, configurable (flows, policies)
| Auth0            | ‚úÖ Oui, `amr`, `auth_time` par d√©faut ; `acr` sur demande
| Azure AD         | ‚úÖ Oui, surtout `amr` ; `acr` selon contexte
| Okta             | ‚úÖ Oui, avec configuration
| Google Identity  | ‚ùå G√©n√©ralement non pr√©sents (sauf cas sp√©cifiques)
|===

Il est possible de demander des claims de mani√®re explicite, cela peut √™tre utile pour des custom claims.

[source,http]
----
GET /authorize?
client_id=client123&
response_type=code&
scope=openid&
claims={
  "id_token": {
    "acr": { "essential": true },
    "auth_time": { "essential": true }
  }
}
----


== üí° Exemple de requ√™te `/authorize` avec tous les scopes

[source,http]
----
GET /authorize?
client_id=client123&
response_type=code&
redirect_uri=https://app.com/callback&
scope=openid profile email offline_access&
state=abc123&
nonce=xyz456
----

* `scope=openid` ‚Üí Active OIDC, n√©cessaire pour avoir un `id_token`
* `profile`, `email` ‚Üí Demande des infos utilisateur
* `offline_access` ‚Üí Demande un `refresh_token`

== üì• Exemple de r√©ponse `/token` incluant tous les √©l√©ments

Apr√®s avoir re√ßu le `code`, le client fait un `POST /token` :

[source,http]
----
POST /token
Content-Type: application/x-www-form-urlencoded

grant_type=authorization_code&
code=SplxlOBeZQQYbYS6WxSbIA&
redirect_uri=https://app.com/callback&
client_id=client123&
code_verifier=dBjftJeZ4CVP-mB92K27uhbUJU1p1r_wW1gFWFOEjXk
----

R√©ponse typique :

[source,json]
----
{
  "access_token": "eyJhbGciOiJSUzI1NiIsInR...",
  "id_token": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refresh_token": "def456uvw",
  "expires_in": 3600,
  "token_type": "Bearer",
  "scope": "openid profile email offline_access"
}
----

== üß¨ Exemple de `id_token` d√©cod√©

=== En-t√™te
[source,json]
----
{
  "alg": "RS256",
  "typ": "JWT",
  "kid": "auth-key-1"
}
----

=== Payload
[source,json]
----
{
  "iss": "https://auth.example.com",
  "sub": "user_123",
  "aud": "client123",
  "exp": 1710000000,
  "iat": 1709999400,
  "nonce": "xyz456",
  "email": "user@example.com",
  "email_verified": true,
  "name": "Jean Dupont"
}
----

[cols="1,3",options="header"]
|===
| Claim | Description

| `iss` | Issuer : URL du serveur d'autorisation
| `sub` | Subject : identifiant unique de l‚Äôutilisateur
| `aud` | Audience : le `client_id` √† qui est destin√© ce token
| `exp` / `iat` | Dates d‚Äôexpiration / d‚Äô√©mission
| `nonce` | Jeton anti-rejeu g√©n√©r√© par le client (doit √™tre v√©rifi√©)
| `email`, `name` | Claims issus des scopes demand√©s (`email`, `profile`, etc.)
|===

[TIP]
====
Le client doit :
- v√©rifier la **signature du JWT** (`jwks_uri`)
- v√©rifier les valeurs de `aud`, `iss`, `exp`
- valider que `nonce` correspond √† celui envoy√© √† `/authorize`
====

[NOTE]
====
üëâ L‚Äô`id_token` est le c≈ìur du m√©canisme d‚Äôauthentification de l‚Äôutilisateur en OIDC.
Il permet de **v√©rifier une session sans faire d‚Äôappel au serveur**, contrairement √† `/userinfo`.

‚ÑπÔ∏è Le endpoint `/userinfo` retourne des informations **plus fra√Æches**, utiles si le `id_token` est partiel ou ancien.
====

== üîê Validation du id_token

1. R√©cup√©rer la cl√© publique via `jwks_uri`
2. V√©rifier la **signature** du JWT
3. Valider les claims suivants :
- `iss` == issuer attendu
- `aud` == client_id
- `exp` non expir√©
- `nonce` correspond √† celui fourni

[NOTE]
====
Certains serveurs mettent toutes les informations dans id_token, rendant /userinfo inutile (si ce n'est pour s'assurer que les informations sont √† jour)
====

== üîê S√©curit√© ‚Äì Le `nonce`

Permet de se pr√©munir contre les attaques de rejeu :
- Le client g√©n√®re un `nonce` √† l‚Äô√©tape `/authorize`
- Le serveur le renvoie dans le `id_token`
- Le client **doit v√©rifier** que la valeur correspond

== üß≠ Flux complet OIDC (Authorization Code + PKCE)

[plantuml]
----
@startuml
actor "Utilisateur" as User
participant "App (SPA / mobile)" as App
participant "Authorization Server / IdP" as AS

== √âtape 1 ‚Äì /authorize ==
App -> AS : GET /authorize?client_id=...&scope=openid profile&nonce=abc...

AS -> User : Formulaire de login

User -> AS : Login
AS -> App : Redirection /callback?code=xyz&state=...

== √âtape 2 ‚Äì /token ==
App -> AS : POST /token + code + code_verifier
AS -> App : access_token + id_token + refresh_token

== √âtape 3 ‚Äì /userinfo ==
App -> AS : GET /userinfo (avec access_token)
AS -> App : JSON : nom, email, etc.
@enduml
----

== üîÅ Fonctionnement du `refresh_token`

Le `refresh_token` :
- permet de **prolonger une session** sans que l‚Äôutilisateur ne se reconnecte,
- est obtenu **uniquement si le scope `offline_access` a √©t√© demand√©**,
- peut √™tre **refus√©** par le serveur (ex: clients publics JS, configuration IdP...),
- est **rotatif** sur certains serveurs : chaque utilisation en invalide l‚Äôancien.

=== üß≠ Flux d‚Äô√©change du refresh_token

[source,http]
----
POST /token
Content-Type: application/x-www-form-urlencoded

grant_type=refresh_token&
client_id=client123&
refresh_token=def456uvw
----

R√©ponse typique (rotation activ√©e) :

[source,json]
----
{
  "access_token": "eyJhbGciOiJIUzI1NiIs...",
  "id_token": "eyJhbGciOiJSUzI1NiIs...",
  "refresh_token": "ghi789rst", // nouveau
  "expires_in": 3600,
  "token_type": "Bearer"
}
----

== üîç Discovery ‚Äì /.well-known/openid-configuration

[source,http]
----
GET /.well-known/openid-configuration
----

[source,json]
----
{
  "issuer": "https://auth.example.com",
  "authorization_endpoint": ".../authorize",
  "token_endpoint": ".../token",
  "userinfo_endpoint": ".../userinfo",
  "jwks_uri": ".../.well-known/jwks.json",
  "response_types_supported": ["code", "id_token"],
  "id_token_signing_alg_values_supported": ["RS256"]
}
----

== üì• /userinfo ‚Äì Profil utilisateur

[source,http]
----
GET /userinfo
Authorization: Bearer <access_token>
----

[source,json]
----
{
  "sub": "user_123",
  "email": "user@example.com",
  "name": "Jean Dupont"
}
----

=== üìã Liste des claims retourn√©s par `/userinfo`

Les claims retourn√©s par `/userinfo` d√©pendent :
- des `scopes` demand√©s (`profile`, `email`, etc.)
- des claims disponibles et autoris√©s pour le client

Exemple de r√©ponse :
[source,json]
----
{
  "sub": "user_123",
  "name": "Jean Dupont",
  "email": "jean.dupont@example.com",
  "email_verified": true,
  "locale": "fr-FR",
  "updated_at": 1712345678
}
----

[NOTE]
====
Le contenu du `id_token` et du `/userinfo` peut √™tre personnalis√© c√¥t√© serveur :
- via des **mappers** (ex : Keycloak)
- via des **r√®gles ou hooks** (ex : Auth0 Rules)
====

== üí° Autres endpoints OIDC (optionnels)

[cols="1,3",options="header"]
|===
| Endpoint | Description

| `/logout` ou `/end_session` | Permet de d√©clencher une d√©connexion centralis√©e (SSO) du serveur IdP
| `/check_session` | Permet de v√©rifier via iframe que la session IdP est toujours active (rarement utilis√©)
| `/introspect` | Endpoint OAuth utilis√© pour v√©rifier un token opaque (non JWT)
| `/revocation` | Pour invalider un access_token ou refresh_token manuellement
| `/jwks.json` | Contient les cl√©s publiques utilis√©es pour v√©rifier la signature des `id_token`
|===

[TIP]
====
Les endpoints `/logout`, `/check_session`, etc., sont surtout utilis√©s dans des architectures SSO complexes (ex: avec Keycloak, Azure AD, etc.).
====

== üìö R√©f√©rences utiles

- https://openid.net/specs/openid-connect-core-1_0.html[OIDC Core 1.0 ‚Äì Sp√©cification officielle]
- https://auth0.com/docs/protocols[Auth0 ‚Äì Protocoles pris en charge]
- https://www.keycloak.org/docs/latest/securing_apps/index.html[Keycloak ‚Äì S√©curiser vos apps]
- https://developer.okta.com/docs/concepts/oauth-openid/[Okta ‚Äì Concepts OAuth2/OIDC]
