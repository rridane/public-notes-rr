:author-url: https://github.com/rridane
:source-highlighter: rouge
:hardbreaks:
:table-caption!:
:toc: left

== Concepts Clés
[cols="1,3", options="header"]
|===
| Terme | Définition
| FQDN | Nom de domaine complet (`www.example.com.`)
| Zone Apex | Domaine nu (`example.com`)
| Authoritative NS | Serveur faisant autorité pour une zone
| TTL | Durée de validité d'un enregistrement dans le cache
| RD (Recursion Desired) | Flag demandant une résolution récursive
| RA (Recursion Available) | Flag indiquant que le serveur supporte la récursion
|===

== Commandes Dig Essentielles
[source,bash]
----
# Résolution de base
dig example.com A              # Enregistrement A
dig example.com MX             # Serveurs mail
dig example.com NS             # Serveurs autoritaires
dig example.com TXT            # Enregistrements TXT (SPF/DKIM)

# Options avancées
dig +short example.com         # Sortie minimale
dig +trace example.com         # Résolution pas à pas
dig +nocmd +noall +answer example.com # Format propre
dig -x 192.0.2.1               # Résolution inverse (PTR)

# Sécurité
dig +dnssec example.com        # Validation DNSSEC
dig DNSKEY example.com         # Clés DNSSEC
dig _dmarc.example.com TXT     # Politique DMARC
dig selector._domainkey.example.com TXT # DKIM
----

== Enregistrements DNS
[cols="1,2,2", options="header"]
|===
| Type | Syntaxe | Usage
| A | `www IN A 192.0.2.1` | IPv4
| AAAA | `www IN AAAA 2001:db8::1` | IPv6
| CNAME | `blog IN CNAME example.com.` | Alias
| MX | `@ IN MX 10 mail.example.com.` | Mail (priorité basse = préféré)
| TXT | `@ IN TXT "v=spf1 ..."` | SPF/DKIM/DMARC
| NS | `@ IN NS ns1.example.com.` | Serveur autoritaire
| PTR | `1.0.0.10.in-addr.arpa. IN PTR ns1.example.com.` | Résolution inverse
| SOA | `@ IN SOA ns1 admin (2024070101 86400 7200 3600000 172800)` | Métadonnées de zone
|===

=== Paramètres SOA
[cols="1,3", options="header"]
|===
| Paramètre | Description
| Serial | Numéro de version (YYYYMMDDnn)
| Refresh | Intervalle de rafraîchissement (secondes)
| Retry | Délai avant nouvelle tentative
| Expire | Temps avant expiration des données
| NX TTL | Cache pour les réponses négatives
|===

== Sécurité Email

=== SPF (Sender Policy Framework)

==== Enregistrement DNS

[source,dns]
----
example.com. IN TXT "v=spf1 include:_spf.google.com -all"
----

[cols="1,3", options="header"]
|===
| Mécanisme | Usage
| `v=spf1` | Version SPF
| `ip4:192.0.2.1` | Autorise une IPv4 spécifique
| `include:_spf.google.com` | Importe les règles d'un domaine tiers
| `-all` | Rejet strict (politique par défaut)
| `~all` | SoftFail (accepte mais marque comme suspect)
|===

==== Processus de vérification

1. Le serveur récepteur :
a) Identifie le domaine dans l'adresse `Return-Path` (ex: `bounce@example.com`)
b) Interroge : `dig TXT example.com`
c) Compare l'IP de l'expéditeur avec les règles SPF

=== DKIM (DomainKeys Identified Mail)

==== Structure de l'en-tête DKIM

[source,email]
----
DKIM-Signature: v=1; a=rsa-sha256; d=example.com; s=selector1;
     h=from:to:subject:date; bh=2jUSOH9NhtVGCQWNr9BrIAPreKQjO6Sn7XIkfJVOzv8=;
     b=AuUoFEfDxTDkHlLXSZEpZj79LICEps6eda7W3deTVFOk4yAUoqOB
     4nujc7QgopLU3tkNP6t9FiS6HiULK6NZRg==
----

[cols="1,3", options="header"]
|===
| Champ | Explication
| `v=1` | Version DKIM (toujours 1 actuellement)
| `a=rsa-sha256` | Algorithme de signature (RSA + SHA-256)
| `d=example.com` | Domaine signataire (doit correspondre au DNS)
| `s=selector1` | Sélecteur pour localiser la clé publique dans DNS
| `h=from:to:subject:date` | En-têtes signés (séparés par :)
| `bh=...` | Hash du corps du message (base64)
| `b=...` | Signature des en-têtes (base64)
|===

==== Processus complet
1. Le serveur émetteur :
a) Génère la signature avec sa clé privée
b) Insère l'en-tête DKIM-Signature
2. Le serveur récepteur :
a) Extrait `d=` (domaine) et `s=` (sélecteur)
b) Interroge DNS : `dig TXT selector1._domainkey.example.com`
c) Vérifie la signature avec la clé publique

=== DMARC (Domain-based Message Auth)
[source,dns]
----
_dmarc.example.com. IN TXT "v=DMARC1; p=reject; rua=mailto:admin@example.com"
----
* Politiques : `none` / `quarantine` / `reject`

== DNSSEC
[cols="1,3", options="header"]
|===
| Enregistrement | Rôle
| DNSKEY | Clé publique (KSK/ZSK)
| RRSIG | Signature cryptographique
| DS | Delegation Signer (hash KSK enfant)
| NSEC/NSEC3 | Preuve de non-existence
|===

=== Chaîne de Validation DNSSEC
[plantuml, dnssec-chain, svg]
----
left to right direction

rectangle "Racine (.)" as root {
  rectangle "KSK Racine" as root_ksk
  rectangle "ZSK Racine" as root_zsk
}

rectangle ".com" as tld {
  rectangle "KSK .com" as tld_ksk
  rectangle "ZSK .com" as tld_zsk
}

rectangle "example.com" as domain {
  rectangle "KSK example.com" as dom_ksk
  rectangle "ZSK example.com" as dom_zsk
}

root_ksk --> tld_ksk : DS
tld_ksk --> dom_ksk : DS
dom_zsk --> "Données DNS" : Signe les\nenregistrements
----

[cols="1,3", options="header"]
|===
| Étape | Explication
| 1. Racine |
- KSK signe les DNSKEY (KSK+ZSK)
- Contient le DS pour .com (hash de la KSK .com)

| 2. TLD (.com) |
- KSK .com signe ses DNSKEY
- Contient le DS pour example.com

| 3. Domaine |
- KSK example.com signe ses DNSKEY
- ZSK signe les enregistrements (A, MX...)
|===


== Sécurité DNS
=== TSIG (Transaction Signature)
[source,bash]
----
# Génération clé
dnssec-keygen -a HMAC-SHA256 -n HOST tsig-key

# Configuration BIND
key "tsig-key" {
  algorithm hmac-sha256;
  secret "base64-key";
};
----

=== DoH/DoT
[cols="1,3", options="header"]
|===
| Protocole | Détails
| DoT (DNS over TLS) | Port 853, chiffrement TLS
| DoH (DNS over HTTPS) | Port 443, encapsulation HTTP
|===

=== ACL BIND9
[source,bind]
----
acl "trusted" { 192.0.2.0/24; };
options {
  allow-query { trusted; };
  allow-transfer { none; };
};
----

== Gestion des Zones & Cache
[cols="1,3", options="header"]
|===
| Concept | Description
| AXFR | Transfert complet de zone
| IXFR | Transfert incrémental
| DNS Notify | Notification de changement
| Anycast | Même IP sur plusieurs serveurs
| TTL Strategy | 300s avant changement → 86400s après
|===

== Notes Importantes
=== Relations Zones/Noms
* Une zone = périmètre d'autorité défini par SOA
* Les sous-domaines font partie de la zone sauf délégation explicite (NS)
* Impossible de lister tous les sous-domaines via DNS

=== Résolution SMTP
[source,bash]
----
# Processus pour contact@tessi.fr:
dig tessi.fr MX               → Serveur mail
dig MX-record A               → IP du serveur
----

=== Concepts de Sécurité
[cols="1,3", options="header"]
|===
| Terme | Rôle
| TSIG | Auth. transferts de zone (AXFR/IXFR)
| SPF | Validation IP expéditeur
| DKIM | Signature cryptographique email
| DMARC | Politique basée sur SPF/DKIM
| DNSSEC | Intégrité/authenticité des données DNS
|===

== Outils Utiles
[cols="1,3", options="header"]
|===
| Commande | Usage
| `dig +short` | Sortie minimale
| `dig +trace` | Résolution complète
| `nslookup -type=txt _dmarc.example.com` | Vérification DMARC
| `mxtoolbox.com` | Diagnostic en ligne
| `dnschecker.org` | Propagation DNS
|===

== 🌐 Configuration Complète BIND avec DNSSEC

=== Arborescence des Fichiers

[source,text]
----
/etc/bind/
├── named.conf                     # Configuration principale
├── keys/                          # Répertoire sécurisé pour les clés
│   ├── K.root.+008+12345.key      # DNSKEY publique racine (trust anchor)
│   ├── K.root.+008+12345.private  # Clé privée KSK racine 🔐
│   ├── K.root.+008+67890.key      # DNSKEY publique ZSK racine
│   ├── K.root.+008+67890.private  # Clé privée ZSK racine 🔐
│   ├── K.com.+013+19718.key       # DNSKEY publique KSK .com
│   ├── K.com.+013+19718.private   # Clé privée KSK .com 🔐
│   ├── K.com.+013+54321.key       # DNSKEY publique ZSK .com
│   ├── K.com.+013+54321.private   # Clé privée ZSK .com 🔐
│   ├── K.cloudflare.+013+34505.key # DNSKEY publique KSK cloudflare
│   ├── K.cloudflare.+013+34505.private # Clé privée KSK cloudflare 🔐
│   ├── K.cloudflare.+013+67890.key # DNSKEY publique ZSK cloudflare
│   └── K.cloudflare.+013+67890.private # Clé privée ZSK cloudflare 🔐
├── zones/
│   ├── db.root                    # Zone racine (.)
│   ├── db.com                     # Zone TLD (.com)
│   └── db.cloudflare.com          # Zone domaine (cloudflare.com)
----

=== 🔧 1. `named.conf` - Configuration Principale

[source,bind]
----
options {
    directory "/etc/bind";
    dnssec-enable yes;              # Activation globale DNSSEC
    dnssec-validation yes;          # Validation récursive DNSSEC
    bindkeys-file "/etc/bind/keys/bind.keys"; # Fichier trust anchors

    # Configuration DNSSEC avancée
    dnssec-lookaside auto;          # Utilisation DLV (si nécessaire)
    dnssec-must-be-secure "." yes;  # Exiger validation pour la racine
};

// ZONE RACINE
zone "." {
    type master;
    file "zones/db.root";
    key-directory "/etc/bind/keys"; # Répertoire des clés
    auto-dnssec maintain;           # Gestion automatique signatures
    inline-signing yes;             # Signatures en temps réel
};

// ZONE TLD (.com)
zone "com." {
    type master;
    file "zones/db.com";
    key-directory "/etc/bind/keys";
    auto-dnssec maintain;
    inline-signing yes;
};

// ZONE DOMAINE
zone "cloudflare.com." {
    type master;
    file "zones/db.cloudflare.com";
    key-directory "/etc/bind/keys";
    auto-dnssec maintain;
    inline-signing yes;
};
----

==== 🔍 Explications :
- `key-directory` : Répertoire contenant à la fois les clés publiques (.key) et privées (.private)
- `auto-dnssec maintain` : BIND signe automatiquement la zone avec les clés disponibles
- `inline-signing` : Génération dynamique des signatures sans modifier le fichier de zone original

=== 🌐 2. `/etc/bind/zones/db.root` - Zone Racine (.) avec clés PUBLIQUES

[source,bind]
----
$TTL 3600
@ IN SOA  root.dns. admin.dns. (
    2025070101 ; Serial (AAAAMMJJNN)
    10800      ; Refresh (3h)
    3600       ; Retry (1h)
    2592000    ; Expire (30j)
    3600       ; Minimum TTL (1h)
)

; SERVERS RACINE
. IN NS a.root-servers.net.
a.root-servers.net. IN A 198.41.0.4

; === ENREGISTREMENTS DNSSEC ===

; -- DNSKEY PUBLIQUE RACINE (KSK) --
@ IN DNSKEY 257 3 8 (
    AwEAAagAIKlVZrpC6Ia7gEzahOR+9W29euxhJhVVLOyQ...
) ; id = 12345 (KSK)

; -- DNSKEY PUBLIQUE RACINE (ZSK) --
@ IN DNSKEY 256 3 8 (
    AwEAAbcd123456...
) ; id = 67890 (ZSK)

; -- RRSIG DNSKEY (signée par KSK privée) --
@ IN RRSIG DNSKEY 8 0 3600 (
    20250801000000 ; Expiration
    20250701000000 ; Début validité
    12345          ; Key tag KSK
    .
    FAKE-SIGNATURE==
)

; -- DS pour .com (hash de la KSK publique de .com) --
com. IN DS 19718 13 2 (
    E4F1A2B38CFBD55AB4FE3C739F785842B9C2EDC1DA92...
) ; Algo 13 (ECDSA), Digest Type 2 (SHA-256)

; -- RRSIG DS (signée par ZSK privée) --
com. IN RRSIG DS 8 1 86400 (
    20250801000000
    20250701000000
    67890          ; Key tag ZSK
    .
    FAKE-SIGNATURE==
)
----

==== 🔒 Fichier de clé privée associée : `/etc/bind/keys/K.root.+008+12345.private`
[source,text]
----
Private-key-format: v1.3
Algorithm: 8 (RSASHA256)
Modulus: AQOgx... (base64)
PublicExponent: AQAB
PrivateExponent: MIGHAgE... (base64)
Prime1: 7ZvR...
Prime2: 6Uw9...
Exponent1: 5l0x...
Exponent2: 4k4c...
Coefficient: 1k3b...
----

=== 🌐 3. `/etc/bind/zones/db.com` - Zone .com avec clés PUBLIQUES

[source,bind]
----
$TTL 3600
@ IN SOA ns1.com. admin.com. (
    2025070101
    7200
    3600
    1209600
    3600
)

; SERVERS TLD
com. IN NS ns1.com.
ns1.com. IN A 192.5.6.30

; === ENREGISTREMENTS DNSSEC ===

; -- DNSKEY PUBLIQUE KSK .com (algo 13) --
@ IN DNSKEY 257 3 13 (
    AwEAAZ0pD5r+9k/3VJbV4R7zJ2mG...
) ; id = 19718

; -- DNSKEY PUBLIQUE ZSK .com --
@ IN DNSKEY 256 3 13 (
    AwEAAd1Xv5rX3Y6Z6A7...
) ; id = 54321

; -- RRSIG DNSKEY (signée par KSK privée) --
@ IN RRSIG DNSKEY 13 1 3600 (
    20250801000000
    20250701000000
    19718
    com.
    FAKE-SIGNATURE==
)

; -- DS pour cloudflare.com (hash de la KSK publique cloudflare) --
cloudflare.com. IN DS 34505 13 2 (
    9A8D7B2E9E1C37F6D2AC7A9270B0F3F8912C5827AE51...
)

; -- RRSIG DS (signée par ZSK privée .com) --
cloudflare.com. IN RRSIG DS 13 2 86400 (
    20250801000000
    20250701000000
    54321
    com.
    FAKE-SIGNATURE==
)
----

==== 🔒 Fichier de clé privée associée : `/etc/bind/keys/K.com.+013+19718.private`
[source,text]
----
Private-key-format: v1.3
Algorithm: 13 (ECDSAP256SHA256)
PrivateKey: MIGHAgEAMBMGByqGSM49AgEGCCqGSM49AwEHBG0wawIBAQQgZ0lHk8gHkz0a...
----

=== 🌐 4. `/etc/bind/zones/db.cloudflare.com` - Zone Domaine avec clés PUBLIQUES

[source,bind]
----
$TTL 300
@ IN SOA ns1.cloudflare.com. admin.cloudflare.com. (
    2025070101
    3600
    1800
    604800
    300
)

; SERVERS DOMAINE
@ IN NS ns1.cloudflare.com.
ns1 IN A 104.16.134.229

; === ENREGISTREMENTS DNSSEC ===

; -- DNSKEY PUBLIQUE KSK cloudflare.com --
@ IN DNSKEY 257 3 13 (
    AwEAAZ0pD5r+9k/3VJbV4R7zJ2mG...
) ; id = 34505

; -- DNSKEY PUBLIQUE ZSK cloudflare.com --
@ IN DNSKEY 256 3 13 (
    AwEAAd1Xv5rX3Y6Z6A7...
) ; id = 67890

; -- RRSIG DNSKEY (signée par KSK privée) --
@ IN RRSIG DNSKEY 13 2 3600 (
    20250801000000
    20250701000000
    34505
    cloudflare.com.
    FAKE-SIGNATURE==
)

; === DONNÉES UTILES ===
www IN A 104.16.132.229
www IN A 104.16.133.229

; -- Signature RRset A (signée par ZSK privée) --
www IN RRSIG A 13 3 300 (
    20250710000000  ; TTL court pour rotation fréquente
    20250701000000
    67890           ; Key tag ZSK
    cloudflare.com.
    FAKE-SIGNATURE==
)
----

==== 🔒 Fichier de clé privée associée : `/etc/bind/keys/K.cloudflare.+013+67890.private`
[source,text]
----
Private-key-format: v1.3
Algorithm: 13 (ECDSAP256SHA256)
PrivateKey: MIGHAgEAMBMGByqGSM49AgEGCCqGSM49AwEHBG0wawIBAQQgZ0lHk8gHkz0a...
----

© 2025 *rridane* – [GitHub](https://github.com/rridane)
