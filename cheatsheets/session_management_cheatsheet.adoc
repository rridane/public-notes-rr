:author-url: https://github.com/rridane
:author: rridane
:source-highlighter: rouge
:hardbreaks:
:table-caption!:
:toc: left
:toclevels: 3
:numbered:

= Session Management – Fiche complète

[plantuml]
----
@startuml
actor "Utilisateur" as User
participant "Navigateur"
participant "Serveur" as Server
participant "SessionStore" as Store

User -> Navigateur : Saisie identifiants
Navigateur -> Server : POST /login (credentials)
Server -> Store : Crée une session (id, user_id...)
Server -> Navigateur : Set-Cookie: session_id=abc123

Navigateur -> Server : GET /dashboard (avec cookie)
Server -> Store : Récupère session_id
Server -> Navigateur : Contenu personnalisé
@enduml
----

== ⚙️ Cookie de session

[source,http]
----
Set-Cookie: session_id=abc123; HttpOnly; Secure; SameSite=Strict
----

[cols="1,3",options="header"]
|===
|Attribut |Explication

|HttpOnly  |Interdit l’accès JS au cookie (anti-XSS)
|Secure    |Transmis uniquement via HTTPS
|SameSite  |Empêche les requêtes intersites (anti-CSRF)
|Max-Age   |Durée de vie explicite (en secondes)
|Path      |URL concernée par le cookie
|===

== 🧾 Contenu type d’une session (côté serveur)

[source,json]
----
{
  "session_id": "abc123",
  "user_id": 42,
  "roles": ["admin"],
  "created_at": "2025-07-30T08:00:00Z",
  "expires_at": "2025-07-30T10:00:00Z",
  "csrf_token": "xyz456"
}
----

== 🔐 Sécurité des sessions

[cols="2,3",options="header"]
|===
|Problème |Contremesure

|Session Fixation  |Regénérer le session_id après login
|Session Hijacking |HttpOnly, Secure, rotation, scope IP
|CSRF              |SameSite + CSRF token
|===

== 🔁 Expiration & Logout

- *Idle Timeout* : expiration après inactivité
- *Expiration absolue* : durée maximale stricte (ex: 2h)
- *Logout* :
- Supprimer la session côté serveur
- Invalider le cookie côté client

[source,http]
----
Set-Cookie: session_id=; Max-Age=0; Path=/; HttpOnly
----

=== 🧪 Tests avec `curl`

[source,bash]
----
# Authentification (création session manuelle)
curl -c cookies.txt -X POST -d "username=bob&password=secret123" http://localhost/login.php

# Requête GET authentifiée
curl -b cookies.txt http://localhost/dashboard.php

# Déconnexion
curl -b cookies.txt http://localhost/logout.php
----

== ⚖️ Comparaison JWT vs Session

[cols="1,2,2",options="header"]
|===
|Critère |Session |JWT

|Stateless |❌ Non |✅ Oui
|Stockage serveur |✅ Oui |❌ Non
|Lisible côté client |❌ Non |✅ Oui (claims)
|Révocable facilement |✅ Oui |❌ Difficile
|Risques |Hijacking |Vol de token
|===
