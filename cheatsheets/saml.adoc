:author-url: https://github.com/rridane
:author: rridane
:source-highlighter: rouge
:hardbreaks:
:table-caption!:
:toc: left

= Authentification SAML 2.0

== √âtape 1 ‚Äì SAMLRequest via HTTP Redirect

[plantuml]
----
@startuml
actor "Utilisateur" as User
participant "Navigateur"
participant "Identity Provider (IdP)"
participant "Service Provider (SP)"

== D√©but du flux ==
User -> Navigateur : Acc√®s √† une ressource prot√©g√©e

Navigateur -> IdP : Redirection GET vers l‚ÄôIdP (SAMLRequest)

note right of Navigateur
Le navigateur suit la redirection :
- URL avec SAMLRequest, RelayState, SigAlg, Signature
end note

note right of IdP
L‚ÄôIdP :
- D√©code base64
- D√©compresse le XML
- V√©rifie :
  ‚Ä¢ Signature avec la cl√© publique du SP
  ‚Ä¢ Issuer (EntityID)
  ‚Ä¢ AssertionConsumerServiceURL autoris√©e
end note

IdP -> Navigateur : Page HTML avec formulaire de login

note right of Navigateur
Affiche la page de login de l‚ÄôIdP :
- Champs identifiants / mot de passe
- M√©thode POST vers l‚ÄôIdP
end note
@enduml
----

== Etape 2 - SAMLResponse

[plantuml]
----
@startuml
actor "Utilisateur" as User
participant "Navigateur"
participant "Identity Provider (IdP)"
participant "Service Provider (SP)" as SP

== Authentification ==
User -> Navigateur : Saisie des identifiants
Navigateur -> IdP : POST vers formulaire d‚Äôauthentification
IdP -> IdP : V√©rifie les identifiants

== G√©n√©ration de la SAMLResponse ==
note right of IdP
L‚ÄôIdP :
- G√©n√®re une SAMLResponse
- Contient une ou plusieurs Assertions
- Signe avec sa cl√© priv√©e
- Peut chiffrer avec la cl√© publique du SP
- Ajoute un RelayState (ex: URL cible)
end note

IdP -> Navigateur : Page HTML avec formulaire POST auto-soumis

note right of Navigateur
Page HTML re√ßue :
- Formulaire cach√© : SAMLResponse (+ RelayState)
- action = URL ACS du SP
- JavaScript : document.forms[0].submit()
end note

Navigateur -> SP : POST vers ACS avec SAMLResponse (+ RelayState)
SP --> Navigateur : HTTP 200 OK (traitement c√¥t√© serveur)

note right of SP
Le SP :
- V√©rifie la signature avec la cl√© publique de l‚ÄôIdP
- D√©chiffre les assertions (si chiffr√©es)
- Cr√©e une session pour l‚Äôutilisateur
- Utilise RelayState pour rediriger vers l‚ÄôURL initiale (fournie par l‚ÄôIdP)
end note
@enduml
----

== üîê Mod√®le de confiance

|===
| R√¥le | Poss√®de la **cl√© priv√©e** pour ‚Ä¶ | Fait circuler la **cl√© publique / certificat** via ‚Ä¶
| **IdP** | ‚Ä¢ Signer chaque `SAMLResponse` (et √©ventuellement chiffrer les `Assertion`) | `metadata.xml` de l‚ÄôIdP ‚áí remis au **SP**
| **SP** | ‚Ä¢ *Optionnel* : signer la `SAMLRequest`<br>‚Ä¢ *Optionnel* : d√©chiffrer une `EncryptedAssertion` | `metadata.xml` du SP ‚áí remis √† l‚Äô**IdP**, signer les param√®tres d'URL.
|===

== üì§ Exemple complet de `SAMLRequest`

[source,xml]
----
<samlp:AuthnRequest
    xmlns:samlp="urn:oasis:names:tc:SAML:2.0:protocol"
    xmlns:saml="urn:oasis:names:tc:SAML:2.0:assertion"
    ID="_12345"
    Version="2.0"
    IssueInstant="2025-07-10T08:00:00Z"
    Destination="https://idp.example.com/sso"
    AssertionConsumerServiceURL="https://sp.example.com/saml/acs"
    ProtocolBinding="urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST">
  <saml:Issuer>https://sp.example.com/metadata</saml:Issuer>
  <samlp:NameIDPolicy
      Format="urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress"
      AllowCreate="true"/>
  <samlp:RequestedAuthnContext Comparison="exact">
    <saml:AuthnContextClassRef>
      urn:oasis:names:tc:SAML:2.0:ac:classes:PasswordProtectedTransport
    </saml:AuthnContextClassRef>
  </samlp:RequestedAuthnContext>
</samlp:AuthnRequest>
----

== üì• Exemple complet de `SAMLResponse`

[source,xml]
----
<samlp:Response
    xmlns:samlp="urn:oasis:names:tc:SAML:2.0:protocol"
    ID="_response123"
    InResponseTo="_12345"
    Version="2.0"
    IssueInstant="2025-07-10T08:00:10Z"
    Destination="https://sp.example.com/saml/acs">
  <saml:Issuer xmlns:saml="urn:oasis:names:tc:SAML:2.0:assertion">
    https://idp.example.com
  </saml:Issuer>
  <samlp:Status>
    <samlp:StatusCode Value="urn:oasis:names:tc:SAML:2.0:status:Success"/>
  </samlp:Status>

  <saml:Assertion xmlns:saml="urn:oasis:names:tc:SAML:2.0:assertion"
      ID="_assertion123"
      IssueInstant="2025-07-10T08:00:10Z"
      Version="2.0">
    <saml:Issuer>https://idp.example.com</saml:Issuer>

    <saml:Subject>
      <saml:NameID Format="urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress">
        user@example.com
      </saml:NameID>
      <saml:SubjectConfirmation Method="urn:oasis:names:tc:SAML:2.0:cm:bearer">
        <saml:SubjectConfirmationData
            InResponseTo="_12345"
            NotOnOrAfter="2025-07-10T08:05:00Z"
            Recipient="https://sp.example.com/saml/acs"/>
      </saml:SubjectConfirmation>
    </saml:Subject>

    <saml:Conditions NotBefore="2025-07-10T08:00:00Z" NotOnOrAfter="2025-07-10T08:05:00Z">
      <saml:AudienceRestriction>
        <saml:Audience>https://sp.example.com/metadata</saml:Audience>
      </saml:AudienceRestriction>
    </saml:Conditions>

    <saml:AuthnStatement AuthnInstant="2025-07-10T08:00:05Z">
      <saml:AuthnContext>
        <saml:AuthnContextClassRef>
          urn:oasis:names:tc:SAML:2.0:ac:classes:PasswordProtectedTransport
        </saml:AuthnContextClassRef>
      </saml:AuthnContext>
    </saml:AuthnStatement>

    <saml:AttributeStatement>
      <saml:Attribute Name="email">
        <saml:AttributeValue>user@example.com</saml:AttributeValue>
      </saml:Attribute>
      <saml:Attribute Name="groups">
        <saml:AttributeValue>admin</saml:AttributeValue>
      </saml:Attribute>
    </saml:AttributeStatement>
  </saml:Assertion>
</samlp:Response>
----

== üìã D√©tails des param√®tres

=== `AuthnRequest` ‚Äì Param√®tres XML (contenus dans le SAMLRequest)

|===
| √âl√©ment / Attribut | Obligatoire | Description

| `ID` | Oui | Identifiant unique pour le couplage avec `InResponseTo`.
| `IssueInstant` | Oui | Timestamp ISO 8601.
| `Destination` | Recommand√© | Endpoint SSO de l‚ÄôIdP (doit matcher celui du metadata).
| `AssertionConsumerServiceURL` | Oui | Endpoint ACS du SP.
| `ProtocolBinding` | Non | Binding attendu pour la r√©ponse (`POST`, `Artifact`, etc.).
| `Issuer` | Oui | `EntityID` du SP.
| `ForceAuthn` / `IsPassive` | Non | Requiert une nouvelle authentification / pas d‚Äôinteraction utilisateur.
| `NameIDPolicy` | Non | Format du `NameID` souhait√© (ex: email, transient).
| `RequestedAuthnContext` | Non | Niveau d‚Äôauthentification requis (ex: MFA, password).
| `Signature` (XML-DSig) | Facultatif | Signature XML de la requ√™te (en mode POST, principalement).
|===

=== `AuthnRequest` ‚Äì Param√®tres de transport (hors XML, en query string)

|===
| Param√®tre HTTP | Obligatoire | Description

| `RelayState` | Non | Donn√©e opaque transmise par le SP, renvoy√©e telle quelle par l‚ÄôIdP.
| `SigAlg` | Oui si `Signature` | Algorithme utilis√© pour signer (`rsa-sha256`, etc.).
| `Signature` | Oui si signature | Signature HMAC/DSig de la cha√Æne canonique (base64 du SAMLRequest + SigAlg + RelayState).
|===

=== `SAMLResponse` / `Assertion`

*XML global

|===
| √âl√©ment / Attribut | Obligatoire | Description

| `ID` (`Response`) | Oui | Identifiant de la r√©ponse.
| `InResponseTo` | Oui | Fait r√©f√©rence √† l‚Äô`ID` de la requ√™te.
| `Destination` | Oui | Doit matcher l‚ÄôACS connue du SP.
| `Issuer` (`Response`) | Oui | `EntityID` de l‚ÄôIdP.
| `StatusCode` | Oui | R√©sultat (`Success`, `Responder`, etc.).
|===

*Bloc `Assertion`*

|===
| `ID` (`Assertion`) | Oui | Identifiant unique.
| `Issuer` (`Assertion`) | Oui | IdP √©metteur.
| `Subject` / `NameID` | Oui | Identit√© de l‚Äôutilisateur.
| `SubjectConfirmation` | Oui | Contr√¥le de r√©ception (Recipient, NotOnOrAfter‚Ä¶).
| `Conditions` | Oui | Fen√™tre de validit√©, restrictions d‚Äôaudience.
| `AuthnStatement` | Non | Date et contexte d‚Äôauth.
| `AttributeStatement` | Non | Attributs (`email`, `groups`, etc.).
| `Signature` | Oui | Sign√©e par la **cl√© priv√©e de l‚ÄôIdP**.
|===

== üß© Subtilit√©s et options avanc√©es

* **Bindings** : Redirect (GET, deflate+base64), POST (body base64), Artifact (indirection).
* **Chiffrement** : `<EncryptedAssertion>` ‚Üí IdP chiffre avec la cl√© publique du SP.
* **RelayState** : jamais sensible, v√©rifier qu‚Äôil ne permet pas de redirection externe.
* **Conditions** : timestamps anti-replay, `AudienceRestriction`, `Recipient`.
* **NameID formats** : `emailAddress`, `persistent`, `transient`, `unspecified`.
* **AuthnContext** : impose password, MFA, certificat X.509, etc.

[NOTE]
--
Le param√®tre RelayState permet au SP de conserver un contexte tout au long du cycle SAML (par exemple : URL d'origine, identifiant de session interne, etc.). C'est le relayState qui est en g√©n√©ral utilis√© pour rediriger l'utilisateur au bout du processus d'authentification.
--

== Flux IdP-initi√© (HTTP POST)

[plantuml]
----
@startuml
actor "Utilisateur" as User
participant "Navigateur"
participant "Identity Provider (IdP)"
participant "Service Provider (SP)" as SP

== Acc√®s via IdP ==
User -> Navigateur : Clic sur un lien du portail IdP
Navigateur -> IdP : Requ√™te vers le lien prot√©g√©

== G√©n√©ration de la SAMLResponse ==
note right of IdP
L‚ÄôIdP :
- G√©n√®re une SAMLResponse
- Contient une ou plusieurs Assertions
- Signe avec sa cl√© priv√©e
- Peut chiffrer avec la cl√© publique du SP
- Ajoute √©ventuellement un RelayState
end note

IdP -> Navigateur : HTTP 200 ‚Äì Page HTML contenant un formulaire cach√©

note right of Navigateur
Page HTML re√ßue :
- Formulaire cach√© : SAMLResponse (+ RelayState)
- action = URL ACS du SP
- JavaScript : document.forms[0].submit()
end note

Navigateur -> SP : POST automatique vers ACS avec SAMLResponse
SP --> Navigateur : HTTP 200 OK (traitement de la r√©ponse)

note right of SP
Le SP :
- V√©rifie la signature avec la cl√© publique de l‚ÄôIdP
- D√©chiffre les assertions (si chiffr√©es)
- Cr√©e une session pour l‚Äôutilisateur
- Utilise RelayState pour rediriger vers la bonne ressource
end note
@enduml
----

== Risque principal : Open Redirect

Lorsque le relayState est utilis√© comme redirection cela ouvre la porte √† cette faille:

[plantuml]
----
@startuml
actor "Attaquant" as A
participant "Victime" as V
participant "SP" as SP
participant "IdP" as IdP

V -> A : "Navigue sur un site de l'attaquant"
A -> V : "Lien vers ressource SP\navec RelayState=hacker.com"
V -> SP : GET /ressource-proteg√©e
SP -> IdP : REDIRECT 302\nLocation: /sso?SAMLRequest=...&RelayState=hacker.com
IdP -> V : 200 OK + Formulaire auth
V -> IdP : POST /login (credentials)
IdP -> SP : 200 OK + HTML auto-submit\n(SAMLResponse + RelayState=hacker.com)
SP -> V : REDIRECT 302\nLocation: hacker.com?session=xxx
V -> A : GET hacker.com?session=vol√©e
@enduml
----

== Signature des Requ√™tes (SAMLRequest)

[cols="2,2"]
|===
| Contexte | Recommandation
| Binding HTTP-Redirect (GET) | **Fortement conseill√©e**
| Binding HTTP-POST | Optionnelle
| Environnements sensibles | Obligatoire
| IdP publics (Azure AD, Okta) | Souvent requise
|===

