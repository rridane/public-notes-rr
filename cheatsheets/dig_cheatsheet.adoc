:author-url: https://github.com/rridane
:source-highlighter: rouge
:hardbreaks:
:table-caption!:
:toc: left

= Cheatsheet dig

== 🧠 DIG — Domain Information Groper : Bases

=== 📌 Syntaxe de base

----
dig [nom_de_domaine] [type_enregistrement] [@serveur_dns]
----

- `nom_de_domaine` : nom à résoudre (ex: `example.com`)
- `type_enregistrement` : A, AAAA, MX, NS, TXT, etc. (par défaut : A)
- `@serveur_dns` : optionnel — DNS spécifique (ex: `@1.1.1.1`)

== 🔍 Exemples simples

[source, bash]
----
# Résolution enregistrement A (IPv4)
dig example.com

# Résolution enregistrement AAAA (IPv6)
dig example.com AAAA

# Résolution enregistrements MX
dig example.com MX

# Préciser le serveur dns
dig example.com @8.8.8.8
----

== 🔎 Sections de la réponse

1. *HEADER* : résumé de la requête (code retour, ID, flags)
2. *QUESTION SECTION* : ce que `dig` a demandé
3. *ANSWER SECTION* : réponse(s) du serveur
4. *AUTHORITY SECTION* : serveurs faisant autorité
5. *ADDITIONAL SECTION* : infos supplémentaires (ex: IP des NS)
6. *OPT EDNS section*: voir ci-dessous

=== 🔹 OPT PSEUDOSECTION (EDNS)

Depuis l'extension EDNS(0), les réponses DNS peuvent contenir une section supplémentaire appelée `OPT PSEUDOSECTION`.

----
;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
----

- `EDNS: version` : version d'EDNS utilisée (actuellement 0)
- `udp: 1232` : taille maximale des messages DNS en UDP
- `flags: do` : signifie que le client demande les données DNSSEC

Cette section n’est pas un enregistrement DNS classique mais un *pseudo-record* pour transporter des options avancées comme DNSSEC, client subnet, etc.

Utiliser `+dnssec` ajoute automatiquement `do` dans cette section.

== 🧰 Options utiles

[source, bash]
----
# Résultat concis (sans fioriture)
dig +short example.com

# Ne pas utiliser le fichier /etc/resolv.conf
dig example.com +norecurse

# Voir tout (très verbeux, de la racine au domaine)
dig example.com +trace

# Afficher seulement l’ANSWER
dig example.com +noall +answer

# Ajouter le TTL en unités lisibles
dig example.com +ttlunits
----

== 🌐 Requêtes types fréquentes

[source, bash]
----
# Liste des serveurs DNS faisant autorité pour example.com
dig example.com NS

# Voir les SPF, DKIM, etc.
dig example.com TXT

# Reverse DNS lookup
dig -x 8.8.8.8

# Infos sur le Start of Authority
dig example.com SOA

# Interroger les serveurs racine
dig @root-servers.net . NS
----

=== 📋 Décomposition complète du HEADER

Une ligne typique du `HEADER` ressemble à ceci :

----
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 58279
;; flags: qr rd ra ad; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1
----

Voici la signification de chaque champ :

==== 🔢 `id: 58279`
- Identifiant unique de la requête DNS
- Permet au client de faire correspondre les réponses avec ses requêtes

==== 🔁 `opcode: QUERY`
- Type d’opération effectuée (souvent `QUERY`, mais pas toujours)

- Valeurs possibles :

|===
| Code | Nom | Description
| 0 | QUERY | Requête DNS classique
| 1 | IQUERY | Inverse Query (déprécié)
| 2 | STATUS | Demande le statut du serveur
| 4 | NOTIFY | Notification de changement (DNS dynamique)
| 5 | UPDATE | Mise à jour DNS dynamique
|===

==== 🟢 `status: NOERROR`
- Code de retour DNS indiquant si la requête a réussi

- Valeurs possibles courantes :

|===
| Code | Signification | Description
| NOERROR | ✅ Pas d’erreur | La réponse est valide
| NXDOMAIN | ❌ Nom inexistant | Le domaine n’existe pas
| SERVFAIL | ❌ Server failure | Le serveur DNS a échoué
| REFUSED | ❌ Refusé | Requête rejetée (filtrage, ACL...)
| FORMERR | ❌ Format error | Requête mal formée
| NOTIMP | ❌ Not implemented | Le serveur ne connaît pas l’opération
|===

=== 🧩 `flags: qr rd ra ad ...`

Indiquent les propriétés de la requête/réponse

|===
| Flag | Signification

| `qr` | Query Response (réponse, toujours présent)
| `rd` | Recursion Desired (le client demande une récursion)
| `ra` | Recursion Available (le serveur peut faire de la récursion)
| `aa` | Authoritative Answer (le serveur répond avec autorité)
| `tc` | Truncated (la réponse est trop longue pour UDP)
| `ad` | Authenticated Data (validation DNSSEC)
| `cd` | Checking Disabled (validation DNSSEC désactivée)
|===

==== 🧮 `QUERY`, `ANSWER`, `AUTHORITY`, `ADDITIONAL`

- Ce sont les **compteurs de sections** de la réponse :

  | Champ | Signification
  |-------|----------------
  | `QUERY` | Nombre de questions posées (souvent 1)
  | `ANSWER` | Nombre de réponses obtenues (ex: A, MX, etc.)
  | `AUTHORITY` | Nombre d’enregistrements NS de référence
  | `ADDITIONAL` | Enregistrements supplémentaires (ex: glue records, OPT)

----
;; flags: qr rd ra ad; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1
             ↑         ↑          ↑              ↑
             │         │          │              └─ Nombre de sections supplémentaires
             │         │          └──────────────── Nombre de serveurs d'autorité
             │         └─────────────────────────── Nombre de réponses obtenues
             └───────────────────────────────────── Nombre de questions posées
----

== 🔐 DNSSEC avec dig

=== ⚙️
[source, bash]
----
# Activer DNSSEC pour un domaine
dig example.com +dnssec

# 🔍 Vérifier les enregistrements de clé
dig example.com DNSKEY +dnssec +multiline

# 🔗 Suivre la chaîne de confiance
dig example.com +dnssec +trace
----

=== 📌 Remarque

Le flag `ad` (Authenticated Data) n'apparaît que si le serveur DNS effectue la validation DNSSEC et que la signature est valide de bout en bout. (Du trust anchor au KSK de la zone)

=== 🔹 Outils en ligne

- https://www.whatsmydns.net
- https://dnschecker.org

[.small]
© 2025 *rridane* – [GitHub](https://github.com/rridane)
