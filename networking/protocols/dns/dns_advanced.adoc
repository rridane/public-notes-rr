:author-url: https://github.com/rridane
:source-highlighter: rouge
:hardbreaks:
:table-caption!:
:toc: left

= DNS Advanced

== Emails et enregistrements txt

=== Spf

==== Introduction & d√©finition

.enregistrement txt
[source, python]
----
@    IN    TXT "v=spf1 include:_spf.shop.example.com ~all"
----

v=spf1 : Indique la version de SPF, qui est SPF1 dans ce cas.
include:_spf.shop.example.com : Inclut les r√®gles SPF d√©finies pour le domaine _spf.shop.example.com. Cela signifie que les serveurs de messagerie autoris√©s pour shop.example.com peuvent aussi inclure ceux sp√©cifi√©s dans le domaine _spf.shop.example.com.
~all : Sp√©cifie une politique "SoftFail" pour les serveurs de messagerie qui ne correspondent pas √† aucun des crit√®res sp√©cifi√©s dans l'enregistrement. "SoftFail" signifie que la r√©ception du message est toujours autoris√©e, mais le message peut √™tre trait√© avec suspicion (par exemple, marqu√© comme potentiellement du spam).

SPF est utilis√© pour v√©rifier si l'exp√©diteur d'un email est autoris√© √† envoyer des emails au nom du domaine affich√© dans "l'adresse de". Cela se fait en comparant l'ip de l'exp√©diteur avec une liste d'adresses IP autoris√©es publi√©es dans un l'enregistrement DNS SPF du domaine exp√©diteur. Sans spf, n'importe qui pourrait envoyer un mail : from: contact@example.com.

==== M√©canismes SPF courants

[cols="1,3", options="header"]
|===
| M√©canisme | Description

| `ip4:x.x.x.x` / `ip6:...` | Autorise une adresse IP ou un bloc CIDR
| `include:domain.com` | Int√®gre les r√®gles SPF d‚Äôun autre domaine
| `a` | Autorise l‚ÄôIP de l‚Äôenregistrement A du domaine
| `mx` | Autorise l‚ÄôIP des enregistrements MX du domaine
| `exists:domain.com` | Autorise si la r√©solution DNS aboutit pour le domaine donn√©
| `all` | S‚Äôapplique √† toutes les IP restantes (utilis√© en fin de r√®gle)
|===

==== Modificateurs de r√©sultat

Chaque m√©canisme peut √™tre pr√©c√©d√© d‚Äôun modificateur pour indiquer son **niveau de confiance** :

[cols="1,2,2", options="header"]
|===
| Modificateur | Signification | R√©sultat attendu

| `+` (ou rien) | Autoris√© explicitement | `Pass`
| `~` | Autoris√© avec doute | `SoftFail` (souvent marqu√© comme spam)
| `-` | Refus explicite | `Fail` (le message peut √™tre rejet√©)
| `?` | Neutre | `Neutral` (aucune indication, le serveur d√©cide)
|===

==== SPF macro : exemple d√©crypt√©

[source,dns]
----
@ IN TXT "v=spf1 ip4:192.0.2.5 ip4:198.51.100.25 include:_spf.google.com include:mailgun.org a mx ~all"
----

==== D√©composition de cet enregistrement

[cols="1,4a", options="header"]
|===
| √âl√©ment | Signification

| `v=spf1`
| Indique la version de SPF. Toujours `v=spf1` (actuellement la seule version standardis√©e).

| `ip4:192.0.2.5`
| Autorise cette IP √† envoyer des e-mails pour ce domaine. Par exemple : le serveur d‚Äôenvoi maison ou h√©berg√©.

| `ip4:198.51.100.25`
| Autre IP autoris√©e. Cela peut √™tre un serveur SMTP secondaire, un outil d‚Äôautomatisation, etc.

| `include:_spf.google.com`
| Int√®gre les r√®gles SPF d√©finies par Google (Gmail, Google Workspace).
‚Üí Indispensable si on utilise Gmail pour envoyer des e-mails via ce domaine. Concr√®tement, ira chercher les ips autoris√©es par google dans l'enregistrement txt _spf.google.com, voici ce qui sera fait :
[source, bash]
----
‚ù≠ dig @1.1.1.1 _spf.google.com A +noall +answer TXT
;; Warning, extra type option
_spf.google.com.        230     IN      TXT     "v=spf1 include:_netblocks.google.com include:_netblocks2.google.com include:_netblocks3.google.com ~all"
~
‚ù≠ dig @1.1.1.1 _netblocks.google.com A +noall +answer TXT
;; Warning, extra type option
_netblocks.google.com.  29      IN      TXT     "v=spf1 ip4:66.102.0.0/21 ip4:66.249.80.0/20 ip4:72.14.192.0/18 ip4:74.125.0.0/16 ip4:108.177.8.0/21 ip4:173.194.0.0/16 ip4:209.85.128.0/17 ip4:216.58.192.0/19 ip4:216.239.32.0/19 ~all"

----

| `include:mailgun.org`
| Autorise Mailgun √† envoyer des e-mails pour ce domaine.
‚Üí Les serveurs SMTP utilis√©s par Mailgun seront valid√©s par cet include.

| `a`
| Autorise l‚Äôadresse IP li√©e √† l‚Äôenregistrement A du domaine (`example.com A x.x.x.x`) √† envoyer des e-mails.

| `mx`
| Autorise les IP des serveurs de messagerie d√©clar√©s en MX √† √©mettre des mails (utile pour des serveurs tout-en-un).

| `~all`
| SoftFail : toutes les autres IP **non list√©es** dans les m√©canismes pr√©c√©dents seront **accept√©es mais marqu√©es comme suspectes** (ex : en spam).
‚Üí C‚Äôest un mode souple de filtrage : pas de rejet brutal mais classification prudente.
|===

==== Exemple d√©taill√© : SPF vu c√¥t√© serveur de r√©ception

Supposons que :

* L‚Äôexp√©diteur envoie un mail depuis `contact@example.com`
* Le mail arrive chez `contact@example2.com`, h√©berg√© sur un serveur SMTP g√©r√© par `example2.com`
* L‚ÄôIP de l‚Äôexp√©diteur est `209.85.220.41` (l'une des IP SMTP de Google)

==== üîπ Enregistrement SPF du domaine `example.com`

[source,dns]
----
example.com. IN TXT "v=spf1 ip4:192.0.2.5 ip4:198.51.100.25 include:_spf.google.com include:mailgun.org a mx ~all"
----

==== üîç √âtapes c√¥t√© serveur de r√©ception

1. üßæ **Extraction du domaine exp√©diteur**

Le serveur destinataire lit l‚Äôadresse `MAIL FROM: <contact@example.com>`.
‚Üí Domaine = `example.com`

2. üì° **Requ√™te DNS pour l‚Äôenregistrement SPF**

Il interroge le DNS :

[source,bash]
----
dig TXT example.com
----

3. üß† **√âvaluation de chaque m√©canisme, dans l‚Äôordre**

Le serveur compare l‚Äô**IP de l‚Äôexp√©diteur** (`209.85.220.41`) avec chaque m√©canisme SPF :

[cols="1,3", options="header"]
|===
| M√©canisme | V√©rification
| `ip4:192.0.2.5` | ‚ùå Non correspondante
| `ip4:198.51.100.25` | ‚ùå Non correspondante
| `include:_spf.google.com` | ‚úîÔ∏è V√©rification n√©cessaire
|===

4. üîÑ **R√©solution r√©cursive du `include:`**

Le serveur interroge ensuite :

[source,bash]
----
dig TXT _spf.google.com
----

.Exemple de r√©ponse typique :
[source,dns]
----
_spf.google.com. IN TXT "v=spf1 ip4:209.85.128.0/17 include:_netblocks.google.com include:_netblocks2.google.com include:_netblocks3.google.com ~all"
----

Le serveur suit tous les `include:` imbriqu√©s, et compare l‚ÄôIP `209.85.220.41`.

‚úÖ Elle est dans la plage `209.85.128.0/17` ‚Üí **SPF = PASS**

5. üì® **Livraison du mail**

Au moins un m√©canisme a valid√© l‚ÄôIP : le r√©sultat SPF est `Pass`.
‚Üí Le mail est accept√© (ou marqu√© comme l√©gitime par le filtre anti-spam).

==== üîÅ Variante : envoi via Mailgun

Si le mail vient de l‚ÄôIP `159.135.224.50` (serveur Mailgun) :

1. Le serveur suit `include:mailgun.org`
2. Il interroge :

[source,bash]
----
dig TXT mailgun.org
----

.R√©ponse possible :
[source,dns]
----
mailgun.org. IN TXT "v=spf1 ip4:159.135.224.0/24 ip4:69.72.32.0/20 ~all"
----

‚úÖ L‚ÄôIP `159.135.224.50` est dans la plage autoris√©e ‚Üí **SPF = PASS**

==== üìå √Ä retenir sur `include:`

`include:domain.tld` signifie :
‚Üí *¬´ Va chercher l‚Äôenregistrement SPF de ce domaine, et applique ses r√®gles ici ¬ª*

[NOTE]
====
* Le serveur de r√©ception suit r√©cursivement les `include:` (maximum 10 niveaux, selon RFC)
* Si une IP est autoris√©e dans un `include`, le r√©sultat SPF est `Pass`
* Ce n‚Äôest **pas** une redirection SMTP, mais une inclusion logique des r√®gles
====

==== üî• Et si aucune r√®gle ne correspond ?

[cols="1,3", options="header"]
|===
| R√©sultat final | Interpr√©tation
| `~all` | Le mail passe, mais est marqu√© comme suspect
| `-all` | Le mail est rejet√© (ou marqu√© comme non conforme selon la politique du serveur)
| `?all` | Neutre, aucune recommandation
| (aucun SPF) | R√©sultat = `None`, confiance faible
|===

==== üõ†Ô∏è Outils de v√©rification recommand√©s

* https://www.kitterman.com/spf/validate.html
* https://mxtoolbox.com/spf.aspx
* https://toolbox.googleapps.com/apps/checkmx/

=== DKIM (DomainKeys Identified Mail)

DKIM permet √† un domaine d‚Äôassocier son nom √† un e-mail via une **signature num√©rique**, ajout√©e dans l‚Äôen-t√™te du message.
Le serveur de r√©ception utilise la **cl√© publique**, publi√©e dans un enregistrement DNS TXT du domaine exp√©diteur, pour v√©rifier cette signature.

Cela garantit que :

* Le message provient bien du domaine d√©clar√© (`From:`).
* Le message **n‚Äôa pas √©t√© modifi√©** depuis son envoi.

==== üîê Publication de la cl√© publique

La cl√© publique est publi√©e dans un enregistrement DNS de type TXT, avec un **nom construit comme suit** :

----
<s√©lecteur>._domainkey.<domaine>
----

.Enregistrement DNS DKIM (exemple)
[source,dns]
----
default._domainkey.example.com. IN TXT "v=DKIM1; k=rsa; p=MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQC4nE2U0pGJAx9lmQ82eVzI..."
----

[cols="1,4a", options="header"]
|===
| √âl√©ment | Description

| `default._domainkey.example.com.` | Nom de l‚Äôenregistrement.
* `default` est le **s√©lecteur DKIM**, choisi librement par l‚Äôexp√©diteur.
* Le s√©lecteur permet d‚Äôavoir **plusieurs cl√©s** actives en parall√®le (rotation, testing‚Ä¶).

| `IN TXT` | Type d‚Äôenregistrement DNS (texte)

| `v=DKIM1` | Version du protocole DKIM

| `k=rsa` | Algorithme de chiffrement utilis√© (RSA dans l‚Äô√©crasante majorit√© des cas)

| `p=...` | Cl√© publique en base64
|===

==== ‚úâÔ∏è O√π est stock√©e la signature ?

La signature DKIM est **ins√©r√©e directement dans l‚Äôen-t√™te du mail**, sous forme d‚Äôun champ :

[source]
----
DKIM-Signature: v=1; a=rsa-sha256; d=example.com; s=default;
 h=from:to:subject;
 bh=Z0K2...==;
 b=K8x8bRfw0NFJeT0pHQFb...==
----

[cols="1,4a", options="header"]
|===
| Champ | Explication

| `v=1` | Version de DKIM
| `a=rsa-sha256` | Algorithme utilis√© pour la signature
| `d=example.com` | Domaine signataire
| `s=default` | S√©lecteur DKIM utilis√©
| `h=...` | Liste des en-t√™tes inclus dans la signature
| `bh=...` | Hachage du corps du message
| `b=...` | Signature num√©rique (crypt√©e avec la cl√© priv√©e)
|===

==== üîÑ V√©rification c√¥t√© serveur de r√©ception

1. Le serveur lit l‚Äôen-t√™te `DKIM-Signature:`.
2. Il extrait :
* Le **s√©lecteur** (`s=default`)
* Le **domaine sign√©** (`d=example.com`)
3. Il construit une requ√™te DNS :

[source,bash]
----
dig TXT default._domainkey.example.com
----

4. Il r√©cup√®re la **cl√© publique** et **v√©rifie la signature** avec celle-ci.
5. Si la signature correspond aux en-t√™tes et au contenu :
‚Üí ‚úÖ DKIM = `pass`
‚Üí Sinon : ‚ùå `fail`

==== üîÅ Illustration du processus

[plantuml, dkim-verification, png]
----
title "V√©rification DKIM c√¥t√© serveur de r√©ception"
actor "Serveur destinataire" as S
database "DNS du domaine exp√©diteur" as DNS

S -> S: Lit l‚Äôen-t√™te DKIM-Signature
S -> DNS: Requ√™te TXT\n"default._domainkey.example.com"
DNS --> S: Renvoie la cl√© publique
S -> S: V√©rifie la signature avec la cl√©
S -> S: Marque DKIM = Pass / Fail
----

==== üìå Remarques importantes

* Le s√©lecteur `s=` permet √† un domaine d‚Äôavoir plusieurs cl√©s (ex: `default`, `selector1`, etc.)
* La signature est **g√©n√©r√©e par le serveur d‚Äôenvoi**, avec sa **cl√© priv√©e**
* La v√©rification repose sur la **cl√© publique publi√©e dans le DNS**
* Contrairement √† SPF, **DKIM survit au forwarding** (transferts, listes de diffusion), car la signature reste valable tant que le contenu n‚Äôest pas modifi√©
* DKIM est une **brique essentielle de DMARC**

==== üß™ Tester un enregistrement DKIM

[source,bash]
----
dig TXT default._domainkey.example.com
----

==== üìö Pour aller plus loin

* RFC 6376 (DKIM)
* https://dkimcore.org/tools/
* https://mxtoolbox.com/dkim.aspx

==== üß† Faut-il SPF si DKIM est en place ?

===== üîç Que garantit DKIM seul ?

[cols="1,4a", options="header"]
|===
| ‚úÖ | Le message a bien √©t√© sign√© avec la cl√© priv√©e du domaine (`d=...`)
| ‚úÖ | Le contenu (en-t√™tes + corps) n‚Äôa pas √©t√© modifi√© en chemin
| ‚úÖ | Le domaine peut prouver sa l√©gitimit√© via une cl√© publique publi√©e en DNS
| ‚ùå | Mais DKIM **ne dit rien sur l‚Äôadresse IP** de l‚Äôexp√©diteur
| ‚ùå | Et ne garantit pas que le domaine `From:` est bien celui du signataire si non align√©
|===

===== üõ†Ô∏è Exemple de sc√©nario probl√©matique

Un prestataire comme SendGrid signe tous les e-mails avec :

[source,text]
----
DKIM-Signature: d=sendgrid.net; ...
From: contact@example.com
----

‚Üí R√©sultat : DKIM = Pass, mais le domaine sign√© (`sendgrid.net`) **n‚Äôest pas align√© avec le domaine visible** (`example.com`).
‚Üí Sans SPF ni DMARC strict, ce message **peut sembler l√©gitime** alors qu‚Äôil est falsifiable.

===== ‚úÖ Recommandation

[NOTE]
====
üåü La meilleure pratique actuelle est d‚Äôutiliser :

* **SPF** : contr√¥le d‚Äôautorisation IP
* **DKIM** : preuve cryptographique du contenu
* **DMARC** : politique claire pour exiger un alignement

‚Üí Ces trois briques ensemble permettent une **authentification forte**, une **tra√ßabilit√©** claire, et une **protection contre le spoofing**.
====

=== DMARC (Domain-Based Message Authentication, Reporting, and Conformance)

dmarc est une norme de s√©curit√© email qui aide √† prot√©ger les domaines email contre le spoofing, le phishig et d'autres types d'abus.

.dmarc
[source, bash]
----
Ridane@htb[/htb]$ nslookup -type=txt _dmarc.inlanefreight.com

Non-authoritative answer:
_dmarc.inlanefreight.com	text = "v=DMARC1; p=reject; rua=mailto:master@inlanefreight.com; ruf=mailto:master@inlanefreight.com; fo=1;"
----

v=DMARC1 : Indique la version de DMARC utilis√©e. "DMARC1" est actuellement la seule version en usage.

p=reject : Sp√©cifie la politique DMARC appliqu√©e aux emails qui √©chouent aux v√©rifications DMARC. Dans ce cas, "reject" signifie que les emails qui ne passent pas la v√©rification seront rejet√©s par les serveurs de messagerie recevant l'email. C'est la politique la plus stricte, indiquant que le domaine prend au s√©rieux la s√©curit√© de son courrier √©lectronique.

rua=mailto:master@inlanefreight.com : D√©finit l'adresse √† laquelle les rapports d'agr√©gation DMARC doivent √™tre envoy√©s. Ces rapports fournissent un r√©sum√© des messages passant ou √©chouant les v√©rifications DMARC et sont destin√©s √† aider les administrateurs de domaines √† surveiller l'utilisation de leur domaine dans les emails.

ruf=mailto:master@inlanefreight.com : Indique l'adresse pour les rapports de forensic DMARC. Contrairement aux rapports d'agr√©gation, ces rapports sont envoy√©s en temps r√©el et contiennent des d√©tails sur les √©checs individuels DMARC, offrant ainsi des informations plus pr√©cises sur des tentatives d'abus sp√©cifiques.

fo=1 : Sp√©cifie les conditions sous lesquelles les rapports de forensic doivent √™tre g√©n√©r√©s. "1" signifie que les rapports sont g√©n√©r√©s pour chaque email qui √©choue √† la v√©rification DMARC. Cela garantit que l'administrateur re√ßoit des informations d√©taill√©es sur les √©checs, ce qui est utile pour diagnostiquer et r√©soudre les probl√®mes de s√©curit√© email.

[NOTE]
====
La **fonction principale** de l'enregistrement DMARC est de d√©finir une **politique explicite** (`p=none`, `quarantine`, `reject`) √† appliquer si les v√©rifications SPF et DKIM √©chouent.

Il exige √©galement un **alignement** entre le domaine du champ `From:` et celui utilis√© par SPF ou DKIM.

Le reporting (`rua`, `ruf`) est optionnel mais recommand√© pour surveiller l‚Äôusage de son domaine.
====

== üîê DNSSEC

DNSSEC (Domain Name System Security Extensions) s√©curise le DNS en garantissant **l'authenticit√©** et **l'int√©grit√©** des donn√©es via une cha√Æne de signatures cryptographiques hi√©rarchique.

En synth√®se, chaque zone contient deux cl√©s, KSK (Key Signing Key) et ZSK (Zone Signing Key). La KSK signe le couple KSK+ZSK (appel√© RRSet DNSKEY) pour chaque niveau cr√©ant l'enregistrement RRSig DNSKEY. On v√©rifie la KSK gr√¢ce au niveau pr√©c√©dent qui contient son hash (Enregistrement DS). La chaine de hash de KSK se poursuit jusqu'au niveau racine ou le hash de la KSK racine (DS racine) est stock√© en locale, emp√™chant de falsifier la chaine compl√®te. Ainsi, chaque niveau est en capacit√© de valider sa KSK et sa ZSK. La ZSK est ensuite utilis√©e pour signer les RSSet, pour cr√©er des enregistrements RRSig associ√©s (ex : RRSig A)

=== Concepts Fondamentaux

[cols="1,3", options="header"]
|===
| Terme
| D√©finition Technique

| RRset (Resource Record Set)
| Ensemble d'enregistrements DNS partageant le m√™me _name_, _type_ et _class_

| RRSIG (Resource Record Signature)
| Signature num√©rique d'un RRset sp√©cifique

| DNSKEY
| Cl√© publique de la zone (contient deux sous-types : KSK et ZSK)

| KSK (Key Signing Key)
| Cl√© de signature des cl√©s (signe les DNSKEY et NSEC/NSEC3)

| ZSK (Zone Signing Key)
| Cl√© de signature des donn√©es (signe les autres RRsets)

| DS (Delegation Signer)
| Empreinte cryptographique (hash) d'une DNSKEY KSK enfant
|===


----
## HASH de la KSK zone racine d√©tenue en local

# Zone racine

KSK (v√©rifiable en local par son hash)
ZSK
RSSIG DNSKEY (KSK+ZSK) sign√©e par KSK

RSSET A
RSSIG A sign√© par ZSK

DS com. (hash KSK zone com)

# Zone com.

KSK (v√©rifiable par zone racine)
ZSK
RSSIG DNSKEY (KSK+ZSK) sign√©e par KSK

RSSET A
RSSIG A sign√© par ZSK

DS cloudflare.com. (hash KSK zone cloudflare.com.)

# Zone cloudflare.com.

KSK (v√©rifiable par zone com.)
ZSK
RSSIG DNSKEY (KSK+ZSK) sign√©e par KSK

RSSET A
RSSIG A sign√© par ZSK
----

Autrement dit :

* On v√©rifie la KSK gr√¢ce au niveau pr√©c√©dent (simple hash), et cette chaine se poursuit jusqu'√† la d√©tention en local de la KSK de la zone racine, ce qui emp√™che de falsifier la totalit√© de la chaine.
* La KSK permets de v√©rifier le RSSIG DNSKEY (hash encrypt√© de ZSK + KSK √† l'aide de la KSK)
* Ce qui permets d'authentifier la ZSK en plus, en d√©cryptant et en comparant les hash
* Ce qui permets de v√©rifier la RSSIG A

== S√©curit√© des emails ++

Lorsque quelqu'un tente d'envoyer un mail, le serveur de r√©ception consulte l'enregistrement txt du domaine. Il consulte plus pr√©cis√©ment les informations d'authentification DKIM que le serveur a inclut, signant l'email avec une cl√© priv√©e sp√©cifique. Le serveur de r√©ception consulte l'enregistrement dns du serveur d'exp√©dition pour r√©cup√©rer la cl√© publique et ainsi v√©rifier que le message n'a pas √©t√© alt√©r√©.
Le serveur de r√©ception consulte √©galement la liste d'IP autoris√©s √† envoyer un email via l'enregistrement DNS SPF de l'exp√©diteur. Il utilise ces deux r√©sultats pour appliquer la politique d√©clar√©e dans l'enregistrement DMARC

En synth√®se:

* SPF:  v√©rifie si l'IP de l'exp√©diteur est autoris√©e par le domaine de l'exp√©diteur.
* DKIM :  v√©rifie la validit√© du contenu de l'email, en comparant les hash obtenue √† l'aide de l'en-t√™te de l'email.
* DMARC :  utilise les r√©sultats de SPF et DKIM pour appliquer la politique d√©finie dans son enregistrement (_dmarc.domain.com). Si l'email √©choue √† SPF ou DKIM et que la politique DMARC sp√©cifie p=reject, l'email est rejet√©.
* RSSIG & DNSKEY: Permette de v√©rifier l'authenticit√© d'un enregistrement DNS

== R√©plication des donn√©es

Lorsque l'authoritative serveur (donc le SOA) modifie un enregistrement de type A, il s'op√®re une copie vers les serveurs secondaires, c'est un m√©canisme interne au dns via des requ√™tes axfr (Asynchronous Full Transfer of Zone) ou IXFR (Incremental Transfer of Zone). Le processus induit un syst√®me de notification (DNS notify) vers les serveurs secondaires. L'objectif de ces notifications est d'inciter les serveurs secondaires √† initier un transfert de zone (axfr ou ixfr).

AXFR est utilis√© pour copier la totalit√© de la zone, c'est souvent utilis√© √† la premi√®re synchronisation.

IXFR permets un mise √† jour uniquement des derniers changements.

En r√®gle g√©n√©rale, on sp√©cifie les ips des serveurs qui ont le droit de faire un transfert de zone, de mani√®re explicite dans la configuration du serveur dns.

Pour autoriser un nouveau serveur DNS √† recevoir un transfert de zone, l'administrateur du serveur doit explicitement ajouter l'ip du serveur, et utilis√© ajouter des cl√©s TSIG pour l'authentification.

== S√©curit√©

=== TSIG

TSIG = Transaction Signature. C'est un protocole qui permets l'authentification des messages de transfert DNS √† l'aide de cl√©s secr√®tes partag√©es. Il est d√©finit dans la RFC 2845. Il s√©curise principalement les transfert de zones entre serveurs dns. Il peut √©galement ajouter une couche d'authentification dans les communications entre resolver et serveur dns dans le cadres des requ√™tes dns au sens plus large.

==== Exemple de configuration TSIG

===== Pr√©-requis

* Paquet `bind9` (ou `named`) install√© sur chaque serveur ;
* Horloge syst√®me synchronis√©e (NTP / chrony) ‚Äî TSIG rejette les messages trop d√©cal√©s ;
* Droits *root* ou *sudo* pour manipuler les fichiers de configuration et (re)d√©marrer `named`.

===== √âtape 1 : G√©n√©rer la cl√© TSIG

Cr√©ez la cl√© depuis **n‚Äôimporte** lequel des deux serveurs (elle sera copi√©e
sur l‚Äôautre par la suite). Le nom de la cl√© n‚Äôa pas d‚Äôimpact sur la zone : on
choisit `example-tsig` pour la lisibilit√© :

[source,bash]
----
cd /etc/bind/keys
sudo dnssec-keygen -a HMAC-SHA256 -b 256 -n HOST example-tsig
----

Cette commande produit deux fichiers :

* `Kexample-tsig.+165+<id>.key` : version ¬´ publique ¬ª (elle contient la cha√Æne
que nous allons copier / coller) ;
* `Kexample-tsig.+165+<id>.private` : version priv√©e (non utilis√©e par BIND
pour TSIG, mais √† conserver en lieu s√ªr).

Ouvrez le fichier `.key` ; il ressemble √† ceci :

[source]
----
example-tsig. IN KEY 512 3 165 YmFzZTY0RW5jb2RlZEtleQ==
----

La partie apr√®s *165* (`YmFzZTY0RW5jb2RlZEtleQ==`) est la cl√© Base64.

===== √âtape 2 : D√©clarer la cl√© dans *named.conf*

====== Sur le **master** (`ns1`)

Ajoutez (ou cr√©ez) le bloc `key` dans `/etc/bind/named.conf.tsig`, puis
mettez-le dans `named.conf` :

[source,bind]
----
key "example-tsig" {
    algorithm hmac-sha256;
    secret "YmFzZTY0RW5jb2RlZEtleQ==";
};
----

Inclure le fichier (s‚Äôil ne l‚Äôest pas d√©j√†) :

[source,bind]
----
include "/etc/bind/named.conf.tsig";
----

====== Sur le **slave** (`ns2`)

R√©p√©tez exactement le m√™me bloc `key` (la cha√Æne *secret* doit √™tre
**identique**) :

[source,bind]
----
key "example-tsig" {
    algorithm hmac-sha256;
    secret "YmFzZTY0RW5jb2RlZEtleQ==";
};
include "/etc/bind/named.conf.tsig";
----

===== √âtape 3 : Configurer la zone sur le **master**

Ajoutez ou modifiez la d√©finition de zone dans `/etc/bind/named.conf.local` :

[source,bind]
----
zone "example.com" IN {
    type master;
    file "/etc/bind/zones/db.example.com";
    allow-transfer { key "example-tsig"; };
    also-notify  { 192.0.2.20 key "example-tsig"; };
};
----

[cols="1,4",options="header"]
|===
| Directive | R√¥le
| `allow-transfer` | Refuse toute requ√™te AXFR / IXFR ne portant pas la bonne signature TSIG.
| `also-notify`    | Envoie une notification (*NOTIFY*) sign√©e au secondaire d√®s que le SOA change.
|===

===== √âtape 4 : Configurer la zone sur le **slave**

Dans `/etc/bind/named.conf.local` du secondaire :

[source,bind]
----
zone "example.com" IN {
    type slave;
    masters { 192.0.2.10 key "example-tsig"; };
    file "/var/cache/bind/slaves/db.example.com";
};
----

===== √âtape 5 : Recharger ou red√©marrer BIND

[source,bash]
----
# M√©thode sans coupure
sudo rndc reconfig

# Ou, si rndc n'est pas configur√©
sudo systemctl restart bind9
----

V√©rifiez qu‚Äôaucune erreur ne s‚Äôaffiche dans `/var/log/syslog` ou
`journalctl -eu bind9`.

===== √âtape 6 : Validation du transfert

====== 1. Depuis le **slave**

Demandez le transfert complet (AXFR) :

[source,bash]
----
dig @192.0.2.10 example.com AXFR \
    -y example-tsig:YmFzZTY0RW5jb2RlZEtleQ== \
    +tcp +nocookie
----

La r√©ponse doit contenir tous les enregistrements de zone et
*status: NOERROR*.

====== 2. Depuis n‚Äôimporte quel h√¥te non autoris√©

La requ√™te suivante doit √©chouer avec *REFUSED* ou *NOAUTH* :

[source,bash]
----
dig @192.0.2.10 example.com AXFR +tcp
----

===== D√©pannage rapide

[cols="1,4",options="header"]
|===
| Symptom | Cause probable / Correctif
| `TSIG BADKEY`  | Les deux serveurs n‚Äôutilisent pas la m√™me cha√Æne Base64 ou le m√™me nom de cl√©.
| `TSIG BADSIG`  | Mauvais algorithme ou corruption du message ; r√©g√©n√©rer la cl√©.
| `TSIG BADTIME` | D√©calage d‚Äôhorloge > 5 min ; v√©rifier NTP / chrony.
|===

==== R√©f√©rences

* RFC 2845 ‚Äî *Secret Key Transaction Signatures for DNS (TSIG)*
* `dnssec-keygen(8)` ‚Äî page de manuel
* *BIND Administrator Reference Manual* (ARM)

=== DoH et DoT

* DoH : Dns Over Https: Permets de crypter le traffic dns √† l'int√©rieur d'une communication https, une session https est au pr√©alable √©tablie entre le resolver et le serveur dns qui pr√©sente son certificat, les paquets sont ainsi crypt√©s via la cl√© partag√©e √©tablie √† l'issue du processus d'authentification.
* DoT : Dns Over TLS : Permets de crypter le traffic dns √† l'int√©rieur d'une communication tls. L'authentification se fait par le biais de certificats TLS, similaire aux certificats https. DoT est sp√©cifiquement con√ßu pour crypter les communications dns, il utilise le port d√©di√© 853, il peut √™tre consid√©re comme plus simple, il n'utilise pas le port 443 comme DoH, ainsi il permets de mieux segmenter les communications r√©seaux et d'identifier plus attentivement les communications dns. Il permets ainsi une distincition claire du traffic web.

__la s√©curisation des communications peut concerner le resolver avec le nameserver mais √©galement les nameservers entre eux__

==== Pratiques

Une minimisation des la longueur des zones aide √† limiter les donn√©es exploitables par un attaquant lors de la reconnaissance.

=== ACL

Il est recommand√© de mettre un contr√¥le d'acc√®s (ACL) et de s√©curiser les communications avec TSIG ou DNSSEC pour pr√©venir les modifications non autoris√©es.

.acl avec bind
[source, python]
----
acl "trusted" {
    192.0.2.0/24;       // R√©seau interne
    203.0.113.4;        // Serveur DNS secondaire sp√©cifique
};

acl "clients" {
    198.51.100.0/24;
};

options {
    directory "/var/named";
    recursion yes;   // Permet la r√©cursivit√© pour les requ√™tes DNS
    allow-query { clients; }; // Permet aux clients de faire des requ√™tes DNS

    allow-transfer { trusted; }; // Permet le transfert de zone aux serveurs "trusted"
    allow-recursion { trusted; }; // Permet la r√©cursivit√© seulement pour les "trusted"
};

zone "example.com" IN {
    type master;
    file "db.example.com";
    allow-query { any; }; // Cette zone peut √™tre requ√™t√©e par n'importe qui
    allow-transfer { none; }; // D√©sactive le transfert de zone pour cette zone sp√©cifique
};

# Dans cet exemple, on d√©finit comme appartenant au groupe "trusted" (192.0.2.0/24) et un serveur secondaire sp√©cifique (203.0.113.4), et comme appartenant au groupe "clients" les machines du r√©seau 198.51.100.0/24. On d√©finit ensuites les politiques de ces deux groupes dans le dossier /var/name. (on pr√©cise que la r√©cursion est activ√©e). clients a le droit de faire des requ√™tes (allow-query), tandis que trusted a le droit de faire du transfert de zone, et on pr√©cise que la recursion n'est autoris√©e que pour les trusted.

# Enfin on pr√©cise que la zone example.com a sa propre politique de s√©curit√© concernant les query et le transfert, le transfert n'est pas autoris√©, et tout le monde peut faire une requ√™te.

----

== Gestion avanc√© du cache

La gestion efficace du cache DNS repose sur la d√©finition strat√©gique des valeurs TTL (Time To Live) pour les enregistrements DNS. Des TTL courts permettent des mises √† jour plus rapides dans la propagation des changements DNS, mais augmentent la charge sur les serveurs DNS. Des TTL longs r√©duisent la fr√©quence des requ√™tes au serveur DNS mais peuvent retarder la propagation des mises √† jour.

Meilleures pratiques :

√âquilibrage : Utilisez des TTL courts pour les enregistrements susceptibles de changer fr√©quemment, et des TTL longs pour ceux qui sont relativement statiques.
Surveillance : Impl√©mentez des outils de surveillance DNS pour analyser l'efficacit√© du cache et ajuster les TTL en cons√©quence.
Validation : Assurez-vous que les serveurs DNS respectent les valeurs TTL sp√©cifi√©es, √©vitant ainsi le cache excessif ou insuffisant.

== DNS Anycast

DNS Anycast permet √† plusieurs serveurs DNS de r√©pondre √† la m√™me adresse IP. Les routeurs dirigent les requ√™tes DNS vers le serveur le plus proche g√©ographiquement, r√©duisant ainsi la latence.

Impl√©mentation :

R√©seau global : D√©ployez des instances DNS dans plusieurs centres de donn√©es √† travers le monde.
Configuration r√©seau : Configurez le routage Anycast au niveau de vos fournisseurs de transit et de vos points d'√©change Internet (IXP).
Redondance : Assurez-vous que chaque instance DNS est capable de g√©rer ind√©pendamment les requ√™tes, pour garantir la disponibilit√©.
Compatibilit√© et Transition vers IPv6
Enjeux : La transition vers IPv6 n√©cessite que les serveurs DNS puissent g√©rer les enregistrements AAAA, qui pointent vers des adresses IPv6.

Strat√©gies :

Dual-stack : Configurez vos serveurs DNS pour qu'ils fonctionnent en mode dual-stack, acceptant √† la fois les connexions IPv4 et IPv6.
Enregistrements AAAA : Ajoutez des enregistrements AAAA pour tous les domaines et sous-domaines, parall√®lement aux enregistrements A existants.
Test : V√©rifiez la compatibilit√© IPv6 de votre infrastructure DNS en utilisant des outils de test en ligne.

== DNS et Cloud

Options :

AWS Route 53 : Offre une haute disponibilit√© et un service DNS scalable avec des fonctionnalit√©s avanc√©es comme la gestion du trafic bas√©e sur la sant√© des ressources.
Google Cloud DNS : Propose une infrastructure DNS globale et rapide, int√©gr√©e avec d'autres services Google Cloud.
Azure DNS : Int√®gre des services DNS dans l'√©cosyst√®me Azure, permettant une gestion unifi√©e des ressources cloud et DNS.


== üåê Configuration Compl√®te BIND avec DNSSEC

=== Arborescence des Fichiers

[source,text]
----
/etc/bind/
‚îú‚îÄ‚îÄ named.conf                     # Configuration principale
‚îú‚îÄ‚îÄ keys/                          # R√©pertoire s√©curis√© pour les cl√©s
‚îÇ   ‚îú‚îÄ‚îÄ K.root.+008+12345.key      # DNSKEY publique racine (trust anchor)
‚îÇ   ‚îú‚îÄ‚îÄ K.root.+008+12345.private  # Cl√© priv√©e KSK racine üîê
‚îÇ   ‚îú‚îÄ‚îÄ K.root.+008+67890.key      # DNSKEY publique ZSK racine
‚îÇ   ‚îú‚îÄ‚îÄ K.root.+008+67890.private  # Cl√© priv√©e ZSK racine üîê
‚îÇ   ‚îú‚îÄ‚îÄ K.com.+013+19718.key       # DNSKEY publique KSK .com
‚îÇ   ‚îú‚îÄ‚îÄ K.com.+013+19718.private   # Cl√© priv√©e KSK .com üîê
‚îÇ   ‚îú‚îÄ‚îÄ K.com.+013+54321.key       # DNSKEY publique ZSK .com
‚îÇ   ‚îú‚îÄ‚îÄ K.com.+013+54321.private   # Cl√© priv√©e ZSK .com üîê
‚îÇ   ‚îú‚îÄ‚îÄ K.cloudflare.+013+34505.key # DNSKEY publique KSK cloudflare
‚îÇ   ‚îú‚îÄ‚îÄ K.cloudflare.+013+34505.private # Cl√© priv√©e KSK cloudflare üîê
‚îÇ   ‚îú‚îÄ‚îÄ K.cloudflare.+013+67890.key # DNSKEY publique ZSK cloudflare
‚îÇ   ‚îî‚îÄ‚îÄ K.cloudflare.+013+67890.private # Cl√© priv√©e ZSK cloudflare üîê
‚îú‚îÄ‚îÄ zones/
‚îÇ   ‚îú‚îÄ‚îÄ db.root                    # Zone racine (.)
‚îÇ   ‚îú‚îÄ‚îÄ db.com                     # Zone TLD (.com)
‚îÇ   ‚îî‚îÄ‚îÄ db.cloudflare.com          # Zone domaine (cloudflare.com)
----

=== üîß 1. `named.conf` - Configuration Principale

[source,bind]
----
options {
    directory "/etc/bind";
    dnssec-enable yes;              # Activation globale DNSSEC
    dnssec-validation yes;          # Validation r√©cursive DNSSEC
    bindkeys-file "/etc/bind/keys/bind.keys"; # Fichier trust anchors

    # Configuration DNSSEC avanc√©e
    dnssec-lookaside auto;          # Utilisation DLV (si n√©cessaire)
    dnssec-must-be-secure "." yes;  # Exiger validation pour la racine
};

// ZONE RACINE
zone "." {
    type master;
    file "zones/db.root";
    key-directory "/etc/bind/keys"; # R√©pertoire des cl√©s
    auto-dnssec maintain;           # Gestion automatique signatures
    inline-signing yes;             # Signatures en temps r√©el
};

// ZONE TLD (.com)
zone "com." {
    type master;
    file "zones/db.com";
    key-directory "/etc/bind/keys";
    auto-dnssec maintain;
    inline-signing yes;
};

// ZONE DOMAINE
zone "cloudflare.com." {
    type master;
    file "zones/db.cloudflare.com";
    key-directory "/etc/bind/keys";
    auto-dnssec maintain;
    inline-signing yes;
};
----

==== üîç Explications :
- `key-directory` : R√©pertoire contenant √† la fois les cl√©s publiques (.key) et priv√©es (.private)
- `auto-dnssec maintain` : BIND signe automatiquement la zone avec les cl√©s disponibles
- `inline-signing` : G√©n√©ration dynamique des signatures sans modifier le fichier de zone original

=== üåê 2. `/etc/bind/zones/db.root` - Zone Racine (.) avec cl√©s PUBLIQUES

[source,bind]
----
$TTL 3600
@ IN SOA  root.dns. admin.dns. (
    2025070101 ; Serial (AAAAMMJJNN)
    10800      ; Refresh (3h)
    3600       ; Retry (1h)
    2592000    ; Expire (30j)
    3600       ; Minimum TTL (1h)
)

; SERVERS RACINE
. IN NS a.root-servers.net.
a.root-servers.net. IN A 198.41.0.4

; === ENREGISTREMENTS DNSSEC ===

; -- DNSKEY PUBLIQUE RACINE (KSK) --
@ IN DNSKEY 257 3 8 (
    AwEAAagAIKlVZrpC6Ia7gEzahOR+9W29euxhJhVVLOyQ...
) ; id = 12345 (KSK)

; -- DNSKEY PUBLIQUE RACINE (ZSK) --
@ IN DNSKEY 256 3 8 (
    AwEAAbcd123456...
) ; id = 67890 (ZSK)

; -- RRSIG DNSKEY (sign√©e par KSK priv√©e) --
@ IN RRSIG DNSKEY 8 0 3600 (
    20250801000000 ; Expiration
    20250701000000 ; D√©but validit√©
    12345          ; Key tag KSK
    .
    FAKE-SIGNATURE==
)

; -- DS pour .com (hash de la KSK publique de .com) --
com. IN DS 19718 13 2 (
    E4F1A2B38CFBD55AB4FE3C739F785842B9C2EDC1DA92...
) ; Algo 13 (ECDSA), Digest Type 2 (SHA-256)

; -- RRSIG DS (sign√©e par ZSK priv√©e) --
com. IN RRSIG DS 8 1 86400 (
    20250801000000
    20250701000000
    67890          ; Key tag ZSK
    .
    FAKE-SIGNATURE==
)
----

==== üîí Fichier de cl√© priv√©e associ√©e : `/etc/bind/keys/K.root.+008+12345.private`
[source,text]
----
Private-key-format: v1.3
Algorithm: 8 (RSASHA256)
Modulus: AQOgx... (base64)
PublicExponent: AQAB
PrivateExponent: MIGHAgE... (base64)
Prime1: 7ZvR...
Prime2: 6Uw9...
Exponent1: 5l0x...
Exponent2: 4k4c...
Coefficient: 1k3b...
----

=== üåê 3. `/etc/bind/zones/db.com` - Zone .com avec cl√©s PUBLIQUES

[source,bind]
----
$TTL 3600
@ IN SOA ns1.com. admin.com. (
    2025070101
    7200
    3600
    1209600
    3600
)

; SERVERS TLD
com. IN NS ns1.com.
ns1.com. IN A 192.5.6.30

; === ENREGISTREMENTS DNSSEC ===

; -- DNSKEY PUBLIQUE KSK .com (algo 13) --
@ IN DNSKEY 257 3 13 (
    AwEAAZ0pD5r+9k/3VJbV4R7zJ2mG...
) ; id = 19718

; -- DNSKEY PUBLIQUE ZSK .com --
@ IN DNSKEY 256 3 13 (
    AwEAAd1Xv5rX3Y6Z6A7...
) ; id = 54321

; -- RRSIG DNSKEY (sign√©e par KSK priv√©e) --
@ IN RRSIG DNSKEY 13 1 3600 (
    20250801000000
    20250701000000
    19718
    com.
    FAKE-SIGNATURE==
)

; -- DS pour cloudflare.com (hash de la KSK publique cloudflare) --
cloudflare.com. IN DS 34505 13 2 (
    9A8D7B2E9E1C37F6D2AC7A9270B0F3F8912C5827AE51...
)

; -- RRSIG DS (sign√©e par ZSK priv√©e .com) --
cloudflare.com. IN RRSIG DS 13 2 86400 (
    20250801000000
    20250701000000
    54321
    com.
    FAKE-SIGNATURE==
)
----

==== üîí Fichier de cl√© priv√©e associ√©e : `/etc/bind/keys/K.com.+013+19718.private`
[source,text]
----
Private-key-format: v1.3
Algorithm: 13 (ECDSAP256SHA256)
PrivateKey: MIGHAgEAMBMGByqGSM49AgEGCCqGSM49AwEHBG0wawIBAQQgZ0lHk8gHkz0a...
----

=== üåê 4. `/etc/bind/zones/db.cloudflare.com` - Zone Domaine avec cl√©s PUBLIQUES

[source,bind]
----
$TTL 300
@ IN SOA ns1.cloudflare.com. admin.cloudflare.com. (
    2025070101
    3600
    1800
    604800
    300
)

; SERVERS DOMAINE
@ IN NS ns1.cloudflare.com.
ns1 IN A 104.16.134.229

; === ENREGISTREMENTS DNSSEC ===

; -- DNSKEY PUBLIQUE KSK cloudflare.com --
@ IN DNSKEY 257 3 13 (
    AwEAAZ0pD5r+9k/3VJbV4R7zJ2mG...
) ; id = 34505

; -- DNSKEY PUBLIQUE ZSK cloudflare.com --
@ IN DNSKEY 256 3 13 (
    AwEAAd1Xv5rX3Y6Z6A7...
) ; id = 67890

; -- RRSIG DNSKEY (sign√©e par KSK priv√©e) --
@ IN RRSIG DNSKEY 13 2 3600 (
    20250801000000
    20250701000000
    34505
    cloudflare.com.
    FAKE-SIGNATURE==
)

; === DONN√âES UTILES ===
www IN A 104.16.132.229
www IN A 104.16.133.229

; -- Signature RRset A (sign√©e par ZSK priv√©e) --
www IN RRSIG A 13 3 300 (
    20250710000000  ; TTL court pour rotation fr√©quente
    20250701000000
    67890           ; Key tag ZSK
    cloudflare.com.
    FAKE-SIGNATURE==
)
----

==== üîí Fichier de cl√© priv√©e associ√©e : `/etc/bind/keys/K.cloudflare.+013+67890.private`
[source,text]
----
Private-key-format: v1.3
Algorithm: 13 (ECDSAP256SHA256)
PrivateKey: MIGHAgEAMBMGByqGSM49AgEGCCqGSM49AwEHBG0wawIBAQQgZ0lHk8gHkz0a...
----

¬© 2025 *rridane* ‚Äì [GitHub](https://github.com/rridane)
