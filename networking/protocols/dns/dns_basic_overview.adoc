= Comprendre le syst√®me DNS
:icons: font
:source-highlighter: highlightjs
:toc: left

== Domaines et hi√©rarchies des domaines

.www.example.com
[.text-center]
[plantuml, namespace-structure, png]
----
left to right direction
rectangle "Root" as root
rectangle "TLD (.com)" as tld
rectangle "Second Level (.example)" as second
rectangle "Third Level (www)" as third
rectangle "..." as next

root --> tld
tld --> second
second --> third
third --> next
----

[NOTE]
====
La r√©solution se lit de droite √† gauche et le premier dernier point (tout √† droite) est appel√© domaine racine
.com est appel√© TLD ou Top Level Domain., on trouve ensuite le second level etc..
On peut lire en quelques sortes l'adresse par ".www .example .com ."
====

[NOTE]
====
üîπ La combinaison du **TLD + Second Level** est appel√©e **Zone Apex** ou *Naked Domain* : `example.com`

üîπ Elle correspond g√©n√©ralement au domaine enregistr√© chez un registrar.
====

[NOTE]
====
üåê La totalit√© est appel√©e le **FQDN (Fully Qualified Domain Name)** : `www.example.com.`

üß© Ce nom inclut **tous les niveaux** jusqu‚Äô√† la racine `.`
====

[NOTE]
====
üåê La composition de 1 √† x domaines cr√©√© une zone
====

== Zones DNS

=== Comprendre la notion de Zone DNS

Une **zone DNS** est une **cl√©** utilis√©e dans un serveur **autoritaire** (qui devient autoritaire pour cette zone plus pr√©cis√©ment, nous y viendrons) pour enregistrer et retrouver un ensemble d‚Äôenregistrements DNS (`A`, `AAAA`, `MX`, `TXT`, `CNAME`, etc.) (Nous viendrons √©galement √† ces enregistrements).

La structure du DNS repose enti√®rement sur cette logique de **cl√©s hi√©rarchiques**.
Chaque requ√™te DNS consiste √† **naviguer de zone en zone**, c‚Äôest-√†-dire **de cl√© en cl√©**, en suivant les **enregistrements `NS`** jusqu‚Äô√† atteindre la zone finale autoritaire.

Cette "cl√©" correspond √† un **nom de domaine**, g√©n√©ralement une **composition d‚Äôun TLD + un ou plusieurs niveaux suivants**, par exemple :
‚Äì `example.com`
‚Äì `sub.dept.univ.edu`

Elle agit comme un **point d‚Äôancrage** dans le serveur : tous les enregistrements associ√©s √† cette zone sont g√©r√©s localement, **tant qu‚Äôaucune d√©l√©gation `NS` n‚Äôest faite**. On appelle d√©l√©gation NS la pr√©sence d'un enregistrement NS pour une "sous zone" de cette zone. Il faut comprendre: "Pour la sous zone xxx va voir nameserver (NS), il est possible qu'il contiennent les enregistrements, ou il saura te rediriger"

=== Enregistrements DNS (Zone File)

Une **zone DNS** ne se limite pas √† un simple nom : elle est associ√©e √† un **fichier de zone** (zone file), qui **d√©finit tous les enregistrements DNS** que le serveur doit conna√Ætre pour cette zone.

Chaque **cl√©** (nom de domaine) correspond √† une **entr√©e** dans ce fichier, qui sp√©cifie :

* Son **type d‚Äôenregistrement** (`A`, `AAAA`, `MX`, `NS`, `SOA`, etc.)
* Sa **valeur** (adresse IP, serveur de mail, alias, etc.)
* Une **dur√©e de vie (TTL)** ‚Äì Time To Live ‚Äì indiquant combien de temps l‚Äôinformation peut √™tre mise en cache.

Ce fichier est la **sp√©cification compl√®te de la zone**. Le serveur autoritaire l‚Äôutilise pour r√©pondre aux requ√™tes sur les noms contenus dans cette zone.

==== Extrait simplifi√© d‚Äôun fichier de zone `example.com`

[source,dns]
----
$TTL 3600
@       IN SOA  ns1.example.com. admin.example.com. ( ... )
        IN NS   ns1.example.com.
        IN NS   ns2.example.com.
@       IN A    192.0.2.1
www     IN A    192.0.2.2
mail    IN MX   10 mail.example.com.
----

Chaque ligne repr√©sente un **enregistrement DNS** associ√© √† la zone `example.com`.

Nous allons maintenant d√©tailler les principaux types d‚Äôenregistrements que l‚Äôon peut trouver dans une zone DNS.

== Types d‚Äôenregistrements DNS

Chaque **enregistrement DNS** indique une information pr√©cise pour un nom de domaine donn√©.

Voici les principaux types d‚Äôenregistrements, organis√©s par usage :

=== üîπ Enregistrements de r√©solution (vers une adresse IP)

[cols="1,3", options="header"]
|===
| Type | Description
| A    | Associe un nom de domaine √† une adresse IPv4 (ex: `192.0.2.1`)
| AAAA | Associe un nom de domaine √† une adresse IPv6 (ex: `2001:db8::1`)
| CNAME | D√©clare un alias : ce nom pointe vers un **autre nom de domaine**
‚û°Ô∏è Utilis√© pour rediriger un nom vers un autre (ex : `blog.example.com` vers `example.com`)
| DNAME | Comme CNAME mais pour **tous les sous-domaines**
‚û°Ô∏è Ex : tous les `*.legacy.example.com` pointent vers `*.newdomain.com`
|===

=== üîπ Enregistrements de messagerie

[cols="1,3", options="header"]
|===
| Type | Description
| MX   | Sp√©cifie le serveur de mail (Mail eXchanger) pour un domaine
‚û°Ô∏è Peut contenir une **priorit√©** : plus elle est basse, plus le serveur est pr√©f√©r√©
| SPF  | Ancien format d‚Äôauthentification des mails (d√©pr√©ci√©, remplac√© par TXT)
| TXT  | Texte libre ‚Äî utilis√© notamment pour :
‚Üí V√©rification de domaine (Google, Office 365‚Ä¶) (Voir pr√©sentation technique)
‚Üí SPF moderne (protection anti-spam) (Voir pr√©sentation technique)
‚Üí DKIM, DMARC (authentification des mails) (Voir pr√©sentation technique)
|===

=== üîπ Enregistrements de d√©l√©gation

[cols="1,3", options="header"]
|===
| Type | Description
| NS   | Indique le ou les serveurs faisant autorit√© pour une **zone donn√©e**
‚û°Ô∏è Cl√© essentielle pour la **d√©l√©gation DNS**
| SOA  | Start of Authority : en-t√™te obligatoire d‚Äôune zone
‚Üí Donne des m√©tadonn√©es sur la zone :
‚Äì Le serveur ma√Ætre
‚Äì L‚Äôadresse email de l‚Äôadministrateur
‚Äì Le num√©ro de version (serial)
‚Äì Les param√®tres de rafra√Æchissement / TTL
|===

=== üîπ Enregistrements de s√©curit√©

Voir section technique pour plus de pr√©cisions

[cols="1,3", options="header"]
|===
| Type | Description
| DNSKEY | Contient une cl√© publique utilis√©e pour **signer les enregistrements DNS** (dans le cadre de DNSSEC)
| RRSIG  | Signature cryptographique d‚Äôun enregistrement DNS (utilis√© avec DNSKEY)
| DS     | Delegation Signer : permet de **valider la d√©l√©gation s√©curis√©e** vers une sous-zone
| NSEC / NSEC3 | Prouvent qu‚Äôun enregistrement **n‚Äôexiste pas** (DNSSEC)
| CDS / CDNSKEY | Versions ¬´ enfant ¬ª des enregistrements DS / DNSKEY (utilis√©s pour la mise √† jour des cl√©s via les enfants)
|===

==== üîπ Enregistrements sp√©cifiques ou peu courants

[cols="1,3", options="header"]
|===
| Type | Description
| PTR   | Pointeur utilis√© pour la r√©solution **inverse** (IP ‚Üí nom de domaine)
‚û°Ô∏è Exemple : `1.2.0.192.in-addr.arpa ‚Üí example.com`
| SRV   | Indique un **service r√©seau** disponible pour un domaine (port, protocole, priorit√©‚Ä¶)
‚û°Ô∏è Exemple : `_sip._tcp.example.com`
| CAA   | Indique quelles **autorit√©s de certification** sont autoris√©es √† √©mettre des certificats pour le domaine
| HINFO | Fournit des informations sur le **mat√©riel** et le **syst√®me d‚Äôexploitation**
| AFSDB | Utilis√© avec le syst√®me de fichiers distribu√© AFS (rare)
| RP    | Indique une **adresse e-mail de contact** pour un domaine
| LOC   | Donne une position g√©ographique (latitude/longitude) d‚Äôun h√¥te
| NAPTR | Utilis√© pour la r√©√©criture de noms, notamment dans VoIP ou ENUM
| SSHFP | Contient l‚Äôempreinte de cl√© SSH d‚Äôun serveur ‚Äî pour v√©rification sans `known_hosts`
|===

[NOTE]
====
üìå Chaque enregistrement est d√©fini **pour un nom de domaine** donn√©, dans une **zone DNS** sp√©cifique.
‚û°Ô∏è Si la zone est `example.com`, on pourra avoir des enregistrements comme :

- `www.example.com. IN A 192.0.2.1`
- `mail.example.com. IN MX 10 mailserver.example.com.`
- `example.com. IN SOA ...`
====

[NOTE]
====
Le champ IN dans les enregistrements DNS signifie "Internet". C'est une abbr√©viation de class IN. Il indique la classe du protocole. Historique il y avait CH pour chaos, ou HS pour Hesiod, mais ces deux protocoles classes ne sont plus uitlis√©es.
====

[NOTE]
====
On peut lire les enregistrements de la mani√®re suivante :

- `www.example.com. IN A 192.0.2.1` => `www.example.com. dispose d'un enregistrement INternet de type A, sa valeur est 192.0.2.1`
- `mail.example.com. IN MX 10 mailserver.example.com.` => `mail.example.com. dispose d'un enregistrement INternet de type MX, de priorit√© 10, sa valeur est mailserver.example.com.`
====

== Architecture de la r√©solution DNS

=== R√©solution DNS : it√©rative vs r√©cursive

Il existe deux modes de r√©solution DNS, d√©finis par le **flag `RD` (Recursion Desired)** dans l‚Äôen-t√™te DNS de la requ√™te :

* `RD = 1` ‚Üí le client demande une **r√©solution r√©cursive compl√®te**
* `RD = 0` ‚Üí le client demande une **r√©solution it√©rative**

==== üîÅ R√©solution r√©cursive (mode courant)

- Le client d√©l√®gue la r√©solution compl√®te au **r√©solveur DNS** (ex : `1.1.1.1`, `8.8.8.8`)
- Le r√©solveur interroge successivement les serveurs racine, TLD, puis autoritaires
- Il renvoie directement la **r√©ponse finale (IP)** au client
- C‚Äôest le mode utilis√© dans **la majorit√© des cas** (navigateurs, OS, etc.)

==== üîÇ R√©solution it√©rative (mode avanc√©)

- Le client interroge lui-m√™me les serveurs DNS **√©tape par √©tape**
- Chaque serveur r√©pond avec une **r√©f√©rence (`NS`) vers la zone suivante**
- Le client continue jusqu'√† obtenir la r√©ponse finale

==== üß† Qui utilise quoi ?

[cols="2*", options="header"]
|===
| Cas d'usage                       | Type de r√©solution
| Navigateur ou OS grand public    | R√©cursive (`RD=1`)
| R√©solveur DNS interrogeant la racine | It√©rative (`RD=0`)
| Serveurs racine / TLD            | Ne font **jamais** de r√©cursif ; r√©pondent **en it√©ratif uniquement**
|===

==== üì¶ R√©ponse du serveur

Dans la r√©ponse DNS, le serveur peut indiquer s‚Äôil **accepte ou non la r√©cursion** :

* `RA = 1` ‚Üí Recursion Available (le serveur sait faire du r√©cursif)
* `RA = 0` ‚Üí Ce serveur ne g√®re **que de l‚Äôit√©ratif**

[NOTE]
====
üìå Le **mode de r√©solution** est d√©fini par le client (`RD=1` ou `RD=0`)
üìå Les **serveurs racine, TLD et autoritaires** ne font **jamais** de r√©cursif, m√™me si `RD=1` est activ√©
üìå Seuls les **r√©solveurs DNS** comme `1.1.1.1` ou `8.8.8.8` ex√©cutent une vraie r√©solution r√©cursive
====

== Processus de r√©solution macro

=== √âtape 1 : R√©solution locale (cache DNS ou /etc/hosts)

[.text-center]
[plantuml, dns-local-resolution, png]
----
actor "Client" as C
database "/etc/hosts\n+ cache DNS local" as Local

C --> Local : R√©solution www.example.com
Local --> C : R√©ponse (si trouv√©e)
----

=== √âtape 2 : R√©solution par le r√©solveur r√©cursif (r√©solution compl√®te)

[.text-center]
[plantuml, dns-resolution-deep, png]
----
actor "Client" as C
node "R√©solveur DNS R√©cursif (ex: 1.1.1.1)" as R
node "Root Server" as RS
node "TLD Server (.com)" as TLD
node "Authoritative NS (example.com)" as A

C --> R : Requ√™te www.example.com
R --> RS : "O√π est le TLD .com ?"
RS --> R : "Va voir TLD Server"
R --> TLD : "O√π est example.com ?"
TLD --> R : "Va voir le serveur A"
R --> A : "Quelle est l‚ÄôIP de www ?"
A --> R : "93.184.216.34"
R --> C : R√©ponse finale
----

[NOTE]
====
üß≠ **√âtapes internes d‚Äôun r√©solveur r√©cursif (ex : 1.1.1.1)**

1. üîç Il commence par v√©rifier son **cache DNS interne** : si la r√©ponse existe d√©j√† et que le ttl n'est pas expir√©, il la renvoie directement.
2. üåê Si la r√©ponse n‚Äôest pas en cache, il d√©marre une **r√©solution compl√®te**, de la racine jusqu‚Äôau serveur autoritaire.
- Il s‚Äôappuie sur un fichier `roothints` : une **liste des adresses IP des 13 serveurs racine** (`a.root-servers.net`, etc.)
- Il interroge un serveur racine pour conna√Ætre les `NS` du TLD concern√© (ex : `.com`)
- Puis il interroge les **serveurs du TLD** (`.com`) pour obtenir les `NS` de `example.com`
- Enfin, il interroge le **serveur autoritaire pour `example.com`** pour obtenir l‚ÄôIP de `www`

üìå √Ä chaque √©tape, les serveurs DNS r√©pondent avec des **enregistrements de d√©l√©gation (`NS`)**
Le r√©solveur suit cette **cha√Æne hi√©rarchique**, √©tape par √©tape, **jusqu‚Äô√† trouver la r√©ponse finale**.
====

==== üîπ Exemple 1 ‚Äì Une seule zone (`example.com`)

Tous les enregistrements sont g√©r√©s dans la m√™me zone, sans d√©l√©gation :

[source,dns]
----
; Zone : example.com
example.com.          IN A     192.0.2.1
www.example.com.      IN A     192.0.2.2
mail.example.com.     IN MX    10 mail.example.com.
----

Ici, les sous-domaines `www`, `mail`, etc. sont **inclus dans la zone `example.com`**, g√©r√©e par un **serveur autoritaire unique**.

==== üîπ Exemple 2 ‚Äì D√©l√©gation vers une autre zone (`blog.example.com`)

La zone `example.com` d√©l√®gue `blog.example.com` √† d'autres serveurs via un enregistrement `NS` :

[source,dns]
----
; Dans la zone parent : example.com
blog.example.com.     IN NS    ns1.blog.example.com.
                      IN NS    ns2.blog.example.com.

; Zone s√©par√©e : blog.example.com
@                     IN SOA   ns1.blog.example.com. admin.blog.example.com. (...)
                      IN NS    ns1.blog.example.com.
                      IN NS    ns2.blog.example.com.
@                     IN A     203.0.113.42
----

R√©sultat :
* `blog.example.com` devient une **zone DNS ind√©pendante**
* Elle est servie par ses propres serveurs (`ns1.blog.example.com`, etc.)
* La zone `example.com` **ne conna√Æt pas** les enregistrements internes de `blog.`, uniquement qu‚Äôelle l‚Äôa d√©l√©gu√©e

Une **zone DNS** est un segment de l‚Äôespace de noms DNS associ√© √† un **nom de domaine**, pour lequel un serveur d√©tient et publie des **enregistrements DNS officiels**. Nous y reviendrons mais c'est la pr√©sence d'un enregistrement SOA qui fait qu'un serveu est bien l'authoritative serveur pour une zone.

[NOTE]
====
Une **zone DNS** peut contenir :

1. Des **enregistrements finaux** (`A`, `AAAA`, `MX`, `TXT`, `CNAME`, etc.)
2. Des **d√©l√©gations** vers d'autres zones (via des enregistrements `NS`)
3. ‚úÖ Ou **les deux √† la fois**

Exemple : la zone `example.com` peut contenir les enregistrements pour `www.example.com` et d√©l√©guer `blog.example.com` √† une autre zone.
====

Par d√©faut, tous les sous-domaines sont inclus dans la zone, **tant qu‚Äôils n‚Äôont pas √©t√© explicitement d√©l√©gu√©s**.

== Processus de r√©solution d√©taill√©

=== √âtape 1 : Interrogation d‚Äôun serveur racine (zone ".")

==== üîπ Requ√™te DNS

QNAME = fr.blog.example.com.
QTYPE = A

==== üîπ R√©ponse DNS (troncature simplifi√©e)

[source,dns]
----
Authority Section:
com. IN NS a.gtld-servers.net.
com. IN NS b.gtld-servers.net.
...

Additional Section:
a.gtld-servers.net. IN A 192.5.6.30
b.gtld-servers.net. IN A 192.33.14.30
----

==== üîπ Zone racine : fichier conceptuel db.root

__le @ signifie toujours le nom de la zone, donc ici .__

Le fichier de zone racine contient les d√©l√©gations vers les TLD (Top-Level Domains) comme .com, .fr, .org, etc. Exemple :

[source,dns]
----
$TTL 3600000
@ IN SOA a.root-servers.net. hostmaster.root-servers.org. (
2025062701 ; Serial
1800       ; Refresh
900        ; Retry
604800     ; Expire
86400 )    ; Minimum TTL

@ IN NS a.root-servers.net.
@ IN NS b.root-servers.net.
@ IN NS c.root-servers.net.
...

com. IN NS a.gtld-servers.net.
fr.  IN NS f.nic.fr.

; Glue records pour les serveurs de TLD
a.gtld-servers.net. IN A 192.5.6.30
f.nic.fr.            IN A 192.134.0.49
----

üìå Ce fichier de zone est maintenu par l'IANA. Il ne contient aucune information sur les domaines de second niveau (ex: example.com).

üìå Les r√©solveurs n'interrogent pas la racine via ce fichier, mais via une liste appel√©e roothints qui contient les IP des serveurs racine (A √† M).

=== √âtape 2 : Interrogation du TLD .com

==== üîπ Requ√™te DNS

[source,dns]
----
QNAME = fr.blog.example.com.
QTYPE = A
----

==== üîπ R√©ponse DNS

[source,dns]
----
Authority Section:
blog.example.com. IN NS ns1.blog.example.com.
blog.example.com. IN NS ns2.blog.example.com.

Additional Section:
ns1.blog.example.com. IN A 203.0.113.10
ns2.blog.example.com. IN A 203.0.113.11
----


==== üîπ Fichier de zone : db.com (extrait)

[source,dns]
----
$TTL 3600
@ IN SOA a.gtld-servers.net. admin.gtld-servers.net. (
2025062701 ; Serial
3600       ; Refresh
1800       ; Retry
604800     ; Expire
86400 )    ; Minimum TTL

@ IN NS a.gtld-servers.net.
@ IN NS b.gtld-servers.net.

example.com. IN NS ns1.example.com.
example.com. IN NS ns2.example.com.
ns1.example.com. IN A 203.0.113.1
ns2.example.com. IN A 203.0.113.2

blog.example.com. IN NS ns1.blog.example.com.
blog.example.com. IN NS ns2.blog.example.com.
ns1.blog.example.com. IN A 203.0.113.10
ns2.blog.example.com. IN A 203.0.113.11
----


[NOTE]
====
üìå Bien que blog.example.com semble s√©mantiquement d√©pendre de example.com, dans cet exemple, il est directement d√©l√©gu√© au niveau de .com, au m√™me titre que example.com.

üìå En cons√©quence, la zone example.com ne conna√Æt rien de l‚Äôexistence ou du contenu de blog.example.com. Elle n‚Äôen est pas responsable, et ne pourra pas r√©pondre √† une requ√™te concernant blog.example.com.

üìå Cela est conforme au mod√®le DNS : n‚Äôimporte quelle sous-zone peut √™tre d√©l√©gu√©e ind√©pendamment √† n‚Äôimporte quel niveau, tant que la d√©l√©gation est d√©clar√©e dans la zone parente.
====

=== √âtape 3 : Interrogation de blog.example.com

==== üîπ Requ√™te DNS

[source,dns]
----
QNAME = fr.blog.example.com.
QTYPE = A
----

==== üîπ R√©ponse DNS

[source,dns]
----
Authority Section:
fr.blog.example.com. IN NS ns1.fr.blog.example.com.
fr.blog.example.com. IN NS ns2.fr.blog.example.com.

Additional Section:
ns1.fr.blog.example.com. IN A 198.51.100.42
ns2.fr.blog.example.com. IN A 198.51.100.43
----

==== üîπ Fichier de zone db.blog.example.com

[source,dns]
----
$TTL 3600
@ IN SOA ns1.blog.example.com. admin.blog.example.com. (
2025062601 ; Serial
3600       ; Refresh
1800       ; Retry
604800     ; Expire
86400 )    ; Minimum TTL

@ IN NS ns1.blog.example.com.
@ IN NS ns2.blog.example.com.

fr IN NS ns1.fr.blog.example.com.
fr IN NS ns2.fr.blog.example.com.
ns1.fr.blog.example.com. IN A 198.51.100.42
ns2.fr.blog.example.com. IN A 198.51.100.43
----

=== √âtape 4 : Interrogation du serveur final ns1.fr.blog.example.com

==== üîπ Requ√™te DNS

[source,dns]
----
QNAME = fr.blog.example.com.
QTYPE = A
----

==== üîπ R√©ponse DNS

[source,dns]
----
Answer Section:
fr.blog.example.com. IN A 192.0.2.99
----

==== üîπ Fichier de zone db.fr.blog.example.com

[source,dns]
----
----

=== üîö R√©solution compl√®te

Le serveur r√©cursif retourne l‚ÄôIP 192.0.2.99 au client. Mission accomplie üéØ.

Chaque serveur n‚Äôa r√©pondu que pour sa propre zone et a fourni les d√©l√©gations n√©cessaires (enregistrements NS + glue A).

== R√¥le et structure du domaine racine (Root Domain)

=== üîπ Fonction principale

* Le domaine racine (.) constitue le point d‚Äôentr√©e officiel de l‚Äôespace de noms DNS.
* Le serveur racine oriente la requ√™te DNS vers le bon serveur TLD (.com, .fr, etc.) (Il contient donc toutes les zones TLD)
* Il ne fournit pas de r√©ponse finale, mais transf√®re la r√©solution √† la zone suivante (TLD zone)
* Il est interrog√© uniquement par les r√©solveurs r√©cursifs (ex : 1.1.1.1, 8.8.8.8) lorsqu‚Äôaucune information pertinente n‚Äôest encore en cache

=== üîπ Nombre et structure

* La zone racine est servie par une infrastructure mondiale de serveurs dits ‚Äúracine‚Äù, √† la base de toute r√©solution hi√©rarchique.
* Il existe 13 serveurs racine r√©f√©renc√©s officiellement, nomm√©s de A √† M
* En r√©alit√©, ils sont une r√©plique d'un seul et unique serveur racine maitre, dit autoritaire pour la zone racine. Ce serveur est maintenu par l'IANA (ICANN).
* Ils sont g√©r√©s par diff√©rents organismes, coordonn√©s par l'ICANN

Chacun de ces 13 "serveurs racine" sont en r√©alit√© massivement r√©pliqu√©s (plus de 1 600 instances globales)

La r√©plication s‚Äôappuie sur la technologie anycast pour :
Assurer r√©silience (en cas de panne locale)
Offrir une faible latence (route vers l‚Äôinstance la plus proche)

=== üîπ Raison du chiffre 13

[NOTE]
--
üî¢ Le chiffre 13 n‚Äôest pas arbitraire : il vient d‚Äôune contrainte technique historique.

√Ä l‚Äôorigine, une r√©ponse DNS devait tenir dans 512 octets maximum (limite UDP DNS sans EDNS0).

‚û°Ô∏è La r√©ponse du serveur racine devait contenir :
‚Äì Les 13 enregistrements NS (A √† M)
‚Äì Les glue records (adresses IP associ√©es, A pour IPv4 et AAAA pour IPv6)
üí° Or, chaque serveur racine a un nom long (a.root-servers.net).
Dans les ann√©es 80 on int√©rrogeait r√©guli√®rement le serveur maitre de la zone racine (ce qui n'est plus le cas aujourd'hui), donc sa r√©ponse (liste des NS avec ips) devait tenir dans 512 octets.

Cette contrainte dictait donc la taille maximale de la liste de serveurs racine.
Depuis, cette limite a √©t√© lev√©e via EDNS0, mais la structure reste pour des raisons de compatibilit√©.
--

=== üîπ Contenu de la zone racine

    La zone racine ne contient que :
        Des enregistrements NS pour chaque TLD connu (.com, .fr, .org, etc.)
        Leurs glue records (adresses IP n√©cessaires √† la r√©solution)

Elle ne contient aucune information applicative (ex : pas d‚ÄôA ou MX pour example.com)

== Top Level Domains (TLD)

Les domaines de premier niveau (TLD) constituent la premi√®re division sous la racine dans la hi√©rarchie DNS.
Ils se r√©partissent en **deux grandes cat√©gories** :

[cols="2*", options="header"]
|===
| gTLD (g√©n√©riques)        | ccTLD (country codes)
| `.com`, `.org`, `.net`   | `.fr`, `.de`, `.jp`
| `.edu`, `.gov`, `.info`  | `.uk` (ex : `co.uk`)
|===

* Les **gTLD** sont √† vocation g√©n√©rale, souvent li√©s √† une activit√© (commerciale, gouvernementale‚Ä¶).
* Les **ccTLD** sont li√©s √† un pays ou un territoire, selon la norme [ISO 3166-1 alpha-2](https://fr.wikipedia.org/wiki/ISO_3166-1_alpha-2).
* Pour consulter la liste compl√®te des TLD g√©r√©s dans la racine DNS
üëâ https://www.iana.org/domains/root/db

== DNS autoritaire ou Authoritative DNS

Un **serveur DNS n‚Äôest pas ‚Äúautoritaire‚Äù par nature** : il l‚Äôest **uniquement pour les zones qu‚Äôil h√©berge localement**.

Autrement dit :
‚Äì Un m√™me serveur peut √™tre **autoritaire pour plusieurs zones** (ex : `.com`, `example.com`, `blog.example.com`)
‚Äì Et il peut **ne pas l‚Äô√™tre du tout** pour d‚Äôautres zones qu‚Äôil ne conna√Æt pas ou ne sert pas

[IMPORTANT]
====
üîπ Un **serveur est dit autoritaire** pour une zone s‚Äôil :

‚Äì D√©tient cette zone **en local** (fichier de zone, base de donn√©es, etc.)
‚Äì Peut **r√©pondre de mani√®re d√©finitive** √† des requ√™tes sur cette zone
‚Äì Ne r√©alise **aucune r√©solution r√©cursive**

üîπ Ce r√¥le est donc **relatif √† une zone donn√©e** : un serveur peut √™tre autoritaire pour `example.com` mais pas pour `google.com`.
====

La **structure hi√©rarchique des zones** et la **cha√Æne de d√©l√©gation via les enregistrements `NS`** sont ce qui permet √† l‚Äôensemble du DNS de fonctionner comme un arbre distribu√©, chaque serveur n‚Äô√©tant responsable que des zones qui lui sont explicitement attribu√©es.

== M√©canisme de cache DNS

Chaque r√©solveur DNS (notamment les serveurs r√©cursifs comme `1.1.1.1` ou `8.8.8.8`) met en place un **cache DNS**, pour am√©liorer drastiquement la rapidit√© des r√©ponses et r√©duire le trafic r√©seau inutile. Ce cache est bas√© sur le TTL (Time To Live).

=== üì¶ Fonctionnement du TTL (Time To Live)

Le champ TTL est une **dur√©e en secondes** qui d√©termine **combien de temps une r√©ponse DNS peut √™tre conserv√©e en cache**.

=== üîÅ M√©canisme de calcul

1. Lorsqu‚Äôun enregistrement DNS est re√ßu, il est accompagn√© d‚Äôun `TTL` (ex : `3600` secondes).
2. Le r√©solveur r√©cursif ou local le stocke en cache **avec un horodatage** (timestamp).
3. √Ä chaque nouvelle requ√™te :
- Il **calcule le temps √©coul√©** depuis la mise en cache.
- Il **soustrait ce temps √©coul√©** du TTL initial pour obtenir le **TTL restant**.
- Si le TTL restant > 0 ‚Üí ‚úÖ entr√©e encore valide, r√©ponse depuis le cache.
- Si le TTL ‚â§ 0 ‚Üí ‚ùå entr√©e expir√©e, nouvelle r√©solution DNS compl√®te.

==== üí° Remarques

- Le TTL **n‚Äôest pas d√©cr√©ment√© en temps r√©el** dans le cache (pas de minuterie active).
- Le serveur peut transmettre le **TTL restant** dans sa r√©ponse pour √©viter une surconservation c√¥t√© client.

=== üîÅ Cycle de vie d‚Äôune r√©solution avec cache

[.text-center]
[plantuml, dns-caching-full, png]
----
title "Cycle de vie du cache DNS (avec expiration TTL)"
start
:Requ√™te DNS;
if (Entr√©e en cache ?) then (Oui)
  if (TTL expir√© ?) then (Oui)
    :R√©solution compl√®te;
    :Stockage de la r√©ponse\navec son TTL;
  else (Non)
    :R√©ponse imm√©diate;
  endif
else (Non)
  :R√©solution compl√®te;
  :Stockage de la r√©ponse\navec son TTL;
endif
stop
----

==== üîé D√©tails importants

* **Cache DNS** = m√©moire temporaire des r√©ponses (positives ou n√©gatives)
* **TTL (Time To Live)** : dur√©e (en secondes) pendant laquelle une r√©ponse peut √™tre conserv√©e
- D√©finie dans le fichier de zone par l‚Äôadministrateur de la zone
* **Negative Caching** :
- M√™me les √©checs (nom inexistant) sont mis en cache pour une courte dur√©e
- √âvite de r√©p√©ter inutilement des r√©solutions vou√©es √† √©chouer
- Exemple d‚Äôentr√©e n√©gative : NXDOMAIN

==== üì¶ O√π le cache est-il utilis√© ?

[cols="2,4a", options="header"]
|===
| Niveau | D√©tails
| R√©solveur r√©cursif (ex: 1.1.1.1)
| Principal point de cache. Tous les serveurs comme Cloudflare, Google DNS, Quad9 conservent les r√©ponses (A, AAAA, CNAME, etc.) selon le TTL sp√©cifi√©. Ils sont optimis√©s pour cela.

| OS local (Windows, Linux, macOS)
| Certains syst√®mes conservent un **cache DNS local** (dans la RAM). Il peut √™tre vid√© ou interrog√©.
- **Windows** :
 +
[source,cmd]
----
ipconfig /displaydns  # Afficher le cache DNS
ipconfig /flushdns    # Vider le cache DNS
----
- **Linux** :
- Si un service comme `systemd-resolved` ou `nscd` est activ√©, ils g√®rent ce cache.
- Sinon, le syst√®me s‚Äôappuie uniquement sur le cache applicatif.
- Exemples :
 +
[source,bash]
----
systemd-resolve --statistics
sudo systemd-resolve --flush-caches
nscd -g
----

| Navigateurs web
| Les navigateurs comme Chrome, Firefox, Safari disposent **de leur propre cache DNS**, en plus de celui du syst√®me.
- Exemple pour Chrome :
 +
[source]
----
chrome://net-internals/#dns
----
- Ce cache est isol√© et peut parfois cr√©er des incoh√©rences (nom r√©solu dans Chrome mais pas dans un `curl` ou `dig`).
|===

==== üß† Pourquoi le cache est-il crucial ?

* R√©duction de la **latence** : moins de requ√™tes vers les serveurs racine, TLD, etc.
* Am√©lioration des **performances per√ßues**
* All√®gement de la **charge r√©seau** (surtout pour les grands r√©solveurs publics)
* Le TTL permet de contr√¥ler **le temps de propagation des modifications DNS**
- Exemple : baisser temporairement le TTL avant de changer l‚ÄôIP d‚Äôun domaine

==== üõë Attention

Le cache peut provoquer des **effets de bord** :
- Une entr√©e erron√©e peut persister plusieurs minutes/heures
- N√©cessit√© de forcer un vidage (`flush`) pour tester des mises √† jour

== Reverse Name Resolution

La r√©solution DNS inverse consiste √† retrouver un nom de domaine associ√© √† une adresse IP. Elle repose sur l‚Äôutilisation d‚Äôun enregistrement PTR dans une zone sp√©ciale : in-addr.arpa (IPv4) ou ip6.arpa (IPv6).

=== üîπ Transformation d'adresse

Pour interroger le DNS √† partir d‚Äôune adresse IP, on **inverse les octets** de l‚Äôadresse, puis on la suffixe avec `in-addr.arpa`.

Exemple :

[source,dns]
----
Adresse IP : 172.217.18.14
‚Üí Nom DNS : 14.18.217.172.in-addr.arpa.
----

Ce nom devient la **cl√© de requ√™te DNS** (QNAME) utilis√©e pour effectuer une r√©solution de type `PTR`.

=== üîπ Exemple de requ√™te DNS

[source,dns]
----
QNAME = 14.18.217.172.in-addr.arpa.
QTYPE = PTR
----

=== üîπ √âtapes de r√©solution (hi√©rarchique)

La r√©solution suit le m√™me mod√®le que la r√©solution directe, mais dans le domaine invers√© `in-addr.arpa.` :

. Le r√©solveur interroge la **racine DNS (`.`)** :
+
[source,dns]
----
QNAME = 14.18.217.172.in-addr.arpa.
‚Üí R√©ponse : "NS pour arpa."
----

. Il interroge les **serveurs de la zone `arpa.`** :
+
[source,dns]
----
‚Üí R√©ponse : "NS pour in-addr.arpa."
----

. Puis les **serveurs de `in-addr.arpa.`** :
+
[source,dns]
----
‚Üí R√©ponse : "NS pour 172.in-addr.arpa."
----

. Et ainsi de suite jusqu‚Äô√† trouver un serveur **autoritaire pour 217.172.in-addr.arpa** ou une zone plus sp√©cifique :
+
[source,dns]
----
‚Üí R√©ponse : "NS pour 18.217.172.in-addr.arpa."
----

. Enfin, le serveur autoritaire pour cette zone retourne un enregistrement `PTR`.

=== üîπ Exemple de fichier de zone

[source,dns]
----
$TTL 86400
@ IN SOA ns1.revdns.example. admin.example.com. (
    2025062701 ; Serial
    3600       ; Refresh
    1800       ; Retry
    604800     ; Expire
    86400 )    ; Minimum TTL

@ IN NS ns1.revdns.example.

14.18.217.172.in-addr.arpa. IN PTR host.example.com.
----

Cet enregistrement signifie que l'adresse IP `172.217.18.14` correspond au nom d‚Äôh√¥te `host.example.com.`.

=== üîπ Visualisation de la hi√©rarchie

[plantuml, reverse-dns-hierarchy, png]
----
title "Hi√©rarchie de r√©solution DNS inverse (in-addr.arpa)"
left to right direction
rectangle "arpa" as arpa
rectangle "in-addr" as inaddr
rectangle "172" as o1
rectangle "217" as o2
rectangle "18" as o3
rectangle "14" as o4

arpa --> inaddr
inaddr --> o1
o1 --> o2
o2 --> o3
o3 --> o4
----

=== üîπ Cas d‚Äôusage

* Diagnostic et audit r√©seau (reverse DNS dans les logs)
* Filtrage des emails (reverse DNS obligatoire pour √©viter le spam)
* Certains pare-feu et syst√®mes de s√©curit√©

=== üîπ Outils de v√©rification

* **Windows** : `ping -a 172.217.18.14`
* **Linux** : `dig -x 172.217.18.14 +noall +answer`
* **Web** : https://mxtoolbox.com/ReverseLookup.aspx

=== üìù Remarques

* Tous les serveurs DNS **n‚Äôautorisent pas** ou **ne configurent pas** d‚Äôenregistrements PTR ‚Üí la r√©solution inverse peut √©chouer sans erreur DNS.
* La zone `in-addr.arpa.` est souvent **d√©l√©gu√©e aux op√©rateurs r√©seau** (FAI, h√©bergeurs, etc.), qui seuls peuvent configurer les enregistrements PTR.

== Enregistrement des noms de domaine

=== Acteurs cl√©s

[.text-center]
[plantuml, domain-registration, png]
----
title "Cha√Æne d'enregistrement d‚Äôun domaine"
top to bottom direction
[ICANN] --> [Registrars]
[Registrars] --> [Resellers]
[Resellers] --> [Registrants]
----
*Acteurs cl√©s* :
* **ICANN** : supervise la racine DNS, accr√©dite les registrars
* **Registrars** (ex : Gandi, OVH, Amazon) : vendent les noms de domaine
* **Resellers** : revendeurs s‚Äôappuyant sur l‚ÄôAPI d‚Äôun registrar
* **Registrants** : propri√©taires finaux du domaine

=== üîπ Processus d‚Äôenregistrement

. **Choix du TLD** (‚âà 1 500 disponibles) ‚Äî crit√®res :
* Support **DNSSEC**
* Support **IDN** (caract√®res UTF-8 accentu√©s)
* Restrictions g√©ographiques / l√©gales (ex : `.ca`, `.bank`)
. **V√©rification de disponibilit√©** (WHOIS/RDAP ou portail du registrar)
. **Protection anti-typosquatting**
* *Typosquatting* : enregistrement de variantes typographiques malveillantes
* **dnstwist** : outil CLI pour lister et surveiller les homographes. Jeter un coup d'oeil pour ne pas √™tre l√©s√© plus tard. (Outils python installable avec pip)
. **Validation & paiement** : le registrar effectue la cr√©ation via le protocole **EPP** (Extensible Provisioning Protocol).

=== üîπ Codes EPP (statuts de domaine)

|===
| Code | Effet & explication
|------|---------------------
| `clientHold` | **Suspend** l‚Äôactivation : le domaine ne se r√©sout plus tant que le registrant ne l√®ve pas le statut.
| `serverHold` | Suspension impos√©e par le **registre** (litige, non-paiement, d√©cision judiciaire).
| `clientTransferProhibited` | Blocage volontaire des **transferts sortants** ‚Äî protection contre le vol de domaine.
| `serverTransferProhibited` | Blocage de transfert impos√© par le registre (proc√©dure UDRP, etc.).
|===

*V√©rification en ligne* : https://lookup.icann.org/

=== Stockage des donn√©es DNS : zones & enregistrements

[.text-center]
[plantuml, dns-record-structure, png]
----
title "Structure interne d‚Äôun Resource Record"
frame "Resource Record" {
component "Name (√©tiquette)" as N
component "Type (A, MX, NS‚Ä¶)" as Ty
component "Class (IN)" as Cl
component "TTL (dur√©e de cache)" as T
component "RDLENGTH (taille)" as L
component "RDATA (donn√©es)" as D
}
----

*L√©gende* :

* **Name** : domaine ou `@` pour la racine de la zone
* **Type** : nature du record (`A`, `AAAA`, `MX`, `PTR`, `SOA`, etc.)
* **Class** : presque toujours `IN` (*Internet*)
* **TTL** : dur√©e (en s) avant expiration du cache
* **RDLENGTH / RDATA** : taille et contenu effectif (IP, nom, cl√©, texte‚Ä¶)

==== üîπ Types de zones

| Type de zone | Finalit√© | Exemple concret |
|===
|--------------|----------|-----------------|
| **Forward**  | Nom ‚Üí IP (r√©solution classique) | `www.example.com` ‚ûú `192.0.2.1` |
| **Reverse**  | IP ‚Üí Nom (`in-addr.arpa`, `ip6.arpa`) | `192.0.2.1` ‚ûú `host.example.com` |
| **Secondary / Slave** | Copie compl√®te d‚Äôune zone, mise √† jour par `AXFR/IXFR` | Haute dispo chez plusieurs NS |
| **Stub**     | Contient **uniquement** les enregistrements `NS` d‚Äôune zone distante | Optimise les requ√™tes internes |
|===

==== üîπ Enregistrement SOA (Start of Authority)

[source,dns]
----
example.com. 3600 IN SOA ns1.example.com. admin.example.com. (
  2023062501 ; Serial (version de zone)
  86400      ; Refresh (toutes les 24 h)
  7200       ; Retry   (toutes les 2 h en cas d‚Äô√©chec)
  3600000    ; Expire  (40 j avant abandon)
  172800     ; NX TTL  (cache n√©gatif 48 h)
)
----

* **Serial** : doit √™tre incr√©ment√© √† chaque modification de zone.
* **Refresh/Retry/Expire** : rythment la synchronisation avec les serveurs secondaires.
* **NX TTL** : temps de cache des r√©ponses **NXDOMAIN**.

==== Comprendre les param√®tres SOA et la ¬´ fen√™tre ¬ª de 48 h

Le bloc SOA (Start of Authority) pilote la **synchronisation** entre le serveur
ma√Ætre et les serveurs secondaires ; chaque champ joue un r√¥le pr√©cis :

[cols="2,6",options="header"]
|===
| Champ | R√¥le d√©taill√©

| **Serial** (`2024062701`)
| Num√©ro de version de la zone.
*Format classique* : `YYYYMMDDnn`.
√Ä **chaque modification de la zone**, on l‚Äôincr√©mente ;
les secondaires comparent ce nombre pour savoir s‚Äôils doivent se mettre √† jour.

| **Refresh** (`86400` s = 24 h)
| Fr√©quence √† laquelle un secondaire interroge le ma√Ætre pour demander
¬´ Le Serial a-t-il chang√© ? ¬ª.
‚Üí Toutes les 24 h il v√©rifie la version.

| **Retry** (`7200` s = 2 h)
| Si la tentative de rafra√Æchissement **√©choue** (ma√Ætre injoignable),
le secondaire r√©essaie toutes les 2 h jusqu‚Äô√† succ√®s ou jusqu‚Äôau d√©lai *Expire*.

| **Expire** (`3600000` s ‚âà 41 j)
| Au-del√† de 41 jours sans contact, le secondaire consid√®re la zone **p√©rim√©e**
et cesse de r√©pondre (s√©curit√© contre des donn√©es trop vieilles).

| **NX TTL** (`172800` s = 48 h)
| Dur√©e pendant laquelle un **√©chec** (NXDOMAIN) peut √™tre mis en cache.
Concr√®tement : si un nom n‚Äôexiste pas, les r√©solveurs peuvent se souvenir
de ce ¬´ non-existence ¬ª 48 h avant de v√©rifier √† nouveau.
|===

===== Pourquoi avoir historiquement retenu *48 h* pour le NX TTL ?

* **Couverture fuseaux horaires :**
48 h garantit que, m√™me si un administrateur publie un nouveau
sous-domaine tard dans sa journ√©e locale, les caches partout sur la plan√®te
expireront au plus tard ¬´ le surlendemain m√™me heure ¬ª.
‚Üí C‚Äôest une fen√™tre raisonnable pour la *propagation mondiale*.

* **Anti-cache-poisoning :**
Conserver un √©chec plus longtemps que le TTL normal d‚Äôun enregistrement
limite les tentatives r√©p√©t√©es d‚Äôempoisonnement (les r√©cursifs ne refont
pas la m√™me requ√™te en boucle).

* **Administrations lentes / secondaires √©loign√©s :**
48 h laisse le temps aux serveurs secondaires d‚Äôobtenir la nouvelle zone
(ils interrogent au pire toutes les 24 h, et r√©essaient toutes les 2 h en
cas d‚Äô√©chec).

===== Mise √† jour : sc√©nario chronologique

. **T‚ÇÄ ‚Äì modification**
L‚Äôadmin √©dite le fichier de zone, incr√©mente le *Serial* (ex : `2024062702`).

. **T‚ÇÄ + Refresh** (‚â§ 24 h)
Chaque secondaire interroge le ma√Ætre ; voit le *Serial* plus grand ;
d√©clenche un **AXFR/IXFR** (transfert int√©gral ou incr√©mental) ; met √† jour
son propre fichier.

. **Propagation c√¥t√© cache r√©cursif**
Les r√©cursifs gardent les anciennes valeurs jusqu‚Äô√† expiration du TTL des
enregistrements concern√©s.
‚Üí Si on a pr√©vu un basculement, on **baisse les TTL** (ex : √† 300 s)
*avant* la migration pour acc√©l√©rer la propagation.

. **En cas d‚Äô√©chec de contact**
Le secondaire retentera toutes les 2 h (*Retry*) jusqu‚Äô√† ce que :
* soit il r√©ussisse,
* soit les 41 jours (*Expire*) s‚Äô√©coulent ; il cessera alors de servir la
zone (fail-safe).

En r√©sum√© :

* **Refresh / Retry / Expire** ‚Üí dialogue ma√Ætre-secondaire.
* **TTL / NX TTL** ‚Üí dialogue cache r√©cursif ‚Üî clients.
* Les 48 h du *NX TTL* offrent une fen√™tre uniforme et s√ªre pour la
non-existence d‚Äôun nom, tout en m√©nageant le temps de propagation global.


== Propagation des modifications DNS

=== M√©canismes cl√©s de la propagation

==== 1. R√¥le du TTL (Time To Live)

Chaque enregistrement DNS contient un TTL qui contr√¥le sa dur√©e de vie dans les caches :

[source,dns]
----
www.example.com.  3600  IN  A  192.0.2.1  ; TTL = 1 heure
api.example.com.  86400 IN  A  203.0.113.5 ; TTL = 24 heures
----

*Impact* :
- Les r√©solveurs conservent les donn√©es jusqu'√† expiration du TTL
- Les modifications ne sont visibles qu'apr√®s ce d√©lai

=== 2. Hi√©rarchie des caches DNS

[plantuml, cache-hierarchy, png]
----
left to right direction
rectangle "Serveur Autoritaire" as auth
rectangle "TLD (.com/.fr)" as tld
rectangle "R√©solveurs (1.1.1.1)" as resolver
rectangle "FAI" as isp
rectangle "OS/Navigateur" as client

auth --> tld
tld --> resolver
resolver --> isp
isp --> client
----

=== 3. Synchronisation des serveurs secondaires

[source,dns]
----
example.com. IN SOA ns1.example.com. admin.example.com. (
  2024062701 ; Serial
  86400     ; Refresh = 24h
  7200      ; Retry = 2h
  3600000   ; Expire = 41 jours
  172800    ; NX TTL = 48h
)
----

== Pourquoi 48h exactement ?

[cols="1,3"]
|===
| ‚úÖ | Norme historique (RFC 1034)
| ‚úÖ | Couvre tous les fuseaux horaires
| ‚úÖ | Limite les attaques DNS poisoning
| ‚úÖ | Temps pour synchroniser les r√©solveurs lents
|===

== Acc√©l√©rer la propagation

[cols="3*", options="header"]
|===
| M√©thode | Efficacit√© | Limites
| R√©duire le TTL √† l'avance | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | Doit √™tre fait 48h avant
| `dig @8.8.8.8` | ‚≠ê‚≠ê | Contourne le cache local
| Vider cache OS | ‚≠ê | Seulement sur votre machine
|===

=== Pr√©paration optimale

1. 72h avant : TTL = 300s
2. Modifier les enregistrements
3. Apr√®s propagation : TTL = 86400s

[NOTE]
====
‚ö† Les enregistrements NS (serveurs DNS) ont souvent des TTL bloqu√©s √† 48h par les registres
====

== V√©rification en temps r√©el

[source,bash]
----
# Commandes de v√©rification
dig +short www.example.com @8.8.8.8
dig +trace www.example.com
----

*Outils en ligne* :
- https://dnschecker.org
- https://www.whatsmydns.net

¬© 2025 *rridane* ‚Äì [GitHub](https://github.com/rridane)
