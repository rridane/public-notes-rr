= Comprendre le systÃ¨me DNS
:icons: font
:source-highlighter: highlightjs
:toc: left

== Domaines et hiÃ©rarchies des domaines

.www.example.com
[.text-center]
[plantuml, namespace-structure, png]
----
left to right direction
rectangle "Root" as root
rectangle "TLD (.com)" as tld
rectangle "Second Level (.example)" as second
rectangle "Third Level (www)" as third
rectangle "..." as next

root --> tld
tld --> second
second --> third
third --> next
----

[NOTE]
====
La rÃ©solution se lit de droite Ã  gauche et le premier dernier point (tout Ã  droite) est appelÃ© domaine racine
.com est appelÃ© TLD ou Top Level Domain., on trouve ensuite le second level etc..
On peut lire en quelques sortes l'adresse par ".www .example .com ."
====

[NOTE]
====
ðŸ”¹ La combinaison du **TLD + Second Level** est appelÃ©e **Zone Apex** ou *Naked Domain* : `example.com`

ðŸ”¹ Elle correspond gÃ©nÃ©ralement au domaine enregistrÃ© chez un registrar.
====

[NOTE]
====
ðŸŒ La totalitÃ© est appelÃ©e le **FQDN (Fully Qualified Domain Name)** : `www.example.com.`

ðŸ§© Ce nom inclut **tous les niveaux** jusquâ€™Ã  la racine `.`
====

[NOTE]
====
ðŸŒ La composition de 1 Ã  x domaines crÃ©Ã© une zone
====

== Zones DNS

=== Comprendre la notion de Zone DNS

Une **zone DNS** est une **clÃ©** utilisÃ©e dans un serveur **autoritaire** (qui devient autoritaire pour cette zone plus prÃ©cisÃ©ment, nous y viendrons) pour enregistrer et retrouver un ensemble dâ€™enregistrements DNS (`A`, `AAAA`, `MX`, `TXT`, `CNAME`, etc.) (Nous viendrons Ã©galement Ã  ces enregistrements).

La structure du DNS repose entiÃ¨rement sur cette logique de **clÃ©s hiÃ©rarchiques**.
Chaque requÃªte DNS consiste Ã  **naviguer de zone en zone**, câ€™est-Ã -dire **de clÃ© en clÃ©**, en suivant les **enregistrements `NS`** jusquâ€™Ã  atteindre la zone finale autoritaire.

Cette "clÃ©" correspond Ã  un **nom de domaine**, gÃ©nÃ©ralement une **composition dâ€™un TLD + un ou plusieurs niveaux suivants**, par exemple :
â€“ `example.com`
â€“ `sub.dept.univ.edu`

Elle agit comme un **point dâ€™ancrage** dans le serveur : tous les enregistrements associÃ©s Ã  cette zone sont gÃ©rÃ©s localement, **tant quâ€™aucune dÃ©lÃ©gation `NS` nâ€™est faite**. On appelle dÃ©lÃ©gation NS la prÃ©sence d'un enregistrement NS pour une "sous zone" de cette zone. Il faut comprendre: "Pour la sous zone xxx va voir nameserver (NS), il est possible qu'il contiennent les enregistrements, ou il saura te rediriger"

=== Enregistrements DNS (Zone File)

Une **zone DNS** ne se limite pas Ã  un simple nom : elle est associÃ©e Ã  un **fichier de zone** (zone file), qui **dÃ©finit tous les enregistrements DNS** que le serveur doit connaÃ®tre pour cette zone.

Chaque **clÃ©** (nom de domaine) correspond Ã  une **entrÃ©e** dans ce fichier, qui spÃ©cifie :

* Son **type dâ€™enregistrement** (`A`, `AAAA`, `MX`, `NS`, `SOA`, etc.)
* Sa **valeur** (adresse IP, serveur de mail, alias, etc.)
* Une **durÃ©e de vie (TTL)** â€“ Time To Live â€“ indiquant combien de temps lâ€™information peut Ãªtre mise en cache.

Ce fichier est la **spÃ©cification complÃ¨te de la zone**. Le serveur autoritaire lâ€™utilise pour rÃ©pondre aux requÃªtes sur les noms contenus dans cette zone.

==== Extrait simplifiÃ© dâ€™un fichier de zone `example.com`

[source,dns]
----
$TTL 3600
@       IN SOA  ns1.example.com. admin.example.com. ( ... )
        IN NS   ns1.example.com.
        IN NS   ns2.example.com.
@       IN A    192.0.2.1
www     IN A    192.0.2.2
mail    IN MX   10 mail.example.com.
----

Chaque ligne reprÃ©sente un **enregistrement DNS** associÃ© Ã  la zone `example.com`.

Nous allons maintenant dÃ©tailler les principaux types dâ€™enregistrements que lâ€™on peut trouver dans une zone DNS.

== Types dâ€™enregistrements DNS

Chaque **enregistrement DNS** indique une information prÃ©cise pour un nom de domaine donnÃ©.

Voici les principaux types dâ€™enregistrements, organisÃ©s par usage :

=== ðŸ”¹ Enregistrements de rÃ©solution (vers une adresse IP)

[cols="1,3", options="header"]
| Type | Description
| A    | Associe un nom de domaine Ã  une adresse IPv4 (ex: `192.0.2.1`)
| AAAA | Associe un nom de domaine Ã  une adresse IPv6 (ex: `2001:db8::1`)
| CNAME | DÃ©clare un alias : ce nom pointe vers un **autre nom de domaine**
âž¡ï¸ UtilisÃ© pour rediriger un nom vers un autre (ex : `blog.example.com` vers `example.com`)
| DNAME | Comme CNAME mais pour **tous les sous-domaines**
âž¡ï¸ Ex : tous les `*.legacy.example.com` pointent vers `*.newdomain.com`

=== ðŸ”¹ Enregistrements de messagerie

[cols="1,3", options="header"]
| Type | Description
| MX   | SpÃ©cifie le serveur de mail (Mail eXchanger) pour un domaine
âž¡ï¸ Peut contenir une **prioritÃ©** : plus elle est basse, plus le serveur est prÃ©fÃ©rÃ©
| SPF  | Ancien format dâ€™authentification des mails (dÃ©prÃ©ciÃ©, remplacÃ© par TXT)
| TXT  | Texte libre â€” utilisÃ© notamment pour :
â†’ VÃ©rification de domaine (Google, Office 365â€¦) (Voir prÃ©sentation technique)
â†’ SPF moderne (protection anti-spam) (Voir prÃ©sentation technique)
â†’ DKIM, DMARC (authentification des mails) (Voir prÃ©sentation technique)

=== ðŸ”¹ Enregistrements de dÃ©lÃ©gation

[cols="1,3", options="header"]
| Type | Description
| NS   | Indique le ou les serveurs faisant autoritÃ© pour une **zone donnÃ©e**
âž¡ï¸ ClÃ© essentielle pour la **dÃ©lÃ©gation DNS**
| SOA  | Start of Authority : en-tÃªte obligatoire dâ€™une zone
â†’ Donne des mÃ©tadonnÃ©es sur la zone :
â€“ Le serveur maÃ®tre
â€“ Lâ€™adresse email de lâ€™administrateur
â€“ Le numÃ©ro de version (serial)
â€“ Les paramÃ¨tres de rafraÃ®chissement / TTL

=== ðŸ”¹ Enregistrements de sÃ©curitÃ©

Voir section technique pour plus de prÃ©cisions

[cols="1,3", options="header"]
| Type | Description
| DNSKEY | Contient une clÃ© publique utilisÃ©e pour **signer les enregistrements DNS** (dans le cadre de DNSSEC)
| RRSIG  | Signature cryptographique dâ€™un enregistrement DNS (utilisÃ© avec DNSKEY)
| DS     | Delegation Signer : permet de **valider la dÃ©lÃ©gation sÃ©curisÃ©e** vers une sous-zone
| NSEC / NSEC3 | Prouvent quâ€™un enregistrement **nâ€™existe pas** (DNSSEC)
| CDS / CDNSKEY | Versions Â« enfant Â» des enregistrements DS / DNSKEY (utilisÃ©s pour la mise Ã  jour des clÃ©s via les enfants)

==== ðŸ”¹ Enregistrements spÃ©cifiques ou peu courants

[cols="1,3", options="header"]
| Type | Description
| PTR   | Pointeur utilisÃ© pour la rÃ©solution **inverse** (IP â†’ nom de domaine)
âž¡ï¸ Exemple : `1.2.0.192.in-addr.arpa â†’ example.com`
| SRV   | Indique un **service rÃ©seau** disponible pour un domaine (port, protocole, prioritÃ©â€¦)
âž¡ï¸ Exemple : `_sip._tcp.example.com`
| CAA   | Indique quelles **autoritÃ©s de certification** sont autorisÃ©es Ã  Ã©mettre des certificats pour le domaine
| HINFO | Fournit des informations sur le **matÃ©riel** et le **systÃ¨me dâ€™exploitation**
| AFSDB | UtilisÃ© avec le systÃ¨me de fichiers distribuÃ© AFS (rare)
| RP    | Indique une **adresse e-mail de contact** pour un domaine
| LOC   | Donne une position gÃ©ographique (latitude/longitude) dâ€™un hÃ´te
| NAPTR | UtilisÃ© pour la rÃ©Ã©criture de noms, notamment dans VoIP ou ENUM
| SSHFP | Contient lâ€™empreinte de clÃ© SSH dâ€™un serveur â€” pour vÃ©rification sans `known_hosts`

[NOTE]
====
ðŸ“Œ Chaque enregistrement est dÃ©fini **pour un nom de domaine** donnÃ©, dans une **zone DNS** spÃ©cifique.
âž¡ï¸ Si la zone est `example.com`, on pourra avoir des enregistrements comme :

- `www.example.com. IN A 192.0.2.1`
- `mail.example.com. IN MX 10 mailserver.example.com.`
- `example.com. IN SOA ...`
====

[NOTE]
====
Le champ IN dans les enregistrements DNS signifie "Internet". C'est une abbrÃ©viation de class IN. Il indique la classe du protocole. Historique il y avait CH pour chaos, ou HS pour Hesiod, mais ces deux protocoles classes ne sont plus uitlisÃ©es.
====

[NOTE]
====
On peut lire les enregistrements de la maniÃ¨re suivante :

- `www.example.com. IN A 192.0.2.1` => `www.example.com. dispose d'un enregistrement INternet de type A, sa valeur est 192.0.2.1`
- `mail.example.com. IN MX 10 mailserver.example.com.` => `mail.example.com. dispose d'un enregistrement INternet de type MX, de prioritÃ© 10, sa valeur est mailserver.example.com.`
====

== Architecture de la rÃ©solution DNS

=== RÃ©solution DNS : itÃ©rative vs rÃ©cursive

Il existe deux modes de rÃ©solution DNS, dÃ©finis par le **flag `RD` (Recursion Desired)** dans lâ€™en-tÃªte DNS de la requÃªte :

* `RD = 1` â†’ le client demande une **rÃ©solution rÃ©cursive complÃ¨te**
* `RD = 0` â†’ le client demande une **rÃ©solution itÃ©rative**

==== ðŸ” RÃ©solution rÃ©cursive (mode courant)

- Le client dÃ©lÃ¨gue la rÃ©solution complÃ¨te au **rÃ©solveur DNS** (ex : `1.1.1.1`, `8.8.8.8`)
- Le rÃ©solveur interroge successivement les serveurs racine, TLD, puis autoritaires
- Il renvoie directement la **rÃ©ponse finale (IP)** au client
- Câ€™est le mode utilisÃ© dans **la majoritÃ© des cas** (navigateurs, OS, etc.)

==== ðŸ”‚ RÃ©solution itÃ©rative (mode avancÃ©)

- Le client interroge lui-mÃªme les serveurs DNS **Ã©tape par Ã©tape**
- Chaque serveur rÃ©pond avec une **rÃ©fÃ©rence (`NS`) vers la zone suivante**
- Le client continue jusqu'Ã  obtenir la rÃ©ponse finale

==== ðŸ§  Qui utilise quoi ?

[cols="2*", options="header"]
| Cas d'usage                       | Type de rÃ©solution
| Navigateur ou OS grand public    | RÃ©cursive (`RD=1`)
| RÃ©solveur DNS interrogeant la racine | ItÃ©rative (`RD=0`)
| Serveurs racine / TLD            | Ne font **jamais** de rÃ©cursif ; rÃ©pondent **en itÃ©ratif uniquement**

==== ðŸ“¦ RÃ©ponse du serveur

Dans la rÃ©ponse DNS, le serveur peut indiquer sâ€™il **accepte ou non la rÃ©cursion** :

* `RA = 1` â†’ Recursion Available (le serveur sait faire du rÃ©cursif)
* `RA = 0` â†’ Ce serveur ne gÃ¨re **que de lâ€™itÃ©ratif**

[NOTE]
====
ðŸ“Œ Le **mode de rÃ©solution** est dÃ©fini par le client (`RD=1` ou `RD=0`)
ðŸ“Œ Les **serveurs racine, TLD et autoritaires** ne font **jamais** de rÃ©cursif, mÃªme si `RD=1` est activÃ©
ðŸ“Œ Seuls les **rÃ©solveurs DNS** comme `1.1.1.1` ou `8.8.8.8` exÃ©cutent une vraie rÃ©solution rÃ©cursive
====

== Processus de rÃ©solution macro

=== Ã‰tape 1 : RÃ©solution locale (cache DNS ou /etc/hosts)

[.text-center]
[plantuml, dns-local-resolution, png]
----
actor "Client" as C
database "/etc/hosts\n+ cache DNS local" as Local

C --> Local : RÃ©solution www.example.com
Local --> C : RÃ©ponse (si trouvÃ©e)
----

=== Ã‰tape 2 : RÃ©solution par le rÃ©solveur rÃ©cursif (rÃ©solution complÃ¨te)

[.text-center]
[plantuml, dns-resolution-deep, png]
----
actor "Client" as C
node "RÃ©solveur DNS RÃ©cursif (ex: 1.1.1.1)" as R
node "Root Server" as RS
node "TLD Server (.com)" as TLD
node "Authoritative NS (example.com)" as A

C --> R : RequÃªte www.example.com
R --> RS : "OÃ¹ est le TLD .com ?"
RS --> R : "Va voir TLD Server"
R --> TLD : "OÃ¹ est example.com ?"
TLD --> R : "Va voir le serveur A"
R --> A : "Quelle est lâ€™IP de www ?"
A --> R : "93.184.216.34"
R --> C : RÃ©ponse finale
----

[NOTE]
====
ðŸ§­ **Ã‰tapes internes dâ€™un rÃ©solveur rÃ©cursif (ex : 1.1.1.1)**

1. ðŸ” Il commence par vÃ©rifier son **cache DNS interne** : si la rÃ©ponse existe dÃ©jÃ  et que le ttl n'est pas expirÃ©, il la renvoie directement.
2. ðŸŒ Si la rÃ©ponse nâ€™est pas en cache, il dÃ©marre une **rÃ©solution complÃ¨te**, de la racine jusquâ€™au serveur autoritaire.
- Il sâ€™appuie sur un fichier `roothints` : une **liste des adresses IP des 13 serveurs racine** (`a.root-servers.net`, etc.)
- Il interroge un serveur racine pour connaÃ®tre les `NS` du TLD concernÃ© (ex : `.com`)
- Puis il interroge les **serveurs du TLD** (`.com`) pour obtenir les `NS` de `example.com`
- Enfin, il interroge le **serveur autoritaire pour `example.com`** pour obtenir lâ€™IP de `www`

ðŸ“Œ Ã€ chaque Ã©tape, les serveurs DNS rÃ©pondent avec des **enregistrements de dÃ©lÃ©gation (`NS`)**
Le rÃ©solveur suit cette **chaÃ®ne hiÃ©rarchique**, Ã©tape par Ã©tape, **jusquâ€™Ã  trouver la rÃ©ponse finale**.
====

==== ðŸ”¹ Exemple 1 â€“ Une seule zone (`example.com`)

Tous les enregistrements sont gÃ©rÃ©s dans la mÃªme zone, sans dÃ©lÃ©gation :

[source,dns]
----
; Zone : example.com
example.com.          IN A     192.0.2.1
www.example.com.      IN A     192.0.2.2
mail.example.com.     IN MX    10 mail.example.com.
----

Ici, les sous-domaines `www`, `mail`, etc. sont **inclus dans la zone `example.com`**, gÃ©rÃ©e par un **serveur autoritaire unique**.

==== ðŸ”¹ Exemple 2 â€“ DÃ©lÃ©gation vers une autre zone (`blog.example.com`)

La zone `example.com` dÃ©lÃ¨gue `blog.example.com` Ã  d'autres serveurs via un enregistrement `NS` :

[source,dns]
----
; Dans la zone parent : example.com
blog.example.com.     IN NS    ns1.blog.example.com.
                      IN NS    ns2.blog.example.com.

; Zone sÃ©parÃ©e : blog.example.com
@                     IN SOA   ns1.blog.example.com. admin.blog.example.com. (...)
                      IN NS    ns1.blog.example.com.
                      IN NS    ns2.blog.example.com.
@                     IN A     203.0.113.42
----

RÃ©sultat :
* `blog.example.com` devient une **zone DNS indÃ©pendante**
* Elle est servie par ses propres serveurs (`ns1.blog.example.com`, etc.)
* La zone `example.com` **ne connaÃ®t pas** les enregistrements internes de `blog.`, uniquement quâ€™elle lâ€™a dÃ©lÃ©guÃ©e

Une **zone DNS** est un segment de lâ€™espace de noms DNS associÃ© Ã  un **nom de domaine**, pour lequel un serveur dÃ©tient et publie des **enregistrements DNS officiels**. Nous y reviendrons mais c'est la prÃ©sence d'un enregistrement SOA qui fait qu'un serveu est bien l'authoritative serveur pour une zone.

[NOTE]
====
Une **zone DNS** peut contenir :

1. Des **enregistrements finaux** (`A`, `AAAA`, `MX`, `TXT`, `CNAME`, etc.)
2. Des **dÃ©lÃ©gations** vers d'autres zones (via des enregistrements `NS`)
3. âœ… Ou **les deux Ã  la fois**

Exemple : la zone `example.com` peut contenir les enregistrements pour `www.example.com` et dÃ©lÃ©guer `blog.example.com` Ã  une autre zone.
====

Par dÃ©faut, tous les sous-domaines sont inclus dans la zone, **tant quâ€™ils nâ€™ont pas Ã©tÃ© explicitement dÃ©lÃ©guÃ©s**.

== Processus de rÃ©solution dÃ©taillÃ©

=== Ã‰tape 1 : Interrogation dâ€™un serveur racine (zone ".")

==== ðŸ”¹ RequÃªte DNS

QNAME = fr.blog.example.com.
QTYPE = A

==== ðŸ”¹ RÃ©ponse DNS (troncature simplifiÃ©e)

Authority Section:
com. IN NS a.gtld-servers.net.
com. IN NS b.gtld-servers.net.
...

Additional Section:
a.gtld-servers.net. IN A 192.5.6.30
b.gtld-servers.net. IN A 192.33.14.30

==== ðŸ”¹ Zone racine : fichier conceptuel db.root

__le @ signifie toujours le nom de la zone, donc ici .__

Le fichier de zone racine contient les dÃ©lÃ©gations vers les TLD (Top-Level Domains) comme .com, .fr, .org, etc. Exemple :

$TTL 3600000
@ IN SOA a.root-servers.net. hostmaster.root-servers.org. (
2025062701 ; Serial
1800       ; Refresh
900        ; Retry
604800     ; Expire
86400 )    ; Minimum TTL

@ IN NS a.root-servers.net.
@ IN NS b.root-servers.net.
@ IN NS c.root-servers.net.
...

com. IN NS a.gtld-servers.net.
fr.  IN NS f.nic.fr.

; Glue records pour les serveurs de TLD
a.gtld-servers.net. IN A 192.5.6.30
f.nic.fr.            IN A 192.134.0.49

ðŸ“Œ Ce fichier de zone est maintenu par l'IANA. Il ne contient aucune information sur les domaines de second niveau (ex: example.com).

ðŸ“Œ Les rÃ©solveurs n'interrogent pas la racine via ce fichier, mais via une liste appelÃ©e roothints qui contient les IP des serveurs racine (A Ã  M).

=== Ã‰tape 2 : Interrogation du TLD .com

==== ðŸ”¹ RequÃªte DNS

QNAME = fr.blog.example.com.
QTYPE = A

==== ðŸ”¹ RÃ©ponse DNS

Authority Section:
blog.example.com. IN NS ns1.blog.example.com.
blog.example.com. IN NS ns2.blog.example.com.

Additional Section:
ns1.blog.example.com. IN A 203.0.113.10
ns2.blog.example.com. IN A 203.0.113.11

==== ðŸ”¹ Fichier de zone : db.com (extrait)

$TTL 3600
@ IN SOA a.gtld-servers.net. admin.gtld-servers.net. (
2025062701 ; Serial
3600       ; Refresh
1800       ; Retry
604800     ; Expire
86400 )    ; Minimum TTL

@ IN NS a.gtld-servers.net.
@ IN NS b.gtld-servers.net.

example.com. IN NS ns1.example.com.
example.com. IN NS ns2.example.com.
ns1.example.com. IN A 203.0.113.1
ns2.example.com. IN A 203.0.113.2

blog.example.com. IN NS ns1.blog.example.com.
blog.example.com. IN NS ns2.blog.example.com.
ns1.blog.example.com. IN A 203.0.113.10
ns2.blog.example.com. IN A 203.0.113.11

[NOTE]
====
ðŸ“Œ Bien que blog.example.com semble sÃ©mantiquement dÃ©pendre de example.com, dans cet exemple, il est directement dÃ©lÃ©guÃ© au niveau de .com, au mÃªme titre que example.com.

ðŸ“Œ En consÃ©quence, la zone example.com ne connaÃ®t rien de lâ€™existence ou du contenu de blog.example.com. Elle nâ€™en est pas responsable, et ne pourra pas rÃ©pondre Ã  une requÃªte concernant blog.example.com.

ðŸ“Œ Cela est conforme au modÃ¨le DNS : nâ€™importe quelle sous-zone peut Ãªtre dÃ©lÃ©guÃ©e indÃ©pendamment Ã  nâ€™importe quel niveau, tant que la dÃ©lÃ©gation est dÃ©clarÃ©e dans la zone parente.
====

=== Ã‰tape 3 : Interrogation de blog.example.com

==== ðŸ”¹ RequÃªte DNS

QNAME = fr.blog.example.com.
QTYPE = A

==== ðŸ”¹ RÃ©ponse DNS

Authority Section:
fr.blog.example.com. IN NS ns1.fr.blog.example.com.
fr.blog.example.com. IN NS ns2.fr.blog.example.com.

Additional Section:
ns1.fr.blog.example.com. IN A 198.51.100.42
ns2.fr.blog.example.com. IN A 198.51.100.43

==== ðŸ”¹ Fichier de zone db.blog.example.com

$TTL 3600
@ IN SOA ns1.blog.example.com. admin.blog.example.com. (
2025062601 ; Serial
3600       ; Refresh
1800       ; Retry
604800     ; Expire
86400 )    ; Minimum TTL

@ IN NS ns1.blog.example.com.
@ IN NS ns2.blog.example.com.

fr IN NS ns1.fr.blog.example.com.
fr IN NS ns2.fr.blog.example.com.
ns1.fr.blog.example.com. IN A 198.51.100.42
ns2.fr.blog.example.com. IN A 198.51.100.43

=== Ã‰tape 4 : Interrogation du serveur final ns1.fr.blog.example.com

==== ðŸ”¹ RequÃªte DNS

QNAME = fr.blog.example.com.
QTYPE = A

==== ðŸ”¹ RÃ©ponse DNS

Answer Section:
fr.blog.example.com. IN A 192.0.2.99

==== ðŸ”¹ Fichier de zone db.fr.blog.example.com

$TTL 3600
@ IN SOA ns1.fr.blog.example.com. admin.fr.blog.example.com. (
2025062601 ; Serial
3600       ; Refresh
1800       ; Retry
604800     ; Expire
86400 )    ; Minimum TTL

@ IN NS ns1.fr.blog.example.com.
@ IN NS ns2.fr.blog.example.com.

@ IN A 192.0.2.99

=== ðŸ”š RÃ©solution complÃ¨te

Le serveur rÃ©cursif retourne lâ€™IP 192.0.2.99 au client. Mission accomplie ðŸŽ¯.

Chaque serveur nâ€™a rÃ©pondu que pour sa propre zone et a fourni les dÃ©lÃ©gations nÃ©cessaires (enregistrements NS + glue A).

== RÃ´le et structure du domaine racine (Root Domain)

=== ðŸ”¹ Fonction principale

* Le domaine racine (.) constitue le point dâ€™entrÃ©e officiel de lâ€™espace de noms DNS.
* Le serveur racine oriente la requÃªte DNS vers le bon serveur TLD (.com, .fr, etc.) (Il contient donc toutes les zones TLD)
* Il ne fournit pas de rÃ©ponse finale, mais transfÃ¨re la rÃ©solution Ã  la zone suivante (TLD zone)
* Il est interrogÃ© uniquement par les rÃ©solveurs rÃ©cursifs (ex : 1.1.1.1, 8.8.8.8) lorsquâ€™aucune information pertinente nâ€™est encore en cache

=== ðŸ”¹ Nombre et structure

* La zone racine est servie par une infrastructure mondiale de serveurs dits â€œracineâ€, Ã  la base de toute rÃ©solution hiÃ©rarchique.
* Il existe 13 serveurs racine rÃ©fÃ©rencÃ©s officiellement, nommÃ©s de A Ã  M
* En rÃ©alitÃ©, ils sont une rÃ©plique d'un seul et unique serveur racine maitre, dit autoritaire pour la zone racine. Ce serveur est maintenu par l'IANA (ICANN).
* Ils sont gÃ©rÃ©s par diffÃ©rents organismes, coordonnÃ©s par l'ICANN

Chacun de ces 13 "serveurs racine" sont en rÃ©alitÃ© massivement rÃ©pliquÃ©s (plus de 1 600 instances globales)

La rÃ©plication sâ€™appuie sur la technologie anycast pour :
Assurer rÃ©silience (en cas de panne locale)
Offrir une faible latence (route vers lâ€™instance la plus proche)

=== ðŸ”¹ Raison du chiffre 13

[NOTE]
--
ðŸ”¢ Le chiffre 13 nâ€™est pas arbitraire : il vient dâ€™une contrainte technique historique.

Ã€ lâ€™origine, une rÃ©ponse DNS devait tenir dans 512 octets maximum (limite UDP DNS sans EDNS0).

âž¡ï¸ La rÃ©ponse du serveur racine devait contenir :
â€“ Les 13 enregistrements NS (A Ã  M)
â€“ Les glue records (adresses IP associÃ©es, A pour IPv4 et AAAA pour IPv6)
ðŸ’¡ Or, chaque serveur racine a un nom long (a.root-servers.net).
Dans les annÃ©es 80 on intÃ©rrogeait rÃ©guliÃ¨rement le serveur maitre de la zone racine (ce qui n'est plus le cas aujourd'hui), donc sa rÃ©ponse (liste des NS avec ips) devait tenir dans 512 octets.

Cette contrainte dictait donc la taille maximale de la liste de serveurs racine.
Depuis, cette limite a Ã©tÃ© levÃ©e via EDNS0, mais la structure reste pour des raisons de compatibilitÃ©.
--

=== ðŸ”¹ Contenu de la zone racine

    La zone racine ne contient que :
        Des enregistrements NS pour chaque TLD connu (.com, .fr, .org, etc.)
        Leurs glue records (adresses IP nÃ©cessaires Ã  la rÃ©solution)

Elle ne contient aucune information applicative (ex : pas dâ€™A ou MX pour example.com)

== Top Level Domains (TLD)

Les domaines de premier niveau (TLD) constituent la premiÃ¨re division sous la racine dans la hiÃ©rarchie DNS.
Ils se rÃ©partissent en **deux grandes catÃ©gories** :

[cols="2*", options="header"]
|===
| gTLD (gÃ©nÃ©riques)        | ccTLD (country codes)
| `.com`, `.org`, `.net`   | `.fr`, `.de`, `.jp`
| `.edu`, `.gov`, `.info`  | `.uk` (ex : `co.uk`)
|===

* Les **gTLD** sont Ã  vocation gÃ©nÃ©rale, souvent liÃ©s Ã  une activitÃ© (commerciale, gouvernementaleâ€¦).
* Les **ccTLD** sont liÃ©s Ã  un pays ou un territoire, selon la norme [ISO 3166-1 alpha-2](https://fr.wikipedia.org/wiki/ISO_3166-1_alpha-2).
* Pour consulter la liste complÃ¨te des TLD gÃ©rÃ©s dans la racine DNS
ðŸ‘‰ https://www.iana.org/domains/root/db

== DNS autoritaire ou Authoritative DNS

Un **serveur DNS nâ€™est pas â€œautoritaireâ€ par nature** : il lâ€™est **uniquement pour les zones quâ€™il hÃ©berge localement**.

Autrement dit :
â€“ Un mÃªme serveur peut Ãªtre **autoritaire pour plusieurs zones** (ex : `.com`, `example.com`, `blog.example.com`)
â€“ Et il peut **ne pas lâ€™Ãªtre du tout** pour dâ€™autres zones quâ€™il ne connaÃ®t pas ou ne sert pas

[IMPORTANT]
====
ðŸ”¹ Un **serveur est dit autoritaire** pour une zone sâ€™il :

â€“ DÃ©tient cette zone **en local** (fichier de zone, base de donnÃ©es, etc.)
â€“ Peut **rÃ©pondre de maniÃ¨re dÃ©finitive** Ã  des requÃªtes sur cette zone
â€“ Ne rÃ©alise **aucune rÃ©solution rÃ©cursive**

ðŸ”¹ Ce rÃ´le est donc **relatif Ã  une zone donnÃ©e** : un serveur peut Ãªtre autoritaire pour `example.com` mais pas pour `google.com`.
====

La **structure hiÃ©rarchique des zones** et la **chaÃ®ne de dÃ©lÃ©gation via les enregistrements `NS`** sont ce qui permet Ã  lâ€™ensemble du DNS de fonctionner comme un arbre distribuÃ©, chaque serveur nâ€™Ã©tant responsable que des zones qui lui sont explicitement attribuÃ©es.

== MÃ©canisme de cache DNS

Chaque rÃ©solveur DNS (notamment les serveurs rÃ©cursifs comme `1.1.1.1` ou `8.8.8.8`) met en place un **cache DNS**, pour amÃ©liorer drastiquement la rapiditÃ© des rÃ©ponses et rÃ©duire le trafic rÃ©seau inutile. Ce cache est basÃ© sur le TTL (Time To Live).

=== ðŸ“¦ Fonctionnement du TTL (Time To Live)

Le champ TTL est une **durÃ©e en secondes** qui dÃ©termine **combien de temps une rÃ©ponse DNS peut Ãªtre conservÃ©e en cache**.

=== ðŸ” MÃ©canisme de calcul

1. Lorsquâ€™un enregistrement DNS est reÃ§u, il est accompagnÃ© dâ€™un `TTL` (ex : `3600` secondes).
2. Le rÃ©solveur rÃ©cursif ou local le stocke en cache **avec un horodatage** (timestamp).
3. Ã€ chaque nouvelle requÃªte :
- Il **calcule le temps Ã©coulÃ©** depuis la mise en cache.
- Il **soustrait ce temps Ã©coulÃ©** du TTL initial pour obtenir le **TTL restant**.
- Si le TTL restant > 0 â†’ âœ… entrÃ©e encore valide, rÃ©ponse depuis le cache.
- Si le TTL â‰¤ 0 â†’ âŒ entrÃ©e expirÃ©e, nouvelle rÃ©solution DNS complÃ¨te.

==== ðŸ’¡ Remarques

- Le TTL **nâ€™est pas dÃ©crÃ©mentÃ© en temps rÃ©el** dans le cache (pas de minuterie active).
- Le serveur peut transmettre le **TTL restant** dans sa rÃ©ponse pour Ã©viter une surconservation cÃ´tÃ© client.

=== ðŸ” Cycle de vie dâ€™une rÃ©solution avec cache

[.text-center]
[plantuml, dns-caching-full, png]
----
title "Cycle de vie du cache DNS (avec expiration TTL)"
start
:RequÃªte DNS;
if (EntrÃ©e en cache ?) then (Oui)
  if (TTL expirÃ© ?) then (Oui)
    :RÃ©solution complÃ¨te;
    :Stockage de la rÃ©ponse\navec son TTL;
  else (Non)
    :RÃ©ponse immÃ©diate;
  endif
else (Non)
  :RÃ©solution complÃ¨te;
  :Stockage de la rÃ©ponse\navec son TTL;
endif
stop
----

==== ðŸ”Ž DÃ©tails importants

* **Cache DNS** = mÃ©moire temporaire des rÃ©ponses (positives ou nÃ©gatives)
* **TTL (Time To Live)** : durÃ©e (en secondes) pendant laquelle une rÃ©ponse peut Ãªtre conservÃ©e
- DÃ©finie dans le fichier de zone par lâ€™administrateur de la zone
* **Negative Caching** :
- MÃªme les Ã©checs (nom inexistant) sont mis en cache pour une courte durÃ©e
- Ã‰vite de rÃ©pÃ©ter inutilement des rÃ©solutions vouÃ©es Ã  Ã©chouer
- Exemple dâ€™entrÃ©e nÃ©gative : NXDOMAIN

==== ðŸ“¦ OÃ¹ le cache est-il utilisÃ© ?

[cols="2,4a", options="header"]
| Niveau | DÃ©tails
| RÃ©solveur rÃ©cursif (ex: 1.1.1.1)
| Principal point de cache. Tous les serveurs comme Cloudflare, Google DNS, Quad9 conservent les rÃ©ponses (A, AAAA, CNAME, etc.) selon le TTL spÃ©cifiÃ©. Ils sont optimisÃ©s pour cela.

| OS local (Windows, Linux, macOS)
| Certains systÃ¨mes conservent un **cache DNS local** (dans la RAM). Il peut Ãªtre vidÃ© ou interrogÃ©.
- **Windows** :
 +
[source,cmd]
----
ipconfig /displaydns  # Afficher le cache DNS
ipconfig /flushdns    # Vider le cache DNS
----
- **Linux** :
- Si un service comme `systemd-resolved` ou `nscd` est activÃ©, ils gÃ¨rent ce cache.
- Sinon, le systÃ¨me sâ€™appuie uniquement sur le cache applicatif.
- Exemples :
 +
[source,bash]
----
systemd-resolve --statistics
sudo systemd-resolve --flush-caches
nscd -g
----

| Navigateurs web
| Les navigateurs comme Chrome, Firefox, Safari disposent **de leur propre cache DNS**, en plus de celui du systÃ¨me.
- Exemple pour Chrome :
 +
[source]
----
chrome://net-internals/#dns
----
- Ce cache est isolÃ© et peut parfois crÃ©er des incohÃ©rences (nom rÃ©solu dans Chrome mais pas dans un `curl` ou `dig`).

==== ðŸ§  Pourquoi le cache est-il crucial ?

* RÃ©duction de la **latence** : moins de requÃªtes vers les serveurs racine, TLD, etc.
* AmÃ©lioration des **performances perÃ§ues**
* AllÃ¨gement de la **charge rÃ©seau** (surtout pour les grands rÃ©solveurs publics)
* Le TTL permet de contrÃ´ler **le temps de propagation des modifications DNS**
- Exemple : baisser temporairement le TTL avant de changer lâ€™IP dâ€™un domaine

==== ðŸ›‘ Attention

Le cache peut provoquer des **effets de bord** :
- Une entrÃ©e erronÃ©e peut persister plusieurs minutes/heures
- NÃ©cessitÃ© de forcer un vidage (`flush`) pour tester des mises Ã  jour

== Reverse Name Resolution

La rÃ©solution DNS inverse consiste Ã  retrouver un nom de domaine associÃ© Ã  une adresse IP. Elle repose sur lâ€™utilisation dâ€™un enregistrement PTR dans une zone spÃ©ciale : in-addr.arpa (IPv4) ou ip6.arpa (IPv6).

=== ðŸ”¹ Transformation d'adresse

Pour interroger le DNS Ã  partir dâ€™une adresse IP, on **inverse les octets** de lâ€™adresse, puis on la suffixe avec `in-addr.arpa`.

Exemple :

----
Adresse IP : 172.217.18.14
â†’ Nom DNS : 14.18.217.172.in-addr.arpa.
----

Ce nom devient la **clÃ© de requÃªte DNS** (QNAME) utilisÃ©e pour effectuer une rÃ©solution de type `PTR`.

=== ðŸ”¹ Exemple de requÃªte DNS

[source,dns]
----
QNAME = 14.18.217.172.in-addr.arpa.
QTYPE = PTR
----

=== ðŸ”¹ Ã‰tapes de rÃ©solution (hiÃ©rarchique)

La rÃ©solution suit le mÃªme modÃ¨le que la rÃ©solution directe, mais dans le domaine inversÃ© `in-addr.arpa.` :

. Le rÃ©solveur interroge la **racine DNS (`.`)** :
+
[source,dns]
----
QNAME = 14.18.217.172.in-addr.arpa.
â†’ RÃ©ponse : "NS pour arpa."
----

. Il interroge les **serveurs de la zone `arpa.`** :
+
[source,dns]
----
â†’ RÃ©ponse : "NS pour in-addr.arpa."
----

. Puis les **serveurs de `in-addr.arpa.`** :
+
[source,dns]
----
â†’ RÃ©ponse : "NS pour 172.in-addr.arpa."
----

. Et ainsi de suite jusquâ€™Ã  trouver un serveur **autoritaire pour 217.172.in-addr.arpa** ou une zone plus spÃ©cifique :
+
[source,dns]
----
â†’ RÃ©ponse : "NS pour 18.217.172.in-addr.arpa."
----

. Enfin, le serveur autoritaire pour cette zone retourne un enregistrement `PTR`.

=== ðŸ”¹ Exemple de fichier de zone

[source,dns]
----
$TTL 86400
@ IN SOA ns1.revdns.example. admin.example.com. (
    2025062701 ; Serial
    3600       ; Refresh
    1800       ; Retry
    604800     ; Expire
    86400 )    ; Minimum TTL

@ IN NS ns1.revdns.example.

14.18.217.172.in-addr.arpa. IN PTR host.example.com.
----

Cet enregistrement signifie que l'adresse IP `172.217.18.14` correspond au nom dâ€™hÃ´te `host.example.com.`.

=== ðŸ”¹ Visualisation de la hiÃ©rarchie

[plantuml, reverse-dns-hierarchy, png]
----
title "HiÃ©rarchie de rÃ©solution DNS inverse (in-addr.arpa)"
left to right direction
rectangle "arpa" as arpa
rectangle "in-addr" as inaddr
rectangle "172" as o1
rectangle "217" as o2
rectangle "18" as o3
rectangle "14" as o4

arpa --> inaddr
inaddr --> o1
o1 --> o2
o2 --> o3
o3 --> o4
----

=== ðŸ”¹ Cas dâ€™usage

* Diagnostic et audit rÃ©seau (reverse DNS dans les logs)
* Filtrage des emails (reverse DNS obligatoire pour Ã©viter le spam)
* Certains pare-feu et systÃ¨mes de sÃ©curitÃ©

=== ðŸ”¹ Outils de vÃ©rification

* **Windows** : `ping -a 172.217.18.14`
* **Linux** : `dig -x 172.217.18.14 +noall +answer`
* **Web** : https://mxtoolbox.com/ReverseLookup.aspx

=== ðŸ“ Remarques

* Tous les serveurs DNS **nâ€™autorisent pas** ou **ne configurent pas** dâ€™enregistrements PTR â†’ la rÃ©solution inverse peut Ã©chouer sans erreur DNS.
* La zone `in-addr.arpa.` est souvent **dÃ©lÃ©guÃ©e aux opÃ©rateurs rÃ©seau** (FAI, hÃ©bergeurs, etc.), qui seuls peuvent configurer les enregistrements PTR.

== Enregistrement des noms de domaine

=== Acteurs clÃ©s

[.text-center]
[plantuml, domain-registration, png]
----
title "ChaÃ®ne d'enregistrement dâ€™un domaine"
top to bottom direction
[ICANN] --> [Registrars]
[Registrars] --> [Resellers]
[Resellers] --> [Registrants]
----
*Acteurs clÃ©s* :
* **ICANN** : supervise la racine DNS, accrÃ©dite les registrars
* **Registrars** (ex : Gandi, OVH, Amazon) : vendent les noms de domaine
* **Resellers** : revendeurs sâ€™appuyant sur lâ€™API dâ€™un registrar
* **Registrants** : propriÃ©taires finaux du domaine

=== ðŸ”¹ Processus dâ€™enregistrement

. **Choix du TLD** (â‰ˆ 1 500 disponibles) â€” critÃ¨res :
* Support **DNSSEC**
* Support **IDN** (caractÃ¨res UTF-8 accentuÃ©s)
* Restrictions gÃ©ographiques / lÃ©gales (ex : `.ca`, `.bank`)
. **VÃ©rification de disponibilitÃ©** (WHOIS/RDAP ou portail du registrar)
. **Protection anti-typosquatting**
* *Typosquatting* : enregistrement de variantes typographiques malveillantes
* **dnstwist** : outil CLI pour lister et surveiller les homographes. Jeter un coup d'oeil pour ne pas Ãªtre lÃ©sÃ© plus tard. (Outils python installable avec pip)
. **Validation & paiement** : le registrar effectue la crÃ©ation via le protocole **EPP** (Extensible Provisioning Protocol).

=== ðŸ”¹ Codes EPP (statuts de domaine)

|===
| Code | Effet & explication
|------|---------------------
| `clientHold` | **Suspend** lâ€™activation : le domaine ne se rÃ©sout plus tant que le registrant ne lÃ¨ve pas le statut.
| `serverHold` | Suspension imposÃ©e par le **registre** (litige, non-paiement, dÃ©cision judiciaire).
| `clientTransferProhibited` | Blocage volontaire des **transferts sortants** â€” protection contre le vol de domaine.
| `serverTransferProhibited` | Blocage de transfert imposÃ© par le registre (procÃ©dure UDRP, etc.).
|===

*VÃ©rification en ligne* : https://lookup.icann.org/

=== Stockage des donnÃ©es DNS : zones & enregistrements

[.text-center]
[plantuml, dns-record-structure, png]
----
title "Structure interne dâ€™un Resource Record"
frame "Resource Record" {
component "Name (Ã©tiquette)" as N
component "Type (A, MX, NSâ€¦)" as Ty
component "Class (IN)" as Cl
component "TTL (durÃ©e de cache)" as T
component "RDLENGTH (taille)" as L
component "RDATA (donnÃ©es)" as D
}
----

*LÃ©gende* :

* **Name** : domaine ou `@` pour la racine de la zone
* **Type** : nature du record (`A`, `AAAA`, `MX`, `PTR`, `SOA`, etc.)
* **Class** : presque toujours `IN` (*Internet*)
* **TTL** : durÃ©e (en s) avant expiration du cache
* **RDLENGTH / RDATA** : taille et contenu effectif (IP, nom, clÃ©, texteâ€¦)

==== ðŸ”¹ Types de zones

| Type de zone | FinalitÃ© | Exemple concret |
|--------------|----------|-----------------|
| **Forward**  | Nom â†’ IP (rÃ©solution classique) | `www.example.com` âžœ `192.0.2.1` |
| **Reverse**  | IP â†’ Nom (`in-addr.arpa`, `ip6.arpa`) | `192.0.2.1` âžœ `host.example.com` |
| **Secondary / Slave** | Copie complÃ¨te dâ€™une zone, mise Ã  jour par `AXFR/IXFR` | Haute dispo chez plusieurs NS |
| **Stub**     | Contient **uniquement** les enregistrements `NS` dâ€™une zone distante | Optimise les requÃªtes internes |

==== ðŸ”¹ Enregistrement SOA (Start of Authority)

[source,dns]
----
example.com. 3600 IN SOA ns1.example.com. admin.example.com. (
  2023062501 ; Serial (version de zone)
  86400      ; Refresh (toutes les 24 h)
  7200       ; Retry   (toutes les 2 h en cas dâ€™Ã©chec)
  3600000    ; Expire  (40 j avant abandon)
  172800     ; NX TTL  (cache nÃ©gatif 48 h)
)
----

* **Serial** : doit Ãªtre incrÃ©mentÃ© Ã  chaque modification de zone.
* **Refresh/Retry/Expire** : rythment la synchronisation avec les serveurs secondaires.
* **NX TTL** : temps de cache des rÃ©ponses **NXDOMAIN**.

