:source-highlighter: rouge
:hardbreaks:
:table-caption!:

= iptables

__last update: 12/01/2023__

.liste des commandes iptables
[source, bash]
----
iptables -N NEW_CHAIN # créer une chaine
iptables -X NEW_CHAIN # supprimer une chaine
iptables -X # Supprime toutes les custom chains
iptables -F INPUT # flash toutes les règles de input, plus de règles
iptables -S # Liste les règles en format ligne de commande
iptables -Z INPUT 1 # Flasher la mémoire des paquets de la règle 1
iptables -E OLD_NAME NEW_NAME  # renomme une chaine
iptables -t nat -L # Voir la liste des règles dans la table NAT (affiche toutes les chaines)
iptables -L # Voir toutes les règles par chaine
iptables -L --line-numbers # Affiche en plus le number des règles

iptables -L INPUT # Voir toutes les règles pour la chaine INPUT
 -v  # Voir le détail des paquets qui ont atteint cette règle

----

[source, bash]
/etc/services # Fichier ou sont configurés la liste des services et leurs ports

[source, bash]
----
#Les paquets passent par une succession de Chain

PREROUTING
INPUT
OUTPUT
FORWARD
POSTROUTING

# Chaque chaine contient plusieurs tables communes en partie aux différentes chaines

RAW # Traite les paquets avant que le traçage de la connexion soit établie
MANGLE # Utilisé pour changer des données des paquets comme le TTL
NAT # Network Adress Translation
FILTER # Filtre les paquets

# Dans un ordre à peut cohérent cela donne
PREROUTING
  RAW
  MANGLE
  NAT

INPUT OU FORWARD
 FILTER
 MANGLE

OUTPUT SI INPUT
 RAW
 OUTPUT
 NAT
 FILTER

POSTROUTING
 MANGLE
 NAT
----

.pattern global
[source, bash]
IPTABLE_RULE = TABLE + CHAIN + MATCH + TARGET

[source, bash]
----
# drop les paquets depuis 10.10.0.0 pour la chaine FORWARD dans la table filter
iptables -t filter -A FORWARD -s 10.10.10.0 -j DROP

# place notre nouvelle chaine à la suite de la chaine INPUT pour les paquets sur le port 80 en tcp
iptables -A INPUT -p tcp --dport 80 -j NEW_CHAINE

# Supprime la règle en question
iptables -D INPUT -p tctp --dport 80 -j NEW_CHAINE

# Supprimer avec le numéro de ligne
iptables -D INPUT <linenumber> iptables -D

# Remplacer une règle par une autre en utilisant son line number
iptables -R <linenumber> RULE

# Sette une politique DROP globale sur la chaine INPUT, utilise quand on veut ajouter d&#39;autres règles après
iptables -P INPUT DROP

# Insère une nouvelle règle (-I) pour la règle qui a le number 1
iptables -I INPUT 1 -p tcp --dport 5000 -j ACCEPT

iptables -A INPUT ! -s 192.168.1.0/24 -j DROP
# ! signifie que la règle du DROP est appliqué à tous les paquets à l'exception de ceux qui proviennent du réseau 192.168.1.0/24

# Créé une règle basée sur l'interface
iptables -A INPOUT -i <interface_name>

# Il autorise les connexions depuis le réseau 10.10.10.0 entre 10h et 16h les jours de semaine
# (DROP entre 16 #00 et 10 #00)
iptables -I FORWARD -s 10.10.10.0/24 -m time --timestart 16:00 --timestop 10:00 --weekdays Fri,Mon -j DROP

# Répondre à un ping par une réponse de type echo request de type 3, jost unreachable
iptables -t mangle -A PREROUTING -j TTL --ttl-inc 1
iptables -R INPUT 1 -p icmp -j REJECT --reject-with icmp-host-unreachable

# hping3 envoie que l'on veut en quantité que l&#39;on veut, il permets de trouver la configuration d&#39;un réseau
# ici, on envoie des paquets icmp (-1), en quantité 100 de la part de la 10.10.10.5 à toutes les adresses
hping3 -1 -c 100 -a 10.10.10.5 255.255.255.255
iptables -A INPUT -p icmp -s 192.168.1.0/24 -m limit --limit 1/m -j ACCEPT
----

[source, bash]
----
# Autres infos intéressantes

# ttl par défaut en fonction des OS

windows 10  # ICMP / TCP / UDP  # 128
Ubuntu  # ICMP / TCP / UDP  # 64
MacOs # ICMP / TCP / UDP  # 64
Cisco  # ICMP  # 255

#conf ttl
cat /proc/sys/net/ipv4
  ip_default_ttl # on peut le passer à une autre valeur, lui la mets à 128 pour que ça soit standard

# hide sent n'affiche pas les paquets envoyés, on en a 1000
nping --hide-sent --no-capture --rate=1000 --source-ip 192.168.1.244 --dest-ip 192.168.1.22 --source-mac aa:bb:c:11:22:33 -c 1000

nping -A INPUT -p icmp -s 192.168.1.0/24 -j DROP # pour dropper le reste
----