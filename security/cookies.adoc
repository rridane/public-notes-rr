= Deep Dive â€“ Cookies HTTP
:author-url: https://github.com/rridane
:author: rridane
:source-highlighter: rouge
:hardbreaks:
:toc: left
:toclevels: 3
:numbered:

== ğŸª DÃ©finition

Un cookie HTTP est une *paire clÃ©/valeur* stockÃ©e par le navigateur pour un domaine donnÃ©. Il est automatiquement renvoyÃ© dans les futures requÃªtes HTTP, selon les contraintes de sÃ©curitÃ© dÃ©finies (`Path`, `Domain`, `Secure`, `SameSite`, etc.).

== ğŸ” Cycle de vie dâ€™un cookie

[plantuml]
----
@startuml
actor "Navigateur" as Browser
participant "Serveur" as Server

== Initialisation ==
Server -> Browser : Set-Cookie: session_id=abc123; Path=/; HttpOnly

== RequÃªtes suivantes ==
Browser -> Server : Cookie: session_id=abc123

note right of Server
Si :
- Domaine + Path correspondent
- Connexion HTTPS (si Secure)
- Contrainte SameSite OK
end note
@enduml
----

== âš™ï¸ Set-Cookie â€“ Structure

[source,http]
----
Set-Cookie: nom=valeur; Expires=...; Path=/; Domain=...; Secure; HttpOnly; SameSite=Strict
----

[cols="1,3",options="header"]
|===
|Attribut |Description

|`nom=valeur` | Paires clÃ©/valeur (UTF-8, 4096 bytes max)
|`Expires` ou `Max-Age` | Date dâ€™expiration (RFC 1123) ou TTL en secondes
|`Path` | PortÃ©e du cookie (ex: `/`, `/admin`)
|`Domain` | Domaine concernÃ© (ex: `.example.com`)
|`Secure` | EnvoyÃ© uniquement via HTTPS
|`HttpOnly` | Inaccessible par JavaScript (anti-XSS)
|`SameSite` | Politique intersite (`Lax`, `Strict`, `None`)
|===

== ğŸ“¥ Cookie â€“ RequÃªte du client

[source,http]
----
GET /dashboard HTTP/1.1
Host: example.com
Cookie: session_id=abc123; theme=dark
----

Le navigateur **renvoie automatiquement** les cookies valides en fonction du domaine, du path, et des rÃ¨gles de sÃ©curitÃ©.

== ğŸ§ª DÃ©mo complÃ¨te en `curl`

[source,bash]
----
# 1. Appel avec cookie fixÃ© par serveur
curl -c cookies.txt https://example.com/login

# 2. Appel avec cookie renvoyÃ©
curl -b cookies.txt https://example.com/dashboard
----

* `-c cookies.txt` = Ã©crit les cookies reÃ§us
* `-b cookies.txt` = renvoie les cookies enregistrÃ©s

== âš–ï¸ Gestion par le navigateur (cookie jar)

Le navigateur :

. reÃ§oit lâ€™en-tÃªte `Set-Cookie`
. stocke le cookie en local (cookie jar)
. applique les rÃ¨gles :
* date dâ€™expiration
* correspondance de domaine / path
* sÃ©curitÃ©s HTTPS
* politique SameSite
. renvoie les cookies automatiquement si les rÃ¨gles sont respectÃ©es

== ğŸŒ IndÃ©pendant du langage

Tous les serveurs Web peuvent envoyer un `Set-Cookie` en rÃ©ponse HTTP. Exemple dans diffÃ©rents langages :

[cols="1,2",options="header"]
|===
|Langage | Code

|PHP
|`setcookie("name", "value", [...]);`

|Node.js
|`res.setHeader('Set-Cookie', 'name=value; Path=/; HttpOnly');`

|Python (Flask)
|`response.set_cookie("name", "value", httponly=True)`

|Go
|`http.SetCookie(w, &http.Cookie{Name: "name", Value: "value"})`

|Java
|`response.addCookie(new Cookie("name", "value"));`
|===

== ğŸ” Attributs de sÃ©curitÃ©

=== Secure

- Transmet le cookie uniquement via HTTPS
- EmpÃªche les attaques MITM en clair

=== HttpOnly

- EmpÃªche lâ€™accÃ¨s via `document.cookie`
- ProtÃ¨ge contre les attaques XSS

=== SameSite

[cols="1,3",options="header"]
|===
|Valeur | Comportement

|`Strict` | Jamais envoyÃ© dans les requÃªtes intersites (meilleure sÃ©curitÃ© CSRF)
|`Lax` | EnvoyÃ© pour les requÃªtes GET (navigation normale)
|`None` | EnvoyÃ© dans tous les cas (nÃ©cessite `Secure`)
|===

== ğŸ” Exemple complet de cookie sÃ©curisÃ©

[source,http]
----
Set-Cookie: session_id=abc123;
  Max-Age=3600;
  Path=/;
  Domain=example.com;
  Secure;
  HttpOnly;
  SameSite=Strict
----

== ğŸ§  Fonctionnement sous le capot

1. `Set-Cookie` = **instruction du serveur au navigateur**
2. Navigateur = **machine Ã  appliquer des rÃ¨gles** :
